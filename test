@app.get("/test", response_class=HTMLResponse)
async def test_page():
    """Página de prueba mejorada"""
    html_content = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>LecFac - Test OCR</title>
        <style>
            body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
            .container { border: 2px solid #ddd; padding: 30px; border-radius: 10px; }
            .button { background: #007bff; color: white; padding: 10px 20px; border: none; 
                     border-radius: 5px; cursor: pointer; margin: 10px 0; }
            .result { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
            input[type="file"] { margin: 10px 0; }
            .success { background: #d4edda; color: #155724; }
            .error { background: #f8d7da; color: #721c24; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>LecFac - Test de OCR con Tesseract</h1>
            
            <div id="status" class="result">
                <h3>Estado del sistema:</h3>
                <p id="statusText">Cargando...</p>
            </div>
            
            <h2>Probar procesamiento de factura</h2>
            <form id="uploadForm">
                <input type="file" id="fileInput" accept="image/*" required>
                <button type="submit" class="button">Procesar Factura</button>
            </form>
            
            <div id="result" style="display:none;"></div>
        </div>

        <script>
            // Verificar estado del sistema
            fetch('/health')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('statusText').innerHTML = 
                        `Database: ${data.database_type} (${data.database})<br>
                         Status: ${data.status}`;
                });

            // Procesar factura
            document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('fileInput');
                const resultDiv = document.getElementById('result');
                
                if (!fileInput.files[0]) {
                    alert('Selecciona una imagen');
                    return;
                }
                
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.innerHTML = '⏳ Procesando con Tesseract OCR...';
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                try {
                    const response = await fetch('/invoices/parse', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <h3>✅ Factura procesada</h3>
                            <p><strong>Establecimiento:</strong> ${data.data.establecimiento}</p>
                            <p><strong>Total:</strong> $${data.data.total?.toLocaleString() || 'No detectado'}</p>
                            <p><strong>Productos detectados:</strong> ${data.data.productos.length}</p>
                            <p><strong>Método:</strong> ${data.data.metadatos?.metodo || 'N/A'}</p>
                            <h4>Primeros 5 productos:</h4>
                            <ul>
                                ${data.data.productos.slice(0, 5).map(p => 
                                    `<li><strong>${p.codigo || 'Sin código'}:</strong> ${p.nombre || 'Sin nombre'} - $${p.valor || 0}</li>`
                                ).join('')}
                            </ul>
                        `;
                    } else {
                        throw new Error(data.detail || 'Error desconocido');
                    }
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `❌ Error: ${error.message}`;
                }
            });
        </script>
    </body>
    </html>
    """
    return HTMLResponse(content=html_content)
