<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Duplicados - LecFac</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .navbar {
            background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-header {
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .navbar-actions {
            display: flex;
            gap: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        
        .btn-secondary {
            background: #f1f3f4;
            color: #5f6368;
        }
        
        .tabs {
            display: flex;
            gap: 0;
            background: #fff;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: -1px;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
            background: rgba(0, 0, 0, 0.02);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1a73e8;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-weight: 500;
            font-size: 14px;
        }
        
        .filter-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-header">
            <h1>Gestor de Duplicados - LecFac</h1>
            <div class="navbar-actions">
                <a href="/admin" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('productos')">Productos Duplicados</button>
            <button class="tab" onclick="switchTab('facturas')">Facturas Duplicadas</button>
        </div>

        <!-- TAB: PRODUCTOS DUPLICADOS -->
        <div id="tab-productos" class="tab-content active">
            <div class="toolbar">
                <div class="filters">
                    <div class="filter-group">
                        <span class="filter-label">Umbral de Similitud:</span>
                        <select id="umbralSimilitud" class="filter-select">
                            <option value="90">Muy Alta (90%+)</option>
                            <option value="85" selected>Alta (85%+)</option>
                            <option value="75">Media (75%+)</option>
                            <option value="65">Baja (65%+)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Criterios:</span>
                        <select id="criteriosProductos" class="filter-select">
                            <option value="todos" selected>Todos los criterios</option>
                            <option value="codigo">Mismo c√≥digo</option>
                            <option value="nombre">Nombre similar</option>
                            <option value="establecimiento">Mismo establecimiento</option>
                        </select>
                    </div>
                </div>

                <div>
                    <button class="btn btn-primary" onclick="detectarProductosDuplicados()">
                        <span>üîç Detectar Duplicados</span>
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarAyuda('productos')">
                        <span>‚ùì Ayuda</span>
                    </button>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div class="label">Productos Totales</div>
                    <div class="value" id="total-productos">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Duplicados Encontrados</div>
                    <div class="value" id="total-duplicados">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Porcentaje</div>
                    <div class="value" id="porcentaje-duplicados">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Fusiones Realizadas</div>
                    <div class="value" id="total-fusiones">0</div>
                </div>
            </div>

            <div id="productos-duplicados-container">
                <div class="empty-state">
                    <h3>Haz clic en "Detectar Duplicados" para comenzar</h3>
                    <p>El sistema analizar√° productos similares seg√∫n los criterios seleccionados</p>
                </div>
            </div>
        </div>

        <!-- TAB: FACTURAS DUPLICADAS -->
        <div id="tab-facturas" class="tab-content">
            <div class="toolbar">
                <div class="filters">
                    <div class="filter-group">
                        <span class="filter-label">Criterio Principal:</span>
                        <select id="criterioFacturas" class="filter-select">
                            <option value="all" selected>Todos los criterios</option>
                            <option value="same_establishment">Mismo establecimiento</option>
                            <option value="same_date">Misma fecha</option>
                            <option value="same_total">Mismo total</option>
                            <option value="same_products">Productos similares</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Ver im√°genes:</span>
                        <input type="checkbox" id="mostrarImagenes" checked>
                    </div>
                </div>

                <div>
                    <button class="btn btn-primary" onclick="detectarFacturasDuplicadas()">
                        <span>üîç Detectar Duplicados</span>
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarAyuda('facturas')">
                        <span>‚ùì Ayuda</span>
                    </button>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div class="label">Facturas Totales</div>
                    <div class="value" id="total-facturas">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Duplicados Encontrados</div>
                    <div class="value" id="total-facturas-duplicadas">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Porcentaje</div>
                    <div class="value" id="porcentaje-facturas-duplicadas">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Eliminaciones</div>
                    <div class="value" id="total-eliminaciones">0</div>
                </div>
            </div>

            <div id="facturas-duplicadas-container">
                <div class="empty-state">
                    <h3>Haz clic en "Detectar Duplicados" para comenzar</h3>
                    <p>El sistema analizar√° facturas similares seg√∫n los criterios seleccionados</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n global
        const API_URL = 'https://lecfac-api.onrender.com';
        let productosDuplicados = [];
        let facturasDuplicadas = [];
        let totalFusiones = 0;
        let totalEliminaciones = 0;
        
        // Modo demo para desarrollo
        const MODO_DEMO = true;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstadisticas();
        });

        // Funci√≥n para cambiar pesta√±as
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'productos') {
                // Cargar productos duplicados
                detectarProductosDuplicados();
            } else if (tabName === 'facturas') {
                // Cargar facturas duplicadas
                detectarFacturasDuplicadas();
            }
        }

        // Cargar estad√≠sticas
        function cargarEstadisticas() {
            if (MODO_DEMO) {
                // Datos demo
                document.getElementById('total-productos').textContent = '358';
                document.getElementById('total-facturas').textContent = '124';
                return;
            }
            
            // Aqu√≠ ir√≠a el c√≥digo real para cargar estad√≠sticas desde la API
            fetch(`${API_URL}/admin/stats`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-productos').textContent = data.productos_unicos || 0;
                    document.getElementById('total-facturas').textContent = data.total_facturas || 0;
                })
                .catch(error => {
                    console.error('Error cargando estad√≠sticas:', error);
                    // Valores por defecto
                    document.getElementById('total-productos').textContent = '?';
                    document.getElementById('total-facturas').textContent = '?';
                });
        }
        
        // Detectar productos duplicados
        function detectarProductosDuplicados() {
            const container = document.getElementById('productos-duplicados-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Analizando duplicados de productos...</div>';
            
            if (MODO_DEMO) {
                // Simulaci√≥n de carga
                setTimeout(() => {
                    document.getElementById('total-duplicados').textContent = '7';
                    document.getElementById('porcentaje-duplicados').textContent = '2.0%';
                    
                    container.innerHTML = `
                        <div class="card">
                            <div style="padding: 20px; text-align: center;">
                                <h3>Modo demostraci√≥n</h3>
                                <p>Se encontraron 7 posibles productos duplicados.</p>
                                <p style="margin-top: 15px;">En la implementaci√≥n real, aqu√≠ se mostrar√≠an los productos duplicados con opciones para fusionarlos.</p>
                            </div>
                        </div>
                    `;
                }, 1000);
                return;
            }
            
            // Aqu√≠ ir√≠a el c√≥digo real para detectar duplicados desde la API
            const umbral = document.getElementById('umbralSimilitud').value;
            const criterio = document.getElementById('criteriosProductos').value;
            
            fetch(`${API_URL}/admin/duplicados/productos?umbral=${umbral}&criterio=${criterio}`)
                .then(response => response.json())
                .then(data => {
                    productosDuplicados = data.duplicados || [];
                    
                    // Actualizar estad√≠sticas
                    document.getElementById('total-duplicados').textContent = data.total || 0;
                    const porcentaje = data.total > 0 ? 
                        ((data.total / parseInt(document.getElementById('total-productos').textContent)) * 100).toFixed(1) + '%' : 
                        '0%';
                    document.getElementById('porcentaje-duplicados').textContent = porcentaje;
                    
                    if (productosDuplicados.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <h3>No se encontraron productos duplicados</h3>
                                <p>Prueba con un umbral de similitud m√°s bajo o diferentes criterios</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Aqu√≠ ir√≠a el c√≥digo para mostrar los productos duplicados
                })
                .catch(error => {
                    console.error('Error detectando duplicados de productos:', error);
                    container.innerHTML = `
                        <div style="padding: 20px; background: #ffebee; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #c62828; margin-bottom: 10px;">Error al buscar duplicados</h3>
                            <p>${error.message || 'Error desconocido'}</p>
                        </div>
                    `;
                });
        }
        
        // Detectar facturas duplicadas
        function detectarFacturasDuplicadas() {
            const container = document.getElementById('facturas-duplicadas-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Analizando duplicados de facturas...</div>';
            
            if (MODO_DEMO) {
                // Simulaci√≥n de carga
                setTimeout(() => {
                    document.getElementById('total-facturas-duplicadas').textContent = '6';
                    document.getElementById('porcentaje-facturas-duplicadas').textContent = '4.8%';
                    
                    container.innerHTML = `
                        <div class="card">
                            <div style="padding: 20px; text-align: center;">
                                <h3>Modo demostraci√≥n</h3>
                                <p>Se encontraron 6 posibles facturas duplicadas.</p>
                                <p style="margin-top: 15px;">En la implementaci√≥n real, aqu√≠ se mostrar√≠an las facturas duplicadas con sus im√°genes y opciones para eliminar las redundantes.</p>
                            </div>
                        </div>
                    `;
                }, 1000);
                return;
            }
            
            // Aqu√≠ ir√≠a el c√≥digo real para detectar facturas duplicadas desde la API
            const criterio = document.getElementById('criterioFacturas').value;
            
            fetch(`${API_URL}/admin/duplicados/facturas?criterio=${criterio}`)
                .then(response => response.json())
                .then(data => {
                    facturasDuplicadas = data.duplicados || [];
                    
                    // Actualizar estad√≠sticas
                    document.getElementById('total-facturas-duplicadas').textContent = data.total || 0;
                    const porcentaje = data.total > 0 ? 
                        ((data.total / parseInt(document.getElementById('total-facturas').textContent)) * 100).toFixed(1) + '%' : 
                        '0%';
                    document.getElementById('porcentaje-facturas-duplicadas').textContent = porcentaje;
                    
                    if (facturasDuplicadas.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <h3>No se encontraron facturas duplicadas</h3>
                                <p>Prueba con diferentes criterios de b√∫squeda</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Aqu√≠ ir√≠a el c√≥digo para mostrar las facturas duplicadas
                })
                .catch(error => {
                    console.error('Error detectando duplicados de facturas:', error);
                    container.innerHTML = `
                        <div style="padding: 20px; background: #ffebee; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #c62828; margin-bottom: 10px;">Error al buscar duplicados</h3>
                            <p>${error.message || 'Error desconocido'}</p>
                        </div>
                    `;
                });
        }
        
        // Mostrar ayuda
        function mostrarAyuda(tipo) {
            if (tipo === 'productos') {
                alert("Ayuda para productos duplicados:\n\n" +
                      "- Mismo c√≥digo + mismo establecimiento: Si dos productos tienen el mismo c√≥digo EAN y est√°n en el mismo establecimiento, se consideran duplicados.\n\n" +
                      "- Nombres similares + mismo establecimiento: Si dos productos tienen nombres muy parecidos y est√°n en el mismo establecimiento, pueden ser duplicados.\n\n" +
                      "- Productos con el mismo c√≥digo pero en diferentes establecimientos NO son duplicados, ya que pueden tener precios distintos seg√∫n la ubicaci√≥n.");
            } else {
                alert("Ayuda para facturas duplicadas:\n\n" +
                      "- Misma fecha + mismo establecimiento + mismo total: Alta probabilidad de ser la misma factura cargada dos veces.\n\n" +
                      "- Misma fecha + mismo establecimiento + productos similares: Posiblemente la misma factura con algunas diferencias en la captura.\n\n" +
                      "- Para verificar si son realmente duplicados, revisa las im√°genes de las facturas.");
            }
        }
    </script>
</body>
</html>
