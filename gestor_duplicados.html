<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Duplicados - LecFac</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .navbar {
            background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-header {
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .navbar-actions {
            display: flex;
            gap: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1557b0;
        }
        
        .btn-secondary {
            background: #f1f3f4;
            color: #5f6368;
        }
        
        .btn-secondary:hover {
            background: #e8eaed;
        }
        
        .btn-danger {
            background: #ea4335;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d93025;
        }
        
        .btn-success {
            background: #34a853;
            color: white;
        }
        
        .btn-success:hover {
            background: #2d9148;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .tabs {
            display: flex;
            gap: 0;
            background: #fff;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: -1px;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(0, 0, 0, 0.03);
            color: #333;
        }
        
        .tab.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
            background: rgba(0, 0, 0, 0.02);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1a73e8;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-weight: 500;
            font-size: 14px;
        }
        
        .filter-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .duplicate-container {
            margin-top: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .duplicate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f5f7fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .duplicate-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        
        .duplicate-item {
            padding: 20px;
            position: relative;
        }
        
        .duplicate-item:first-child {
            border-right: 2px solid #e0e0e0;
        }
        
        .duplicate-metadata {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .duplicate-image {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .duplicate-image img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .product-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .product-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .product-item.identical {
            background: #e8f5e9;
            border-left: 3px solid #34a853;
        }
        
        .product-item.different {
            background: #fff3e0;
            border-left: 3px solid #f57c00;
        }
        
        .product-item h4 {
            margin-bottom: 5px;
        }
        
        .product-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
        }
        
        .selection-mark {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .selected {
            background: #34a853;
        }
        
        .not-selected {
            background: #ea4335;
        }
        
        .select-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .similarity-tag {
            display: inline-block;
            padding: 4px 10px;
            font-weight: 500;
            font-size: 14px;
            border-radius: 12px;
        }
        
        .similarity-high {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .similarity-medium {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .similarity-low {
            background: #ffebee;
            color: #c62828;
        }
        
        .criteria-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 12px;
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #34a853;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideInRight 0.3s, fadeOut 0.5s 2.5s forwards;
            max-width: 350px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #1a73e8;
        }
        
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #1a73e8;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* AI settings section */
        .ai-settings {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .ai-settings h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #1a73e8;
        }

        .ai-settings .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 15px 0;
        }

        .ai-settings .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .batch-actions {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .batch-actions h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .batch-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            background: #f5f7fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .confidence-meter {
            height: 8px;
            width: 100%;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
            position: relative;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9800 0%, #4caf50 100%);
            border-radius: 4px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }
        
        .pagination-item {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .pagination-item:hover {
            background: #f1f3f4;
        }
        
        .pagination-item.active {
            background: #1a73e8;
            color: white;
        }
    </style>

   
</head>
<body>
    <nav class="navbar">
        <div class="navbar-header">
            <h1>Gestor de Duplicados - LecFac</h1>
            <div class="navbar-actions">
                <a href="/" class="btn btn-secondary">← Volver al Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('productos')">Productos Duplicados</button>
            <button class="tab" onclick="switchTab('facturas')">Facturas Duplicadas</button>
            <button class="tab" onclick="switchTab('configuracion')">Configuración IA</button>
        </div>

        <!-- TAB: PRODUCTOS DUPLICADOS -->
        <div id="tab-productos" class="tab-content active">
            <div class="toolbar">
                <div class="filters">
                    <div class="filter-group">
                        <span class="filter-label">Umbral de Similitud:</span>
                        <select id="umbralSimilitud" class="filter-select" onchange="detectarProductosDuplicados()">
                            <option value="90">Muy Alta (90%+)</option>
                            <option value="85" selected>Alta (85%+)</option>
                            <option value="75">Media (75%+)</option>
                            <option value="65">Baja (65%+)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Criterios:</span>
                        <select id="criteriosProductos" class="filter-select" onchange="detectarProductosDuplicados()">
                            <option value="todos" selected>Todos los criterios</option>
                            <option value="codigo">Mismo código</option>
                            <option value="nombre">Nombre similar</option>
                            <option value="establecimiento">Mismo establecimiento</option>
                        </select>
                    </div>
                </div>

                <div>
                    <button class="btn btn-primary" onclick="detectarProductosDuplicados()">
                        <span>🔍 Detectar Duplicados</span>
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarAyudaProductos()">
                        <span>❓ Ayuda</span>
                    </button>
                </div>
            </div>

            <div class="batch-actions" id="productos-ia-panel">
                <h3>Procesamiento con Inteligencia Artificial</h3>
                <p>Usa IA para analizar y procesar automáticamente los duplicados detectados.</p>
                
                <div class="filter-group" style="margin-top: 10px;">
                    <span class="filter-label">Nivel de confianza mínimo:</span>
                    <select id="confianzaProductos" class="filter-select">
                        <option value="90">Muy Alto (90%+)</option>
                        <option value="85" selected>Alto (85%+)</option>
                        <option value="75">Medio (75%+)</option>
                    </select>
                </div>
                
                <div class="batch-status" id="productos-batch-status" style="display: none;">
                    <div>
                        <p>Progreso: <span id="productos-progreso">0/0</span></p>
                        <div class="confidence-meter">
                            <div class="confidence-fill" id="productos-progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="cancelarProcesamientoIA('productos')">Cancelar</button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="procesarDuplicadosIA('productos')">Procesar con IA</button>
                    <button class="btn btn-primary" onclick="guardarResultadosIA('productos')">Guardar Resultados</button>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div class="label">Productos Totales</div>
                    <div class="value" id="total-productos">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Duplicados Encontrados</div>
                    <div class="value" id="total-duplicados">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Procesados por IA</div>
                    <div class="value" id="productos-procesados-ia">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Fusiones Realizadas</div>
                    <div class="value" id="total-fusiones">0</div>
                </div>
            </div>

            <div id="productos-duplicados-container">
                <div class="empty-state">
                    <h3>Haz clic en "Detectar Duplicados" para comenzar</h3>
                    <p>El sistema analizará productos similares según los criterios seleccionados</p>
                </div>
            </div>

            <div class="pagination" id="productos-pagination">
                <!-- Paginación se genera dinámicamente -->
            </div>
        </div>

        <!-- TAB: FACTURAS DUPLICADAS -->
        <div id="tab-facturas" class="tab-content">
            <div class="toolbar">
                <div class="filters">
                    <div class="filter-group">
                        <span class="filter-label">Criterio Principal:</span>
                        <select id="criterioFacturas" class="filter-select" onchange="detectarFacturasDuplicadas()">
                            <option value="all" selected>Todos los criterios</option>
                            <option value="same_establishment">Mismo establecimiento</option>
                            <option value="same_date">Misma fecha</option>
                            <option value="same_total">Mismo total</option>
                            <option value="same_products">Productos similares</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Ver imágenes:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="mostrarImagenes" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div>
                    <button class="btn btn-primary" onclick="detectarFacturasDuplicadas()">
                        <span>🔍 Detectar Duplicados</span>
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarAyudaFacturas()">
                        <span>❓ Ayuda</span>
                    </button>
                </div>
            </div>

            <div class="batch-actions" id="facturas-ia-panel">
                <h3>Procesamiento con Inteligencia Artificial</h3>
                <p>Usa IA para analizar y procesar automáticamente las facturas duplicadas.</p>
                
                <div class="filter-group" style="margin-top: 10px;">
                    <span class="filter-label">Nivel de confianza mínimo:</span>
                    <select id="confianzaFacturas" class="filter-select">
                        <option value="90">Muy Alto (90%+)</option>
                        <option value="85" selected>Alto (85%+)</option>
                        <option value="75">Medio (75%+)</option>
                    </select>
                </div>
                
                <div class="batch-status" id="facturas-batch-status" style="display: none;">
                    <div>
                        <p>Progreso: <span id="facturas-progreso">0/0</span></p>
                        <div class="confidence-meter">
                            <div class="confidence-fill" id="facturas-progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="cancelarProcesamientoIA('facturas')">Cancelar</button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="procesarDuplicadosIA('facturas')">Procesar con IA</button>
                    <button class="btn btn-primary" onclick="guardarResultadosIA('facturas')">Guardar Resultados</button>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div class="label">Facturas Totales</div>
                    <div class="value" id="total-facturas">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Duplicados Encontrados</div>
                    <div class="value" id="total-facturas-duplicadas">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Procesados por IA</div>
                    <div class="value" id="facturas-procesadas-ia">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Eliminaciones</div>
                    <div class="value" id="total-eliminaciones">0</div>
                </div>
            </div>

            <div id="facturas-duplicadas-container">
                <div class="empty-state">
                    <h3>Haz clic en "Detectar Duplicados" para comenzar</h3>
                    <p>El sistema analizará facturas similares según los criterios seleccionados</p>
                </div>
            </div>

            <div class="pagination" id="facturas-pagination">
                <!-- Paginación se genera dinámicamente -->
            </div>
        </div>

        <!-- TAB: CONFIGURACIÓN IA -->
        <div id="tab-configuracion" class="tab-content">
            <div class="ai-settings">
                <h3>Configuración de la Inteligencia Artificial</h3>
                
                <div class="filter-group" style="margin-top: 15px;">
                    <span class="filter-label">API Key Anthropic:</span>
                    <input type="password" id="apiKey" class="filter-select" style="width: 350px;" 
       value="${process.env.ANTHROPIC_API_KEY1 || ''}">
                </div>

                <div class="filter-group" style="margin-top: 15px;">
                    <span class="filter-label">Modelo:</span>
                    <select id="modeloIA" class="filter-select">
                        <option value="claude-3-haiku-20240307" selected>Claude 3 Haiku (rápido y económico)</option>
                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet (balanceado)</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus (máxima precisión)</option>
                    </select>
                </div>
                
                <div class="divider"></div>

                <h3>Criterios de Fusión para Productos</h3>
                <div class="filter-group">
                    <textarea id="criteriosProductosIA" class="filter-select" style="width: 100%; height: 120px; resize: vertical;">
1. Si dos productos tienen el mismo código EAN y están en el mismo establecimiento, son duplicados.
2. Si dos productos tienen nombres muy similares (>85% similitud) y están en el mismo establecimiento, son duplicados.
3. Si los productos tienen la misma marca, mismo tamaño pero descritos de forma diferente, son duplicados.
4. Para productos sin código EAN, evaluar si las descripciones se refieren al mismo producto con diferente formato.
5. El producto con información más completa y actualizada debe ser conservado.
6. En caso de duda, conservar el producto que tiene precio más actualizado o veces visto más alto.
7. Considerar variaciones de formato como "500g" vs "1/2 kg" como el mismo producto.
                    </textarea>
                </div>
                
                <div class="divider"></div>

                <h3>Criterios de Eliminación para Facturas</h3>
                <div class="filter-group">
                    <textarea id="criteriosFacturasIA" class="filter-select" style="width: 100%; height: 120px; resize: vertical;">
1. Si dos facturas tienen la misma fecha, mismo establecimiento y mismo total, son duplicadas.
2. Si dos facturas tienen la misma fecha, mismo establecimiento y productos idénticos o muy similares, son duplicadas.
3. Si dos facturas del mismo establecimiento tienen el mismo número de referencia, son duplicadas.
4. Para facturas con imagen, la imagen debe ser revisada para confirmar que es la misma factura.
5. En caso de duplicados, conservar la factura con imagen sobre la que no tiene imagen.
6. Si ambas tienen imagen, conservar la factura con mejor calidad de imagen o con procesamiento más completo.
7. Si difieren ligeramente en productos, la factura más completa debe ser conservada.
                    </textarea>
                </div>
                
                <div class="filter-group" style="margin-top: 15px;">
                    <span class="filter-label">Tamaño de lote para procesamiento:</span>
                    <select id="tamanoLote" class="filter-select">
                        <option value="5">5 por lote</option>
                        <option value="10" selected>10 por lote</option>
                        <option value="25">25 por lote</option>
                        <option value="50">50 por lote</option>
                    </select>
                </div>
                
                <div class="filter-group" style="margin-top: 15px;">
                    <span class="filter-label">Intervalo de procesamiento (segundos):</span>
                    <input type="number" id="intervaloLote" class="filter-select" value="5" min="1" max="60">
                </div>
                
                <button class="btn btn-primary" onclick="guardarConfiguracionIA()" style="margin-top: 20px;">
                    Guardar Configuración
                </button>
            </div>
        </div>
    </div>

    <!-- POPUP: AYUDA PRODUCTOS -->
    <div id="popup-ayuda-productos" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5); z-index: 1000; padding: 20px;">
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 100%; max-width: 800px; max-height: 90vh; overflow: auto; position: relative;">
            <div style="position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; background: #f1f3f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="cerrarPopup('popup-ayuda-productos')">✕</div>
            <h2 style="margin-bottom: 20px;">Ayuda: Detección de Productos Duplicados</h2>
            
            <p style="margin-bottom: 15px;">El sistema utiliza los siguientes criterios para detectar productos duplicados:</p>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Criterios para considerar duplicados:</h3>
                <ul style="list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #1a73e8;">✓</span>
                        <strong>Mismo código + mismo establecimiento:</strong> Si dos productos tienen el mismo código EAN y están en el mismo establecimiento, se consideran duplicados.
                    </li>
                    <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #1a73e8;">✓</span>
                        <strong>Similitud en nombre + mismo establecimiento:</strong> Si dos productos tienen nombres muy similares y están en el mismo establecimiento, pueden ser duplicados aunque sus códigos sean diferentes.
                    </li>
                    <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #ea4335;">✗</span>
                        <strong>No son duplicados:</strong> Productos con el mismo código pero en diferentes establecimientos, ya que pueden tener precios diferentes según la ubicación.
                    </li>
                </ul>
            </div>
            
            <h3 style="margin-bottom: 15px;">Proceso de fusión:</h3>
            <ol style="padding-left: 20px; margin-bottom: 20px;">
                <li style="margin-bottom: 10px;">Revisa las diferencias entre los productos duplicados.</li>
                <li style="margin-bottom: 10px;">Selecciona el producto que contiene la información más precisa o completa.</li>
                <li style="margin-bottom: 10px;">Al fusionar, los historiales de precios se combinan, manteniendo todos los registros.</li>
                <li style="margin-bottom: 10px;">Si hay valores diferentes para el mismo día, se prioriza el valor más reciente.</li>
            </ol>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: #1976d2;">Consejos para obtener mejores resultados:</h4>
                <ul style="list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #1976d2;">•</span>
                        Ajusta el umbral de similitud según tus necesidades: más alto para mayor precisión, más bajo para encontrar más posibles duplicados.
                    </li>
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #1976d2;">•</span>
                        Comienza revisando los duplicados con coincidencia exacta de código antes de pasar a los basados en similitud de nombre.
                    </li>
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #1976d2;">•</span>
                        Mantén consistentes los nombres de establecimientos para evitar falsos duplicados.
                    </li>
                </ul>
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: #2e7d32;">Procesamiento automático con IA:</h4>
                <p>El sistema puede utilizar inteligencia artificial para analizar automáticamente los duplicados:</p>
                <ul style="list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #2e7d32;">•</span>
                        La IA analiza cada par de productos y decide cuál mantener basado en los criterios configurados.
                    </li>
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #2e7d32;">•</span>
                        Establece el nivel de confianza mínimo según tus necesidades de precisión.
                    </li>
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #2e7d32;">•</span>
                        Revisa los resultados antes de aplicar cambios permanentes.
                    </li>
                </ul>
            </div>
            
            <button class="btn btn-primary" onclick="cerrarPopup('popup-ayuda-productos')" style="float: right;">Entendido</button>
        </div>
    </div>

    <!-- POPUP: AYUDA FACTURAS -->
    <div id="popup-ayuda-facturas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5); z-index: 1000; padding: 20px;">
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 100%; max-width: 800px; max-height: 90vh; overflow: auto; position: relative;">
            <div style="position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; background: #f1f3f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="cerrarPopup('popup-ayuda-facturas')">✕</div>
            <h2 style="margin-bottom: 20px;">Ayuda: Detección de Facturas Duplicadas</h2>
            
            <p style="margin-bottom: 15px;">El sistema utiliza múltiples criterios para detectar facturas que podrían ser duplicadas:</p>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Criterios para considerar facturas duplicadas:</h3>
                <ul style="list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #1a73e8;">✓</span>
                        <strong>Misma fecha + mismo establecimiento + mismo total:</strong> Alta probabilidad de ser la misma factura cargada dos veces.
                    </li>
                    <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #1a73e8;">✓</span>
                        <strong>Misma fecha + mismo establecimiento + productos similares:</strong> Posiblemente la misma factura con algunas diferencias en la captura.
                    </li>
                    <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #f57c00;">⚠</span>
                        <strong>Mismo establecimiento + productos idénticos + fechas cercanas:</strong> Podría ser una compra repetida o una factura duplicada con fecha mal leída.
                    </li>
                </ul>
            </div>
            
            <h3 style="margin-bottom: 15px;">Cómo verificar los duplicados:</h3>
            <ol style="padding-left: 20px; margin-bottom: 20px;">
                <li style="margin-bottom: 10px;"><strong>Revisa la imagen:</strong> La forma más confiable de verificar si dos facturas son realmente la misma.</li>
                <li style="margin-bottom: 10px;"><strong>Compara productos:</strong> Revisa si los productos coinciden exactamente o hay variaciones.</li>
                <li style="margin-bottom: 10px;"><strong>Verifica fechas y horas:</strong> A veces las facturas son del mismo día pero de compras diferentes.</li>
                <li style="margin-bottom: 10px;"><strong>Números de referencia:</strong> Si están disponibles, los números de factura o transacción son definitivos.</li>
            </ol>
            
            <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: #c62828;">Importante:</h4>
                <ul style="list-style-type: none; padding-left: 0;">
                    <li style="padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #c62828;">!</span>
                        Al eliminar una factura, se eliminan permanentemente sus datos y su imagen. Asegúrate de mantener la factura más completa y precisa cuando elimines duplicados.
                    </li>
                </ul>
            </div>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: #2e7d32;">Procesamiento automático con IA:</h4>
                <p>El sistema puede utilizar inteligencia artificial para analizar automáticamente las facturas duplicadas:</p>
                <ul style="list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #2e7d32;">•</span>
                        La IA analiza cada par de facturas y decide cuál mantener basado en los criterios configurados.
                    </li>
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #2e7d32;">•</span>
                        Para facturas con imágenes, se utilizan técnicas de visión por computadora para comparar el contenido.
                    </li>
                    <li style="margin-bottom: 5px; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #2e7d32;">•</span>
                        Revisa los resultados antes de aplicar cambios permanentes.
                    </li>
                </ul>
            </div>
            
            <button class="btn btn-primary" onclick="cerrarPopup('popup-ayuda-facturas')" style="float: right;">Entendido</button>
        </div>
    </div>

    <!-- POPUP: VISTA IMAGEN -->
    <div id="popup-imagen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5); z-index: 1000; padding: 20px;">
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 100%; max-width: 800px; max-height: 90vh; overflow: auto; position: relative; text-align: center;">
            <div style="position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; background: #f1f3f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="cerrarPopup('popup-imagen')">✕</div>
            <h3 id="popup-imagen-titulo" style="margin-bottom: 15px;">Vista Ampliada</h3>
            <img id="popup-imagen-contenido" src="" alt="Imagen de factura" style="max-width: 100%; max-height: 70vh; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        </div>
    </div>

    <!-- POPUP: RESULTADOS IA -->
    <div id="popup-resultados-ia" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5); z-index: 1000; padding: 20px;">
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 100%; max-width: 1000px; max-height: 90vh; overflow: auto; position: relative;">
            <div style="position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; background: #f1f3f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="cerrarPopup('popup-resultados-ia')">✕</div>
            <h2 style="margin-bottom: 20px;">Resultados del Procesamiento IA</h2>
            
            <div style="background: #f5f7fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 id="ia-resultados-titulo">Análisis de Duplicados</h3>
                    <div>
                        <span id="ia-total-procesados" class="criteria-tag" style="background: #e3f2fd; color: #1976d2;">0 procesados</span>
                        <span id="ia-total-decisiones" class="criteria-tag" style="background: #e8f5e9; color: #2e7d32;">0 decisiones</span>
                    </div>
                </div>
                <div id="ia-resultados-resumen"></div>
            </div>
            
            <div id="ia-resultados-contenido" style="margin-bottom: 20px; max-height: 500px; overflow-y: auto;">
                <!-- Contenido de resultados -->
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="cerrarPopup('popup-resultados-ia')">Cerrar</button>
                <button class="btn btn-success" onclick="aplicarDecisionesIA()" id="btn-aplicar-decisiones">Aplicar Decisiones</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración global
        const API_URL = window.location.origin;
        let productosDuplicados = [];
        let facturasDuplicadas = [];
        let paginaActualProductos = 1;
        let paginaActualFacturas = 1;
        const elementosPorPagina = 5;
        let totalFusiones = 0;
        let totalEliminaciones = 0;
        let procesandoIA = false;
        let procesoIACancelado = false;
        
        // Resultados de IA
        let resultadosProductosIA = [];
        let resultadosFacturasIA = [];
        
        // Configuración de IA
        // Configuración de IA
        let configuracionIA = {
          apiKey: "", // Inicialmente vacío, se obtendrá del servidor
          modelo: "claude-3-haiku-20240307",
          tamanoLote: 10,
          intervaloLote: 5, // segundos
          criteriosProductos: "",
      criteriosFacturas: ""
        };

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
      verificarConexionAPI();
      cargarEstadisticas();
      cargarConfiguracionIA();
      obtenerAPIKey(); // Nueva función para obtener la API key del servidor
    });

// Obtener API Key del servidor
    async function obtenerAPIKey() {
      try {
        const response = await fetch(`${API_URL}/api/config/anthropic-key`);
        if (response.ok) {
      const data = await response.json();
      configuracionIA.apiKey = data.apiKey || "";
      // Actualizar el campo del formulario con asteriscos por seguridad
      if (document.getElementById('apiKey')) {
        document.getElementById('apiKey').value = configuracionIA.apiKey ? "********" : "";
      }
    }
  } catch (error) {
    console.error('Error obteniendo API key:', error);
  }
}
        
        function mostrarMensajeError(mensaje) {
            const container = document.querySelector('.container');
            const alerta = document.createElement('div');
            alerta.style.background = '#fff3e0';
            alerta.style.border = '1px solid #ffb74d';
            alerta.style.borderRadius = '8px';
            alerta.style.padding = '15px';
            alerta.style.marginBottom = '20px';
            
            alerta.innerHTML = `
                <h3 style="margin-bottom: 10px; color: #e65100;">⚠️ Advertencia</h3>
                <p>${mensaje}</p>
            `;
            
            container.insertBefore(alerta, container.firstChild);
        }

        // Función para cambiar pestañas
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'productos') {
                detectarProductosDuplicados();
            } else if (tabName === 'facturas') {
                detectarFacturasDuplicadas();
            }
        }

        // Cargar estadísticas generales
        async function cargarEstadisticas() {
            try {
                const response = await fetch(`${API_URL}/admin/stats`);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                document.getElementById('total-productos').textContent = data.productos_unicos || 0;
                document.getElementById('total-facturas').textContent = data.total_facturas || 0;
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                mostrarToast('Error al cargar estadísticas: ' + error.message, 'error');
                
                // Usar datos de ejemplo si falla
                document.getElementById('total-productos').textContent = '358';
                document.getElementById('total-facturas').textContent = '124';
            }
        }

        // GESTIÓN DE PRODUCTOS DUPLICADOS
        async function detectarProductosDuplicados() {
            const container = document.getElementById('productos-duplicados-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analizando duplicados de productos...</p></div>';
            
            try {
                const umbral = document.getElementById('umbralSimilitud').value;
                const criterio = document.getElementById('criteriosProductos').value;
                
                const url = `${API_URL}/admin/duplicados/productos?umbral=${umbral}&criterio=${criterio}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                productosDuplicados = data.duplicados || [];
                
                // Actualizar estadísticas
                document.getElementById('total-duplicados').textContent = data.total || 0;
                const porcentaje = data.total > 0 ? 
                ((data.total / parseInt(document.getElementById('total-productos').textContent)) * 100).toFixed(1) + '%' : 
                '0%';
                document.getElementById('porcentaje-duplicados').textContent = porcentaje;
                
                if (productosDuplicados.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No se encontraron productos duplicados</h3>
                            <p>Prueba con un umbral de similitud más bajo o diferentes criterios</p>
                        </div>
                    `;
                    document.getElementById('productos-pagination').innerHTML = '';
                    document.getElementById('productos-ia-panel').style.display = 'none';
                    return;
                }
                
                // Mostrar panel de IA
                document.getElementById('productos-ia-panel').style.display = 'block';
                
                // Renderizar la primera página
                renderizarPaginaProductos(1);
                
            } catch (error) {
                console.error('Error detectando duplicados de productos:', error);
                
                container.innerHTML = `
                    <div style="padding: 20px; background: #ffebee; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #c62828; margin-bottom: 10px;">Error al buscar duplicados</h3>
                        <p>${error.message || 'Error desconocido'}</p>
                        <button class="btn btn-primary" onclick="detectarProductosDuplicados()" style="margin-top: 15px;">
                            Intentar nuevamente
                        </button>
                    </div>
                `;
                document.getElementById('productos-ia-panel').style.display = 'none';
            }
        }

        function renderizarPaginaProductos(pagina) {
            const container = document.getElementById('productos-duplicados-container');
            const paginacion = document.getElementById('productos-pagination');
            
            // Guardar la página actual
            paginaActualProductos = pagina;
            
            // Calcular índices para la paginación
            const inicio = (pagina - 1) * elementosPorPagina;
            const fin = Math.min(inicio + elementosPorPagina, productosDuplicados.length);
            const duplicadosPagina = productosDuplicados.slice(inicio, fin);
            
            let html = '';
            
            duplicadosPagina.forEach((dup, index) => {
                const similitudClase = dup.similitud >= 85 ? 'similarity-high' : 
                                      dup.similitud >= 70 ? 'similarity-medium' : 'similarity-low';
                
                // Determinar criterios de similitud para mostrar etiquetas
                const criterios = [];
                if (dup.mismo_codigo) criterios.push('Mismo código');
                if (dup.mismo_establecimiento) criterios.push('Mismo establecimiento');
                if (dup.nombre_similar) criterios.push('Nombre similar');
                
                // Verificar si este duplicado ha sido procesado por IA
                const resultadoIA = resultadosProductosIA.find(r => r.dupId === dup.id || r.dupId === index.toString());
                const iaTag = resultadoIA ? 
                    `<span class="criteria-tag" style="background: #e8f5e9; color: #2e7d32;">IA: ${resultadoIA.decision === 1 ? 'Mantener #1' : 'Mantener #2'} (${resultadoIA.confianza}%)</span>` : '';
                
                html += `
                    <div id="duplicado-${dup.id || index}" class="duplicate-container">
                        <div class="duplicate-header">
                            <div>
                                <span class="similarity-tag ${similitudClase}">Similitud: ${dup.similitud}%</span>
                                ${criterios.map(c => `<span class="criteria-tag">${c}</span>`).join('')}
                                ${iaTag}
                            </div>
                            <button class="btn btn-success btn-sm" onclick="fusionarProductos('${dup.id || index}')">
                                Fusionar Seleccionado
                            </button>
                        </div>
                        
                        <div class="duplicate-grid">
                            <div id="producto-${dup.producto1.id}" class="duplicate-item" data-id="${dup.producto1.id}">
                                <div class="selection-mark ${resultadoIA && resultadoIA.decision === 1 ? 'selected' : (dup.seleccionado === dup.producto2.id ? 'not-selected' : 'selected')}">1</div>
                                
                                <div class="duplicate-metadata">
                                    <h3>Producto #${dup.producto1.id}</h3>
                                    <p style="margin-top: 5px; color: #666;">
                                        <strong>Nombre:</strong> ${dup.producto1.nombre}<br>
                                        <strong>Código:</strong> ${dup.producto1.codigo || 'Sin código'}<br>
                                        <strong>Establecimiento:</strong> ${dup.producto1.establecimiento || 'Desconocido'}<br>
                                        <strong>Precio actual:</strong> $${typeof dup.producto1.precio === 'number' ? dup.producto1.precio.toLocaleString() : dup.producto1.precio || 'N/A'}<br>
                                        <strong>Última actualización:</strong> ${dup.producto1.ultima_actualizacion ? new Date(dup.producto1.ultima_actualizacion).toLocaleDateString() : 'N/A'}<br>
                                        <strong>Visto:</strong> ${dup.producto1.veces_visto || 0} veces
                                    </p>
                                </div>
                                
                                <button class="btn ${resultadoIA && resultadoIA.decision === 1 ? 'btn-primary' : (dup.seleccionado === dup.producto2.id ? 'btn-secondary' : 'btn-primary')} select-button" onclick="seleccionarProducto('${dup.id || index}', ${dup.producto1.id})">
                                    ${resultadoIA && resultadoIA.decision === 1 ? '✓ Seleccionado por IA' : (dup.seleccionado === dup.producto2.id ? 'Seleccionar Este' : '✓ Seleccionar Este')}
                                </button>
                            </div>
                            
                            <div id="producto-${dup.producto2.id}" class="duplicate-item" data-id="${dup.producto2.id}">
                                <div class="selection-mark ${resultadoIA && resultadoIA.decision === 2 ? 'selected' : (dup.seleccionado === dup.producto2.id ? 'selected' : 'not-selected')}">2</div>
                                
                                <div class="duplicate-metadata">
                                    <h3>Producto #${dup.producto2.id}</h3>
                                    <p style="margin-top: 5px; color: #666;">
                                        <strong>Nombre:</strong> ${dup.producto2.nombre}<br>
                                        <strong>Código:</strong> ${dup.producto2.codigo || 'Sin código'}<br>
                                        <strong>Establecimiento:</strong> ${dup.producto2.establecimiento || 'Desconocido'}<br>
                                        <strong>Precio actual:</strong> $${typeof dup.producto2.precio === 'number' ? dup.producto2.precio.toLocaleString() : dup.producto2.precio || 'N/A'}<br>
                                        <strong>Última actualización:</strong> ${dup.producto2.ultima_actualizacion ? new Date(dup.producto2.ultima_actualizacion).toLocaleDateString() : 'N/A'}<br>
                                        <strong>Visto:</strong> ${dup.producto2.veces_visto || 0} veces
                                    </p>
                                </div>
                                
                               <button class="btn ${resultadoIA && resultadoIA.decision === 2 ? 'btn-primary' : (dup.seleccionado === dup.producto2.id ? 'btn-primary' : 'btn-secondary')} select-button" onclick="seleccionarProducto('${dup.id || index}', ${dup.producto2.id})">
                                ${resultadoIA && resultadoIA.decision === 2 ? '✓ Seleccionado por IA' : (dup.seleccionado === dup.producto2.id ? '✓ Seleccionar Este' : 'Seleccionar Este')}
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: #f5f7fa; border-top: 1px solid #e0e0e0;">
                            <h4 style="margin-bottom: 10px;">Razón de duplicidad</h4>
                            <p>${dup.razon || 'Productos con características similares'}</p>
                            ${resultadoIA ? `<p style="margin-top: 10px; color: #2e7d32;"><strong>Análisis IA:</strong> ${resultadoIA.explicacion || 'Sin explicación disponible'}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Generar paginación
            const totalPaginas = Math.ceil(productosDuplicados.length / elementosPorPagina);
            let paginacionHTML = '';
            
            if (totalPaginas > 1) {
                paginacionHTML += `
                    <div class="pagination-item" onclick="renderizarPaginaProductos(1)">«</div>
                    <div class="pagination-item" onclick="renderizarPaginaProductos(${Math.max(pagina - 1, 1)})">‹</div>
                `;
                
                for (let i = 1; i <= totalPaginas; i++) {
                    if (i === 1 || i === totalPaginas || (i >= pagina - 1 && i <= pagina + 1)) {
                        paginacionHTML += `
                            <div class="pagination-item ${i === pagina ? 'active' : ''}" onclick="renderizarPaginaProductos(${i})">
                                ${i}
                            </div>
                        `;
                    } else if (i === pagina - 2 || i === pagina + 2) {
                        paginacionHTML += '<div class="pagination-item">...</div>';
                    }
                }
                
                paginacionHTML += `
                    <div class="pagination-item" onclick="renderizarPaginaProductos(${Math.min(pagina + 1, totalPaginas)})">›</div>
                    <div class="pagination-item" onclick="renderizarPaginaProductos(${totalPaginas})">»</div>
                `;
            }
            
            paginacion.innerHTML = paginacionHTML;
        }

        function seleccionarProducto(dupId, productoId) {
            const duplicado = productosDuplicados.find(d => d.id === dupId || productosDuplicados.indexOf(d) === parseInt(dupId));
            if (!duplicado) return;
            
            // Determinar cuál es el producto seleccionado y cuál no
            let productoSeleccionado, productoNoSeleccionado;
            if (duplicado.producto1.id === productoId) {
                productoSeleccionado = duplicado.producto1;
                productoNoSeleccionado = duplicado.producto2;
                
                document.querySelector(`#producto-${duplicado.producto1.id} .selection-mark`).className = 'selection-mark selected';
                document.querySelector(`#producto-${duplicado.producto2.id} .selection-mark`).className = 'selection-mark not-selected';
                
                document.querySelector(`#producto-${duplicado.producto1.id} .select-button`).className = 'btn btn-primary select-button';
                document.querySelector(`#producto-${duplicado.producto1.id} .select-button`).innerHTML = '✓ Seleccionar Este';
                
                document.querySelector(`#producto-${duplicado.producto2.id} .select-button`).className = 'btn btn-secondary select-button';
                document.querySelector(`#producto-${duplicado.producto2.id} .select-button`).innerHTML = 'Seleccionar Este';
                
            } else {
                productoSeleccionado = duplicado.producto2;
                productoNoSeleccionado = duplicado.producto1;
                
                document.querySelector(`#producto-${duplicado.producto1.id} .selection-mark`).className = 'selection-mark not-selected';
                document.querySelector(`#producto-${duplicado.producto2.id} .selection-mark`).className = 'selection-mark selected';
                
                document.querySelector(`#producto-${duplicado.producto1.id} .select-button`).className = 'btn btn-secondary select-button';
                document.querySelector(`#producto-${duplicado.producto1.id} .select-button`).innerHTML = 'Seleccionar Este';
                
                document.querySelector(`#producto-${duplicado.producto2.id} .select-button`).className = 'btn btn-primary select-button';
                document.querySelector(`#producto-${duplicado.producto2.id} .select-button`).innerHTML = '✓ Seleccionar Este';
            }
            
            // Actualizar el duplicado con la selección
            duplicado.seleccionado = productoId;

            // Si hay un resultado de IA para este duplicado, actualizar la decisión manual
            const resultadoIndex = resultadosProductosIA.findIndex(r => r.dupId === dupId || r.dupId === parseInt(dupId));
            if (resultadoIndex !== -1) {
                resultadosProductosIA[resultadoIndex].decisionManual = duplicado.producto1.id === productoId ? 1 : 2;
            }
        }

        async function fusionarProductos(dupId) {
            const duplicado = productosDuplicados.find(d => d.id === dupId || productosDuplicados.indexOf(d) === parseInt(dupId));
            if (!duplicado) return;
            
            // Si no hay seleccionado, por defecto es el producto1
            const productoMantener = duplicado.seleccionado === duplicado.producto2.id ? 
                                    duplicado.producto2 : duplicado.producto1;
            const productoEliminar = productoMantener === duplicado.producto1 ? 
                                    duplicado.producto2 : duplicado.producto1;
            
            if (!confirm(`¿Fusionar estos productos? Se mantendrá "${productoMantener.nombre}" (#${productoMantener.id}) y se eliminará "${productoEliminar.nombre}" (#${productoEliminar.id})`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/duplicados/productos/fusionar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        producto_mantener_id: productoMantener.id,
                        producto_eliminar_id: productoEliminar.id
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Actualizar contador de fusiones
                totalFusiones++;
                document.getElementById('total-fusiones').textContent = totalFusiones;
                
                // Eliminar el duplicado fusionado
                productosDuplicados = productosDuplicados.filter(d => d.id !== dupId && productosDuplicados.indexOf(d) !== parseInt(dupId));
                
                // Eliminar de los resultados de IA si existe
                resultadosProductosIA = resultadosProductosIA.filter(r => r.dupId !== dupId && r.dupId !== parseInt(dupId));
                
                // Actualizar estadísticas
                document.getElementById('total-duplicados').textContent = productosDuplicados.length;
                const porcentaje = productosDuplicados.length > 0 ? 
                    ((productosDuplicados.length / parseInt(document.getElementById('total-productos').textContent)) * 100).toFixed(1) + '%' : 
                    '0%';
                document.getElementById('porcentaje-duplicados').textContent = porcentaje;
                
                // Eliminar visualmente
                document.getElementById(`duplicado-${dupId}`).style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => {
                    // Actualizar la vista actual
                    renderizarPaginaProductos(paginaActualProductos);
                }, 500);
                
                mostrarToast('Productos fusionados correctamente');
                
            } catch (error) {
                console.error('Error fusionando productos:', error);
                mostrarToast('Error al fusionar productos: ' + error.message, 'error');
            }
        }

        function mostrarAyudaProductos() {
            document.getElementById('popup-ayuda-productos').style.display = 'flex';
        }

        // GESTIÓN DE FACTURAS DUPLICADAS
        async function detectarFacturasDuplicadas() {
            const container = document.getElementById('facturas-duplicadas-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analizando duplicados de facturas...</p></div>';
            
            try {
                const criterio = document.getElementById('criterioFacturas').value;
                
                const url = `${API_URL}/admin/duplicados/facturas?criterio=${criterio}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                facturasDuplicadas = data.duplicados || [];
                
                // Actualizar estadísticas
                document.getElementById('total-facturas-duplicadas').textContent = data.total || 0;
                const porcentaje = data.total > 0 ? 
                    ((data.total / parseInt(document.getElementById('total-facturas').textContent)) * 100).toFixed(1) + '%' : 
                    '0%';
                document.getElementById('porcentaje-facturas-duplicadas').textContent = porcentaje;
                
                if (facturasDuplicadas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No se encontraron facturas duplicadas</h3>
                            <p>Prueba con diferentes criterios de búsqueda</p>
                        </div>
                    `;
                    document.getElementById('facturas-pagination').innerHTML = '';
                    document.getElementById('facturas-ia-panel').style.display = 'none';
                    return;
                }
                
                // Mostrar panel de IA
                document.getElementById('facturas-ia-panel').style.display = 'block';
                
                // Pre-verificar si las facturas tienen imágenes
                const mostrarImagenes = document.getElementById('mostrarImagenes').checked;
                if (mostrarImagenes) {
                    for (const dup of facturasDuplicadas) {
                        try {
                            const resp1 = await fetch(`${API_URL}/admin/duplicados/facturas/${dup.factura1.id}/check-image`);
                            const data1 = await resp1.json();
                            dup.factura1.tieneImagen = data1.tiene_imagen;
                            
                            const resp2 = await fetch(`${API_URL}/admin/duplicados/facturas/${dup.factura2.id}/check-image`);
                            const data2 = await resp2.json();
                            dup.factura2.tieneImagen = data2.tiene_imagen;
                        } catch (error) {
                            console.error('Error verificando imágenes:', error);
                            dup.factura1.tieneImagen = false;
                            dup.factura2.tieneImagen = false;
                        }
                    }
                }
                
                // Renderizar la primera página
                renderizarPaginaFacturas(1);
                
            } catch (error) {
                console.error('Error detectando duplicados de facturas:', error);
                
                // Mostrar mensaje de error
                container.innerHTML = `
                    <div style="padding: 20px; background: #ffebee; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #c62828; margin-bottom: 10px;">Error al buscar duplicados</h3>
                        <p>${error.message || 'Error desconocido'}</p>
                        <button class="btn btn-primary" onclick="detectarFacturasDuplicadas()" style="margin-top: 15px;">
                            Intentar nuevamente
                        </button>
                    </div>
                `;
                document.getElementById('facturas-ia-panel').style.display = 'none';
            }
        }

        function renderizarPaginaFacturas(pagina) {
            const container = document.getElementById('facturas-duplicadas-container');
            const paginacion = document.getElementById('facturas-pagination');
            const mostrarImagenes = document.getElementById('mostrarImagenes').checked;
            
            // Guardar la página actual
            paginaActualFacturas = pagina;
            
            // Calcular índices para la paginación
            const inicio = (pagina - 1) * elementosPorPagina;
            const fin = Math.min(inicio + elementosPorPagina, facturasDuplicadas.length);
            const duplicadosPagina = facturasDuplicadas.slice(inicio, fin);
            
            let html = '';
            
            duplicadosPagina.forEach((dup, index) => {
                // Análisis de similitudes entre productos para destacar
                const productosIguales = dup.productos_iguales || false;
                const productosSimilares = dup.productos_similares || false;
                const totalIguales = dup.total_iguales || false;
                
                // Criterios de duplicado
                const criterios = [];
                if (dup.misma_fecha) criterios.push('Misma fecha');
                if (dup.mismo_establecimiento) criterios.push('Mismo establecimiento');
                if (totalIguales) criterios.push('Mismo total');
                if (productosIguales) criterios.push('Productos idénticos');
                if (productosSimilares) criterios.push('Productos similares');
                
                // Verificar si este duplicado ha sido procesado por IA
                const resultadoIA = resultadosFacturasIA.find(r => r.dupId === dup.id || r.dupId === index.toString());
                const iaTag = resultadoIA ? 
                    `<span class="criteria-tag" style="background: #e8f5e9; color: #2e7d32;">IA: ${resultadoIA.decision === 1 ? 'Mantener #1' : 'Mantener #2'} (${resultadoIA.confianza}%)</span>` : '';
                
                html += `
                    <div id="factura-dup-${dup.id || index}" class="duplicate-container">
                        <div class="duplicate-header">
                            <div>
                                ${criterios.map(c => `<span class="criteria-tag">${c}</span>`).join('')}
                                ${iaTag}
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-danger btn-sm" onclick="eliminarFactura(${dup.factura1.id}, '${dup.id || index}')">
                                    Eliminar #${dup.factura1.id}
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarFactura(${dup.factura2.id}, '${dup.id || index}')">
                                    Eliminar #${dup.factura2.id}
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="compararFacturas(${dup.factura1.id}, ${dup.factura2.id})">
                                    ↔ Comparar
                                </button>
                            </div>
                        </div>
                        
                        <div class="duplicate-grid">
                            <div class="duplicate-item ${resultadoIA && resultadoIA.decision === 1 ? 'selected' : ''}">
                                <div class="duplicate-metadata">
                                    <h3>Factura #${dup.factura1.id}</h3>
                                    <p style="margin-top: 5px; color: #666;">
                                        <strong>Establecimiento:</strong> ${dup.factura1.establecimiento}<br>
                                        <strong>Total:</strong> $${typeof dup.factura1.total === 'number' ? dup.factura1.total.toLocaleString() : dup.factura1.total || 'N/A'}<br>
                                        <strong>Productos:</strong> ${dup.factura1.num_productos || 0}<br>
                                        <strong>Fecha:</strong> ${dup.factura1.fecha ? new Date(dup.factura1.fecha).toLocaleDateString() : 'N/A'}<br>
                                        <strong>Estado:</strong> ${dup.factura1.estado || 'Pendiente'}
                                    </p>
                                </div>
                                
                                ${mostrarImagenes ? `
                                    <div class="duplicate-image">
                                        ${dup.factura1.tieneImagen ? `
                                            <img src="${API_URL}/admin/duplicados/facturas/${dup.factura1.id}/imagen" 
                                                alt="Factura #${dup.factura1.id}" 
                                                onclick="mostrarImagenAmpliada(${dup.factura1.id}, 'Factura #${dup.factura1.id}')" 
                                                style="cursor: zoom-in;">
                                            <div style="text-align: center; margin-top: 5px;">
                                                <button class="btn btn-sm btn-secondary" onclick="mostrarImagenAmpliada(${dup.factura1.id}, 'Factura #${dup.factura1.id}')">
                                                    🔍 Ampliar
                                                </button>
                                                <a href="${API_URL}/admin/duplicados/facturas/${dup.factura1.id}/imagen" target="_blank" class="btn btn-sm btn-secondary">
                                                    ↗ Abrir
                                                </a>
                                            </div>
                                        ` : `
                                            <div style="color: #999;">
                                                <p style="margin-bottom: 10px;">No hay imagen disponible</p>
                                                <button class="btn btn-secondary btn-sm" onclick="verFactura(${dup.factura1.id})">
                                                    Ver Factura
                                                </button>
                                            </div>
                                        `}
                                    </div>
                                ` : ''}
                                
                                <div class="product-list">
                                    <h4 style="margin-bottom: 10px;">Productos (${dup.factura1.productos?.length || 0})</h4>
                                    ${dup.factura1.productos && dup.factura1.productos.length > 0 ? dup.factura1.productos.map(p => `
                                        <div class="product-item">
                                            <h4>${p.nombre || 'Sin nombre'}</h4>
                                            <div class="product-meta">
                                                <span><strong>Código:</strong> ${p.codigo || 'N/A'}</span>
                                                <span><strong>Precio:</strong> $${typeof p.precio === 'number' ? p.precio.toLocaleString() : p.precio || 'N/A'}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p>No hay productos disponibles</p>'}
                                </div>
                            </div>
                            
                            <div class="duplicate-item ${resultadoIA && resultadoIA.decision === 2 ? 'selected' : ''}">
                                <div class="duplicate-metadata">
                                    <h3>Factura #${dup.factura2.id}</h3>
                                    <p style="margin-top: 5px; color: #666;">
                                        <strong>Establecimiento:</strong> ${dup.factura2.establecimiento}<br>
                                        <strong>Total:</strong> $${typeof dup.factura2.total === 'number' ? dup.factura2.total.toLocaleString() : dup.factura2.total || 'N/A'}<br>
                                        <strong>Productos:</strong> ${dup.factura2.num_productos || 0}<br>
                                        <strong>Fecha:</strong> ${dup.factura2.fecha ? new Date(dup.factura2.fecha).toLocaleDateString() : 'N/A'}<br>
                                        <strong>Estado:</strong> ${dup.factura2.estado || 'Pendiente'}
                                    </p>
                                </div>
                                
                                ${mostrarImagenes ? `
                                    <div class="duplicate-image">
                                        ${dup.factura2.tieneImagen ? `
                                            <img src="${API_URL}/admin/duplicados/facturas/${dup.factura2.id}/imagen" 
                                                alt="Factura #${dup.factura2.id}" 
                                                onclick="mostrarImagenAmpliada(${dup.factura2.id}, 'Factura #${dup.factura2.id}')" 
                                                style="cursor: zoom-in;">
                                            <div style="text-align: center; margin-top: 5px;">
                                                <button class="btn btn-sm btn-secondary" onclick="mostrarImagenAmpliada(${dup.factura2.id}, 'Factura #${dup.factura2.id}')">
                                                    🔍 Ampliar
                                                </button>
                                                <a href="${API_URL}/admin/duplicados/facturas/${dup.factura2.id}/imagen" target="_blank" class="btn btn-sm btn-secondary">
                                                    ↗ Abrir
                                                </a>
                                            </div>
                                        ` : `
                                            <div style="color: #999;">
                                                <p style="margin-bottom: 10px;">No hay imagen disponible</p>
                                                <button class="btn btn-secondary btn-sm" onclick="verFactura(${dup.factura2.id})">
                                                    Ver Factura
                                                </button>
                                            </div>
                                        `}
                                    </div>
                                ` : ''}
                                
                                <div class="product-list">
                                    <h4 style="margin-bottom: 10px;">Productos (${dup.factura2.productos?.length || 0})</h4>
                                    ${dup.factura2.productos && dup.factura2.productos.length > 0 ? dup.factura2.productos.map(p => `
                                        <div class="product-item">
                                            <h4>${p.nombre || 'Sin nombre'}</h4>
                                            <div class="product-meta">
                                                <span><strong>Código:</strong> ${p.codigo || 'N/A'}</span>
                                                <span><strong>Precio:</strong> $${typeof p.precio === 'number' ? p.precio.toLocaleString() : p.precio || 'N/A'}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p>No hay productos disponibles</p>'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: #f5f7fa; border-top: 1px solid #e0e0e0;">
                            <h4 style="margin-bottom: 10px;">Razón de duplicidad</h4>
                            <p>${dup.razon || 'Facturas con características similares'}</p>
                            ${resultadoIA ? `<p style="margin-top: 10px; color: #2e7d32;"><strong>Análisis IA:</strong> ${resultadoIA.explicacion || 'Sin explicación disponible'}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Generar paginación
            const totalPaginas = Math.ceil(facturasDuplicadas.length / elementosPorPagina);
            let paginacionHTML = '';
            
            if (totalPaginas > 1) {
                paginacionHTML += `
                    <div class="pagination-item" onclick="renderizarPaginaFacturas(1)">«</div>
                    <div class="pagination-item" onclick="renderizarPaginaFacturas(${Math.max(pagina - 1, 1)})">‹</div>
                `;
                
                for (let i = 1; i <= totalPaginas; i++) {
                    if (i === 1 || i === totalPaginas || (i >= pagina - 1 && i <= pagina + 1)) {
                        paginacionHTML += `
                            <div class="pagination-item ${i === pagina ? 'active' : ''}" onclick="renderizarPaginaFacturas(${i})">
                                ${i}
                            </div>
                        `;
                    } else if (i === pagina - 2 || i === pagina + 2) {
                        paginacionHTML += '<div class="pagination-item">...</div>';
                    }
                }
                
                paginacionHTML += `
                    <div class="pagination-item" onclick="renderizarPaginaFacturas(${Math.min(pagina + 1, totalPaginas)})">›</div>
                    <div class="pagination-item" onclick="renderizarPaginaFacturas(${totalPaginas})">»</div>
                `;
            }
            
            paginacion.innerHTML = paginacionHTML;
        }

        async function eliminarFactura(facturaId, dupId) {
            // Verificar si hay un resultado de IA para esta factura
            const resultadoIA = resultadosFacturasIA.find(r => r.dupId === dupId || r.dupId === parseInt(dupId));
            let mensajeConfirmacion = `¿Eliminar la factura #${facturaId} y todos sus productos?`;
            
            // Si hay un resultado de IA, mostrar más información
            if (resultadoIA) {
                const esRecomendadoPorIA = (resultadoIA.decision === 1 && facturaId === resultadoIA.factura2Id) || 
                                          (resultadoIA.decision === 2 && facturaId === resultadoIA.factura1Id);
                
                if (esRecomendadoPorIA) {
                    mensajeConfirmacion = `ADVERTENCIA: La IA recomienda MANTENER esta factura y eliminar la otra.\n\n${mensajeConfirmacion}\n\n¿Estás seguro de que deseas continuar?`;
                } else {
                    mensajeConfirmacion = `La IA recomienda eliminar esta factura.\n\n${mensajeConfirmacion}`;
                }
            }
            
            if (!confirm(mensajeConfirmacion)) return;
            
            try {
                const response = await fetch(`${API_URL}/admin/duplicados/facturas/${facturaId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                // Actualizar contador
                totalEliminaciones++;
                document.getElementById('total-eliminaciones').textContent = totalEliminaciones;
                
                // Eliminar de la lista de duplicados
                if (dupId) {
                    facturasDuplicadas = facturasDuplicadas.filter(d => d.id !== dupId && facturasDuplicadas.indexOf(d) !== parseInt(dupId));
                    
                    // Eliminar de los resultados de IA si existe
                    resultadosFacturasIA = resultadosFacturasIA.filter(r => r.dupId !== dupId && r.dupId !== parseInt(dupId));
                    
                    // Actualizar estadísticas
                    document.getElementById('total-facturas-duplicadas').textContent = facturasDuplicadas.length;
                    const porcentaje = facturasDuplicadas.length > 0 ? 
                        ((facturasDuplicadas.length / parseInt(document.getElementById('total-facturas').textContent)) * 100).toFixed(1) + '%' : 
                        '0%';
                    document.getElementById('porcentaje-facturas-duplicadas').textContent = porcentaje;
                    
                    // Eliminar visualmente
                    const elemento = document.getElementById(`factura-dup-${dupId}`);
                    if (elemento) {
                        elemento.style.animation = 'fadeOut 0.5s forwards';
                        setTimeout(() => {
                            renderizarPaginaFacturas(paginaActualFacturas);
                        }, 500);
                    }
                }
                
                mostrarToast('Factura eliminada correctamente');
                
            } catch (error) {
                console.error('Error eliminando factura:', error);
                mostrarToast('Error al eliminar la factura: ' + error.message, 'error');
            }
        }

        function mostrarImagenAmpliada(facturaId, titulo) {
            document.getElementById('popup-imagen-titulo').textContent = titulo;
            document.getElementById('popup-imagen-contenido').src = `${API_URL}/admin/duplicados/facturas/${facturaId}/imagen`;
            document.getElementById('popup-imagen').style.display = 'flex';
        }

        function compararFacturas(factura1Id, factura2Id) {
            window.open(`/comparador-facturas?id1=${factura1Id}&id2=${factura2Id}`, '_blank');
        }

        function verFactura(facturaId) {
            window.open(`/editor?id=${facturaId}`, '_blank');
        }

        function mostrarAyudaFacturas() {
            document.getElementById('popup-ayuda-facturas').style.display = 'flex';
        }

        function cerrarPopup(id) {
            document.getElementById(id).style.display = 'none';
        }

        function mostrarToast(mensaje, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = mensaje;
            
            if (tipo === 'error') {
                toast.style.background = '#ea4335';
            } else if (tipo === 'info') {
                toast.style.background = '#4285f4';
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // INTEGRACIÓN CON API DE ANTHROPIC
        
        // Guardar la configuración de IA
        function guardarConfiguracionIA() {
            configuracionIA = {
                apiKey: document.getElementById('apiKey').value,
                modelo: document.getElementById('modeloIA').value,
                tamanoLote: parseInt(document.getElementById('tamanoLote').value),
                intervaloLote: parseInt(document.getElementById('intervaloLote').value),
                criteriosProductos: document.getElementById('criteriosProductosIA').value.trim(),
                criteriosFacturas: document.getElementById('criteriosFacturasIA').value.trim()
            };
            
            // Guardar en localStorage para persistencia
            localStorage.setItem('lecfac_ia_config', JSON.stringify({
                modelo: configuracionIA.modelo,
                tamanoLote: configuracionIA.tamanoLote,
                intervaloLote: configuracionIA.intervaloLote,
                criteriosProductos: configuracionIA.criteriosProductos,
                criteriosFacturas: configuracionIA.criteriosFacturas
            }));
            
            mostrarToast('Configuración guardada correctamente', 'success');
        }
        
        // Cargar la configuración de IA desde localStorage
        function cargarConfiguracionIA() {
            const configuracionGuardada = localStorage.getItem('lecfac_ia_config');
            if (configuracionGuardada) {
                try {
                    const config = JSON.parse(configuracionGuardada);
                    
                    if (config.modelo) document.getElementById('modeloIA').value = config.modelo;
                    if (config.tamanoLote) document.getElementById('tamanoLote').value = config.tamanoLote;
                    if (config.intervaloLote) document.getElementById('intervaloLote').value = config.intervaloLote;
                    if (config.criteriosProductos) document.getElementById('criteriosProductosIA').value = config.criteriosProductos;
                    if (config.criteriosFacturas) document.getElementById('criteriosFacturasIA').value = config.criteriosFacturas;
                    
                    // Actualizar configuración actual
                    configuracionIA.modelo = config.modelo || configuracionIA.modelo;
                    configuracionIA.tamanoLote = config.tamanoLote || configuracionIA.tamanoLote;
                    configuracionIA.intervaloLote = config.intervaloLote || configuracionIA.intervaloLote;
                    configuracionIA.criteriosProductos = config.criteriosProductos || configuracionIA.criteriosProductos;
                    configuracionIA.criteriosFacturas = config.criteriosFacturas || configuracionIA.criteriosFacturas;
                    
                } catch (error) {
                    console.error('Error cargando configuración de IA:', error);
                }
            }
            
            // Asegurarse de que los criterios tengan valores por defecto
            if (!configuracionIA.criteriosProductos) {
                configuracionIA.criteriosProductos = document.getElementById('criteriosProductosIA').value.trim();
            }
            
            if (!configuracionIA.criteriosFacturas) {
                configuracionIA.criteriosFacturas = document.getElementById('criteriosFacturasIA').value.trim();
            }
        }
        
        // Función para procesar duplicados con IA
        async function procesarDuplicadosIA(tipo) {
            if (procesandoIA) {
                mostrarToast('Ya hay un proceso de IA en ejecución. Espera a que termine.', 'error');
                return;
            }
            
            let duplicados;
            let confianzaMinima;
            
            if (tipo === 'productos') {
                duplicados = [...productosDuplicados];
                confianzaMinima = parseInt(document.getElementById('confianzaProductos').value);
            } else { // facturas
                duplicados = [...facturasDuplicadas];
                confianzaMinima = parseInt(document.getElementById('confianzaFacturas').value);
            }
            
            if (duplicados.length === 0) {
                mostrarToast(`No se encontraron ${tipo} duplicados para procesar`, 'error');
                return;
            }
            
            // Dividir en lotes
            const tamanoLote = configuracionIA.tamanoLote;
            const lotes = [];
            
            for (let i = 0; i < duplicados.length; i += tamanoLote) {
                lotes.push(duplicados.slice(i, i + tamanoLote));
            }
            
            // Configurar panel de progreso
            document.getElementById(`${tipo}-batch-status`).style.display = 'flex';
            document.getElementById(`${tipo}-progreso`).textContent = `0/${duplicados.length}`;
            document.getElementById(`${tipo}-progress-bar`).style.width = '0%';
            
            // Iniciar procesamiento
            procesandoIA = true;
            procesoIACancelado = false;
            
            // Limpiar resultados anteriores
            if (tipo === 'productos') {
                resultadosProductosIA = [];
            } else {
                resultadosFacturasIA = [];
            }
            
            let procesados = 0;
            
            // Procesar lotes secuencialmente
            for (let i = 0; i < lotes.length; i++) {
                if (procesoIACancelado) {
                    break;
                }
                
                const lote = lotes[i];
                const resultadosLote = await procesarLoteIA(tipo, lote, confianzaMinima);
                
                // Almacenar resultados
                if (tipo === 'productos') {
                    resultadosProductosIA = [...resultadosProductosIA, ...resultadosLote];
                } else {
                    resultadosFacturasIA = [...resultadosFacturasIA, ...resultadosLote];
                }
                
                // Actualizar progreso
                procesados += lote.length;
                const porcentaje = (procesados / duplicados.length) * 100;
                document.getElementById(`${tipo}-progreso`).textContent = `${procesados}/${duplicados.length}`;
                document.getElementById(`${tipo}-progress-bar`).style.width = `${porcentaje}%`;
                
                // Actualizar interfaz con las decisiones de IA
                if (tipo === 'productos') {
                    renderizarPaginaProductos(paginaActualProductos);
                } else {
                    renderizarPaginaFacturas(paginaActualFacturas);
                }
                
                // Actualizar contador
                document.getElementById(`${tipo}-procesados-ia`).textContent = procesados;
                
                // Esperar antes del siguiente lote (a menos que sea el último)
                if (i < lotes.length - 1 && !procesoIACancelado) {
                    await new Promise(resolve => setTimeout(resolve, configuracionIA.intervaloLote * 1000));
                }
            }
            
            // Finalizar procesamiento
            procesandoIA = false;
            
            // Ocultar panel de progreso
            setTimeout(() => {
                document.getElementById(`${tipo}-batch-status`).style.display = 'none';
            }, 1000);
            
            // Mostrar resumen
            if (!procesoIACancelado) {
                mostrarResumenIA(tipo);
            }
        }
        
        // Procesar un lote de duplicados con IA
        async function procesarLoteIA(tipo, lote, confianzaMinima) {
            try {
                // Preparar prompt para IA según tipo
                let promptBase;
                let datosAnalisis;
                
                if (tipo === 'productos') {
                    promptBase = `Por favor, analiza los siguientes productos duplicados y decide cuál mantener y cuál eliminar. Utiliza estos criterios de decisión:\n\n${configuracionIA.criteriosProductos}\n\nBasa tu decisión en estos criterios y explica tu razonamiento. Para cada par de productos, indica tu decisión como "Mantener #1" o "Mantener #2" y asigna un nivel de confianza de 0-100% a tu decisión.`;
                    
                    datosAnalisis = lote.map((dup, index) => {
                        return {
                            id: dup.id || index.toString(),
                            producto1: {
                                id: dup.producto1.id,
                                nombre: dup.producto1.nombre || "",
                                codigo: dup.producto1.codigo || "",
                                establecimiento: dup.producto1.establecimiento || "",
                                precio: dup.producto1.precio || 0,
                                ultima_actualizacion: dup.producto1.ultima_actualizacion || "",
                                veces_visto: dup.producto1.veces_visto || 0
                            },
                            producto2: {
                                id: dup.producto2.id,
                                nombre: dup.producto2.nombre || "",
                                codigo: dup.producto2.codigo || "",
                                establecimiento: dup.producto2.establecimiento || "",
                                precio: dup.producto2.precio || 0,
                                ultima_actualizacion: dup.producto2.ultima_actualizacion || "",
                                veces_visto: dup.producto2.veces_visto || 0
                            },
                            similitud: dup.similitud || 0,
                            criterios: {
                                mismo_codigo: dup.mismo_codigo || false,
                                mismo_establecimiento: dup.mismo_establecimiento || false,
                                nombre_similar: dup.nombre_similar || false
                            }
                        };
                    });
                    
                } else { // facturas
                    promptBase = `Por favor, analiza las siguientes facturas duplicadas y decide cuál mantener y cuál eliminar. Utiliza estos criterios de decisión:\n\n${configuracionIA.criteriosFacturas}\n\nBasa tu decisión en estos criterios y explica tu razonamiento. Para cada par de facturas, indica tu decisión como "Mantener #1" o "Mantener #2" y asigna un nivel de confianza de 0-100% a tu decisión.`;
                    
                    datosAnalisis = lote.map((dup, index) => {
                        return {
                            id: dup.id || index.toString(),
                            factura1: {
                                id: dup.factura1.id,
                                establecimiento: dup.factura1.establecimiento || "",
                                total: dup.factura1.total || 0,
                                fecha: dup.factura1.fecha || "",
                                num_productos: dup.factura1.num_productos || 0,
                                tieneImagen: dup.factura1.tieneImagen || false,
                                productos: dup.factura1.productos || []
                            },
                            factura2: {
                                id: dup.factura2.id,
                                establecimiento: dup.factura2.establecimiento || "",
                                total: dup.factura2.total || 0,
                                fecha: dup.factura2.fecha || "",
                                num_productos: dup.factura2.num_productos || 0,
                                tieneImagen: dup.factura2.tieneImagen || false,
                                productos: dup.factura2.productos || []
                            },
                            criterios: {
                                misma_fecha: dup.misma_fecha || false,
                                mismo_establecimiento: dup.mismo_establecimiento || false,
                                total_iguales: dup.total_iguales || false,
                                productos_iguales: dup.productos_iguales || false,
                                productos_similares: dup.productos_similares || false
                            }
                        };
                    });
                }
                
                // Prompt completo
                const promptCompleto = `${promptBase}\n\nLos datos a analizar son:\n${JSON.stringify(datosAnalisis, null, 2)}\n\nDa tu respuesta en formato JSON, con la siguiente estructura para cada elemento analizado:\n{\n  "dupId": "id_del_duplicado",\n  "decision": 1 o 2 (1 para mantener el primero, 2 para mantener el segundo),\n  "confianza": porcentaje de confianza (0-100),\n  "explicacion": "explicación detallada de la decisión"\n}\n\nDevuelve un array de estos objetos, uno para cada duplicado analizado.`;
                
                // Llamar a la API de Anthropic
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': configuracionIA.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: configuracionIA.modelo,
                        max_tokens: 4000,
                        temperature: 0.1,
                        messages: [
                            { role: "user", content: promptCompleto }
                        ]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error en API de Anthropic: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Extraer y procesar la respuesta
                const textoRespuesta = data.content[0].text;
                
                // Extraer el JSON de la respuesta
                const jsonMatch = textoRespuesta.match(/```json\s*([\s\S]*?)\s*```/) || 
                                 textoRespuesta.match(/\[\s*\{\s*"dupId"/);
                
                if (!jsonMatch) {
                    throw new Error('No se pudo encontrar una respuesta JSON válida');
                }
                
                const jsonContent = jsonMatch[1] || textoRespuesta;
                let resultados;
                
                try {
                    resultados = JSON.parse(jsonContent);
                    // Verificar que sea un array
                    if (!Array.isArray(resultados)) {
                        resultados = [resultados]; // Si es un objeto único, convertirlo en array
                    }
                } catch (e) {
                    console.error("Error parseando JSON:", e);
                    // Intentar limpiar el JSON y volver a parsear
                    const limpiado = jsonContent.replace(/[\r\n\t]/g, ' ').replace(/\s+/g, ' ').trim();
                    const match = limpiado.match(/\[.*\]/);
                    if (match) {
                        resultados = JSON.parse(match[0]);
                    } else {
                        throw new Error('No se pudo parsear la respuesta JSON');
                    }
                }
                
                // Procesar y filtrar por confianza mínima
                const resultadosFiltrados = resultados
                    .map(r => {
                        if (tipo === 'facturas') {
                            // Agregar IDs de facturas para facilitar procesamiento posterior
                            const dup = lote.find(d => d.id === r.dupId || lote.indexOf(d).toString() === r.dupId);
                            if (dup) {
                                r.factura1Id = dup.factura1.id;
                                r.factura2Id = dup.factura2.id;
                            }
                        }
                        return r;
                    })
                    .filter(r => r.confianza >= confianzaMinima);
                
                return resultadosFiltrados;
                
            } catch (error) {
                console.error(`Error en procesamiento IA de ${tipo}:`, error);
                mostrarToast(`Error en procesamiento IA: ${error.message}`, 'error');
                return [];
            }
        }
        
        // Función para mostrar resumen de resultados IA
        function mostrarResumenIA(tipo) {
            const resultados = tipo === 'productos' ? resultadosProductosIA : resultadosFacturasIA;
            
            if (resultados.length === 0) {
                mostrarToast('No hay resultados de IA para mostrar', 'error');
                return;
            }
            
            // Configurar modal de resultados
            document.getElementById('ia-resultados-titulo').textContent = `Análisis de ${tipo === 'productos' ? 'Productos' : 'Facturas'} Duplicados`;
            document.getElementById('ia-total-procesados').textContent = `${resultados.length} analizados`;
            
            // Contar decisiones con confianza alta
            const confianzaAlta = resultados.filter(r => r.confianza >= 85).length;
            document.getElementById('ia-total-decisiones').textContent = `${confianzaAlta} con alta confianza`;
            
            // Generar resumen
            let resumen = `<p>La IA ha analizado <strong>${resultados.length}</strong> duplicados de ${tipo}.</p>`;
            resumen += `<p>Se encontraron <strong>${confianzaAlta}</strong> duplicados con alta confianza en la decisión (≥85%).</p>`;
            
            // Estadísticas de decisiones
            const mantener1 = resultados.filter(r => r.decision === 1).length;
            const mantener2 = resultados.filter(r => r.decision === 2).length;
            
            resumen += `<p>Decisiones: Mantener elemento #1: <strong>${mantener1}</strong>, Mantener elemento #2: <strong>${mantener2}</strong></p>`;
            
            document.getElementById('ia-resultados-resumen').innerHTML = resumen;
            
            // Generar contenido detallado
            let contenidoHTML = '';
            
            // Ordenar resultados por confianza descendente
            const resultadosOrdenados = [...resultados].sort((a, b) => b.confianza - a.confianza);
            
            resultadosOrdenados.forEach((r, idx) => {
                const confianzaClase = r.confianza >= 85 ? 'success' : 
                                      r.confianza >= 70 ? 'warning' : 'danger';
                
                let itemDetalles = '';
                
                if (tipo === 'productos') {
                    // Buscar el duplicado para obtener los datos
                    const dup = productosDuplicados.find(d => d.id === r.dupId || productosDuplicados.indexOf(d).toString() === r.dupId);
                    if (dup) {
                        itemDetalles = `
                            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <div style="width: 48%;">
                                    <strong>#1: ${dup.producto1.nombre || ''}</strong><br>
                                    Código: ${dup.producto1.codigo || 'Sin código'}<br>
                                    Establecimiento: ${dup.producto1.establecimiento || '-'}
                                </div>
                                <div style="width: 48%;">
                                    <strong>#2: ${dup.producto2.nombre || ''}</strong><br>
                                    Código: ${dup.producto2.codigo || 'Sin código'}<br>
                                    Establecimiento: ${dup.producto2.establecimiento || '-'}
                                </div>
                            </div>
                        `;
                    }
                } else { // facturas
                    // Buscar el duplicado para obtener los datos
                    const dup = facturasDuplicadas.find(d => d.id === r.dupId || facturasDuplicadas.indexOf(d).toString() === r.dupId);
                    if (dup) {
                        itemDetalles = `
                            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <div style="width: 48%;">
                                    <strong>#1: Factura ${dup.factura1.id}</strong><br>
                                    Establecimiento: ${dup.factura1.establecimiento || '-'}<br>
                                    Fecha: ${dup.factura1.fecha ? new Date(dup.factura1.fecha).toLocaleDateString() : '-'}<br>
                                    Total: $${typeof dup.factura1.total === 'number' ? dup.factura1.total.toLocaleString() : dup.factura1.total || 'N/A'}
                                </div>
                                <div style="width: 48%;">
                                    <strong>#2: Factura ${dup.factura2.id}</strong><br>
                                    Establecimiento: ${dup.factura2.establecimiento || '-'}<br>
                                    Fecha: ${dup.factura2.fecha ? new Date(dup.factura2.fecha).toLocaleDateString() : '-'}<br>
                                    Total: $${typeof dup.factura2.total === 'number' ? dup.factura2.total.toLocaleString() : dup.factura2.total || 'N/A'}
                                </div>
                            </div>
                        `;
                    }
                }
                
                contenidoHTML += `
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="btn btn-sm ${r.decision === 1 ? 'btn-success' : 'btn-secondary'}" style="cursor: default;">
                                    #1 ${r.decision === 1 ? '✓' : ''}
                                </span>
                                <span class="btn btn-sm ${r.decision === 2 ? 'btn-success' : 'btn-secondary'}" style="cursor: default;">
                                    #2 ${r.decision === 2 ? '✓' : ''}
                                </span>
                            </div>
                            <span class="similarity-tag similarity-${confianzaClase}">Confianza: ${r.confianza}%</span>
                        </div>
                        
                        ${itemDetalles}
                        
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px;">
                            <strong>Explicación:</strong><br>
                            ${r.explicacion || 'Sin explicación disponible'}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('ia-resultados-contenido').innerHTML = contenidoHTML;
            
            // Mostrar modal
            document.getElementById('popup-resultados-ia').style.display = 'flex';
        }
        
        // Función para mostrar resultados y aplicar decisiones
        function guardarResultadosIA(tipo) {
            mostrarResumenIA(tipo);
        }
        
        // Función para aplicar decisiones de IA
        async function aplicarDecisionesIA() {
            const tipoActivo = document.querySelector('.tab.active').textContent.includes('Productos') ? 'productos' : 'facturas';
            const resultados = tipoActivo === 'productos' ? resultadosProductosIA : resultadosFacturasIA;
            
            // Filtrar solo resultados con alta confianza
            const confianzaMinima = tipoActivo === 'productos' ? 
                parseInt(document.getElementById('confianzaProductos').value) : 
                parseInt(document.getElementById('confianzaFacturas').value);
                
            const resultadosFiltrados = resultados.filter(r => r.confianza >= confianzaMinima);
            
            if (resultadosFiltrados.length === 0) {
                mostrarToast('No hay decisiones con suficiente confianza para aplicar', 'info');
                return;
            }
            
            // Confirmar antes de proceder
            if (!confirm(`Se aplicarán automáticamente ${resultadosFiltrados.length} decisiones de IA. ¿Continuar?`)) {
                return;
            }
            
            // Deshabilitar botón mientras se procesa
            document.getElementById('btn-aplicar-decisiones').disabled = true;
            document.getElementById('btn-aplicar-decisiones').textContent = 'Procesando...';
            
            try {
                let procesados = 0;
                
                for (const resultado of resultadosFiltrados) {
                    try {
                        if (tipoActivo === 'productos') {
                            // Buscar el duplicado
                            const duplicadoIndex = productosDuplicados.findIndex(d => 
                                d.id === resultado.dupId || productosDuplicados.indexOf(d).toString() === resultado.dupId
                            );
                            
                            if (duplicadoIndex === -1) continue; // No encontrado
                            
                            const duplicado = productosDuplicados[duplicadoIndex];
                            
                            // Determinar qué producto mantener
                            const productoMantener = resultado.decision === 1 ? duplicado.producto1 : duplicado.producto2;
                            const productoEliminar = resultado.decision === 1 ? duplicado.producto2 : duplicado.producto1;
                            
                            // Fusionar productos
                            const response = await fetch(`${API_URL}/admin/duplicados/productos/fusionar`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    producto_mantener_id: productoMantener.id,
                                    producto_eliminar_id: productoEliminar.id
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`Error HTTP: ${response.status}`);
                            }
                            
                            // Eliminar de la lista
                            productosDuplicados.splice(duplicadoIndex, 1);
                            
                            // Incrementar contador
                            procesados++;
                            
                        } else { // facturas
                            // Buscar el duplicado
                            const duplicadoIndex = facturasDuplicadas.findIndex(d => 
                                d.id === resultado.dupId || facturasDuplicadas.indexOf(d).toString() === resultado.dupId
                            );
                            
                            if (duplicadoIndex === -1) continue; // No encontrado
                            
                            const duplicado = facturasDuplicadas[duplicadoIndex];
                            
                            // Determinar qué factura eliminar
                            const facturaEliminarId = resultado.decision === 1 ? duplicado.factura2.id : duplicado.factura1.id;
                            
                            // Eliminar factura
                            const response = await fetch(`${API_URL}/admin/duplicados/facturas/${facturaEliminarId}`, {
                                method: 'DELETE'
                            });
                            
                            if (!response.ok) {
                                throw new Error(`Error HTTP: ${response.status}`);
                            }
                            
                            // Eliminar de la lista
                            facturasDuplicadas.splice(duplicadoIndex, 1);
                            
                            // Incrementar contador
                            procesados++;
                        }
                    } catch (err) {
                        console.error(`Error procesando decisión:`, err);
                        // Continuar con el siguiente
                    }
                }
                
                // Actualizar contadores
                if (tipoActivo === 'productos') {
                    totalFusiones += procesados;
                    document.getElementById('total-fusiones').textContent = totalFusiones;
                } else {
                    totalEliminaciones += procesados;
                    document.getElementById('total-eliminaciones').textContent = totalEliminaciones;
                }
                
                // Actualizar estadísticas
                if (tipoActivo === 'productos') {
                    document.getElementById('total-duplicados').textContent = productosDuplicados.length;
                    const porcentaje = productosDuplicados.length > 0 ? 
                        ((productosDuplicados.length / parseInt(document.getElementById('total-productos').textContent)) * 100).toFixed(1) + '%' : 
                        '0%';
                    document.getElementById('porcentaje-duplicados').textContent = porcentaje;
                    
                    // Limpiar resultados aplicados
                    resultadosProductosIA = resultadosProductosIA.filter(r => !resultadosFiltrados.includes(r));
                    
                    // Actualizar vista
                    renderizarPaginaProductos(1);
                } else {
                    document.getElementById('total-facturas-duplicadas').textContent = facturasDuplicadas.length;
                    const porcentaje = facturasDuplicadas.length > 0 ? 
                        ((facturasDuplicadas.length / parseInt(document.getElementById('total-facturas').textContent)) * 100).toFixed(1) + '%' : 
                        '0%';
                    document.getElementById('porcentaje-facturas-duplicadas').textContent = porcentaje;
                    
                    // Limpiar resultados aplicados
                    resultadosFacturasIA = resultadosFacturasIA.filter(r => !resultadosFiltrados.includes(r));
                    
                    // Actualizar vista
                    renderizarPaginaFacturas(1);
                }
                
                // Cerrar modal
                cerrarPopup('popup-resultados-ia');
                
                // Mostrar mensaje de éxito
                mostrarToast(`Se procesaron ${procesados} decisiones de IA correctamente`, 'success');
                
            } catch (error) {
                console.error('Error aplicando decisiones:', error);
                mostrarToast(`Error al aplicar decisiones: ${error.message}`, 'error');
            } finally {
                // Restaurar botón
                document.getElementById('btn-aplicar-decisiones').disabled = false;
                document.getElementById('btn-aplicar-decisiones').textContent = 'Aplicar Decisiones';
            }
        }
        
        function cancelarProcesamientoIA(tipo) {
            procesoIACancelado = true;
            mostrarToast(`Procesamiento de ${tipo} cancelado`, 'info');
        }
        </script>
    <script>

    // Configuración global
const API_URL = window.location.origin;
let productosDuplicados = [];
let facturasDuplicadas = [];
let paginaActualProductos = 1;
let paginaActualFacturas = 1;
const elementosPorPagina = 5;
let totalFusiones = 0;
let totalEliminaciones = 0;
let procesandoIA = false;
let procesoIACancelado = false;

// Resultados de IA
let resultadosProductosIA = [];
let resultadosFacturasIA = [];

// Configuración de IA
let configuracionIA = {
    apiKey: "", // Inicialmente vacío
    modelo: "claude-3-haiku-20240307",
    tamanoLote: 10,
    intervaloLote: 5, // segundos
    criteriosProductos: "",
    criteriosFacturas: ""
};

// MODO_DEMO desactivado - Trabajamos con datos reales
const MODO_DEMO = false;

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    verificarConexionAPI();
    cargarEstadisticas();
    cargarConfiguracionIA();
    obtenerAPIKey(); // Nueva función para obtener la API key del servidor
});

// Obtener API Key del servidor
async function obtenerAPIKey() {
    try {
        const response = await fetch(`${API_URL}/api/config/anthropic-key`);
        if (response.ok) {
            const data = await response.json();
            configuracionIA.apiKey = data.apiKey || "";
            // Actualizar el campo del formulario con asteriscos por seguridad
            document.getElementById('apiKey').value = configuracionIA.apiKey ? "********" : "";
        }
    } catch (error) {
        console.error('Error obteniendo API key:', error);
    }
}

// Verificar si la API está activa
async function verificarConexionAPI() {
    try {
        const response = await fetch(`${API_URL}/api/health-check`);
        if (!response.ok) {
            mostrarMensajeError('No se pudo conectar con la API. Algunas funciones pueden no estar disponibles.');
        }
    } catch (error) {
        console.error('Error verificando API:', error);
        mostrarMensajeError('Error de conexión con el servidor. Algunas funciones pueden no estar disponibles.');
    }
}

function mostrarMensajeError(mensaje) {
    const container = document.querySelector('.container');
    const alerta = document.createElement('div');
    alerta.style.background = '#fff3e0';
    alerta.style.border = '1px solid #ffb74d';
    alerta.style.borderRadius = '8px';
    alerta.style.padding = '15px';
    alerta.style.marginBottom = '20px';
    
    alerta.innerHTML = `
        <h3 style="margin-bottom: 10px; color: #e65100;">⚠️ Advertencia</h3>
        <p>${mensaje}</p>
    `;
    
    container.insertBefore(alerta, container.firstChild);
}

// Función para cambiar pestañas
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    if (tabName === 'productos') {
        detectarProductosDuplicados();
    } else if (tabName === 'facturas') {
        detectarFacturasDuplicadas();
    }
}

// Cargar estadísticas generales
async function cargarEstadisticas() {
    try {
        const response = await fetch(`${API_URL}/admin/stats`);
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        document.getElementById('total-productos').textContent = data.productos_unicos || 0;
        document.getElementById('total-facturas').textContent = data.total_facturas || 0;
        
    } catch (error) {
        console.error('Error cargando estadísticas:', error);
        mostrarToast('Error al cargar estadísticas: ' + error.message, 'error');
        
        // Usar datos de ejemplo si falla
        document.getElementById('total-productos').textContent = '358';
        document.getElementById('total-facturas').textContent = '124';
    }
}

// GESTIÓN DE PRODUCTOS DUPLICADOS
async function detectarProductosDuplicados() {
    const container = document.getElementById('productos-duplicados-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analizando duplicados de productos...</p></div>';
    
    try {
        const umbral = document.getElementById('umbralSimilitud').value;
        const criterio = document.getElementById('criteriosProductos').value;
        
        const url = `${API_URL}/admin/duplicados/productos?umbral=${umbral}&criterio=${criterio}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        productosDuplicados = data.duplicados || [];
        
        // Actualizar estadísticas
        document.getElementById('total-duplicados').textContent = data.total || 0;
        
        if (productosDuplicados.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No se encontraron productos duplicados</h3>
                    <p>Prueba con un umbral de similitud más bajo o diferentes criterios</p>
                </div>
            `;
            document.getElementById('productos-pagination').innerHTML = '';
            document.getElementById('productos-ia-panel').style.display = 'none';
            return;
        }

        // Verificar si el elemento existe antes de asignar
    const porcentajeElement = document.getElementById('porcentaje-duplicados');
    if (porcentajeElement) {
        porcentajeElement.textContent = porcentaje;
        }
        
        // Mostrar panel de IA
        document.getElementById('productos-ia-panel').style.display = 'block';
        
        // Renderizar la primera página
        renderizarPaginaProductos(1);
        
    } catch (error) {
        console.error('Error detectando duplicados de productos:', error);
        
        container.innerHTML = `
            <div style="padding: 20px; background: #ffebee; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #c62828; margin-bottom: 10px;">Error al buscar duplicados</h3>
                <p>${error.message || 'Error desconocido'}</p>
                <button class="btn btn-primary" onclick="detectarProductosDuplicados()" style="margin-top: 15px;">
                    Intentar nuevamente
                </button>
            </div>
        `;
        document.getElementById('productos-ia-panel').style.display = 'none';
    }
}

function renderizarPaginaProductos(pagina) {
    const container = document.getElementById('productos-duplicados-container');
    const paginacion = document.getElementById('productos-pagination');
    
    // Guardar la página actual
    paginaActualProductos = pagina;
    
    // Calcular índices para la paginación
    const inicio = (pagina - 1) * elementosPorPagina;
    const fin = Math.min(inicio + elementosPorPagina, productosDuplicados.length);
    const duplicadosPagina = productosDuplicados.slice(inicio, fin);
    
    let html = '';
    
    duplicadosPagina.forEach((dup, index) => {
        const similitudClase = dup.similitud >= 85 ? 'similarity-high' : 
                              dup.similitud >= 70 ? 'similarity-medium' : 'similarity-low';
        
        // Determinar criterios de similitud para mostrar etiquetas
        const criterios = [];
        if (dup.mismo_codigo) criterios.push('Mismo código');
        if (dup.mismo_establecimiento) criterios.push('Mismo establecimiento');
        if (dup.nombre_similar) criterios.push('Nombre similar');
        
        // Verificar si este duplicado ha sido procesado por IA
        const resultadoIA = resultadosProductosIA.find(r => r.dupId === dup.id || r.dupId === index.toString());
        const iaTag = resultadoIA ? 
            `<span class="criteria-tag" style="background: #e8f5e9; color: #2e7d32;">IA: ${resultadoIA.decision === 1 ? 'Mantener #1' : 'Mantener #2'} (${resultadoIA.confianza}%)</span>` : '';
        
        html += `
            <div id="duplicado-${dup.id || index}" class="duplicate-container">
                <div class="duplicate-header">
                    <div>
                        <span class="similarity-tag ${similitudClase}">Similitud: ${dup.similitud}%</span>
                        ${criterios.map(c => `<span class="criteria-tag">${c}</span>`).join('')}
                        ${iaTag}
                    </div>
                    <button class="btn btn-success btn-sm" onclick="fusionarProductos('${dup.id || index}')">
                        Fusionar Seleccionado
                    </button>
                </div>
                
                <div class="duplicate-grid">
                    <div id="producto-${dup.producto1.id}" class="duplicate-item" data-id="${dup.producto1.id}">
                        <div class="selection-mark ${resultadoIA && resultadoIA.decision === 1 ? 'selected' : (dup.seleccionado === dup.producto2.id ? 'not-selected' : 'selected')}">1</div>
                        
                        <div class="duplicate-metadata">
                            <h3>Producto #${dup.producto1.id}</h3>
                            <p style="margin-top: 5px; color: #666;">
                                <strong>Nombre:</strong> ${dup.producto1.nombre}<br>
                                <strong>Código:</strong> ${dup.producto1.codigo || 'Sin código'}<br>
                                <strong>Establecimiento:</strong> ${dup.producto1.establecimiento || 'Desconocido'}<br>
                                <strong>Precio actual:</strong> $${typeof dup.producto1.precio === 'number' ? dup.producto1.precio.toLocaleString() : dup.producto1.precio || 'N/A'}<br>
                                <strong>Última actualización:</strong> ${dup.producto1.ultima_actualizacion ? new Date(dup.producto1.ultima_actualizacion).toLocaleDateString() : 'N/A'}<br>
                                <strong>Visto:</strong> ${dup.producto1.veces_visto || 0} veces
                            </p>
                        </div>
                        
                        <button class="btn ${resultadoIA && resultadoIA.decision === 1 ? 'btn-primary' : (dup.seleccionado === dup.producto2.id ? 'btn-secondary' : 'btn-primary')} select-button" onclick="seleccionarProducto('${dup.id || index}', ${dup.producto1.id})">
                            ${resultadoIA && resultadoIA.decision === 1 ? '✓ Seleccionado por IA' : (dup.seleccionado === dup.producto2.id ? 'Seleccionar Este' : '✓ Seleccionar Este')}
                        </button>
                    </div>
                    
                    <div id="producto-${dup.producto2.id}" class="duplicate-item" data-id="${dup.producto2.id}">
                        <div class="selection-mark ${resultadoIA && resultadoIA.decision === 2 ? 'selected' : (dup.seleccionado === dup.producto2.id ? 'selected' : 'not-selected')}">2</div>
                        
                        <div class="duplicate-metadata">
                            <h3>Producto #${dup.producto2.id}</h3>
                            <p style="margin-top: 5px; color: #666;">
                                <strong>Nombre:</strong> ${dup.producto2.nombre}<br>
                                <strong>Código:</strong> ${dup.producto2.codigo || 'Sin código'}<br>
                                <strong>Establecimiento:</strong> ${dup.producto2.establecimiento || 'Desconocido'}<br>
                                <strong>Precio actual:</strong> ${typeof dup.producto2.precio === 'number' ? dup.producto2.precio.toLocaleString() : dup.producto2.precio || 'N/A'}<br>
                                <strong>Última actualización:</strong> ${dup.producto2.ultima_actualizacion ? new Date(dup.producto2.ultima_actualizacion).toLocaleDateString() : 'N/A'}<br>
                                <strong>Visto:</strong> ${dup.producto2.veces_visto || 0} veces
}
 </script>                           
</body>
</html>
