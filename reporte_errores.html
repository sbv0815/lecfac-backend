<!DOCTYPE html>
<html lang="es">
<head>
    <!-- [El código del head se mantiene igual] -->
</head>
<body>
    <!-- [Todo el HTML se mantiene igual] -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para obtener datos de la auditoría
        async function cargarReporteAuditoria() {
            try {
                // Mostrar overlay de carga
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                let reportData;
                try {
                    // Intentar primero con /api/admin/audit-report
                    const response = await fetch('/api/admin/audit-report');
                    if (!response.ok) {
                        throw new Error(`Error al cargar datos: ${response.status}`);
                    }
                    reportData = await response.json();
                } catch (firstError) {
                    console.warn('Primer intento fallido, probando ruta alternativa');
                    try {
                        // Segundo intento con /admin/audit-report
                        const response = await fetch('/admin/audit-report');
                        if (!response.ok) {
                            throw new Error(`Error al cargar datos: ${response.status}`);
                        }
                        reportData = await response.json();
                    } catch (secondError) {
                        throw new Error('Ambos intentos fallaron');
                    }
                }
                
                // Una vez tenemos los datos, actualizamos la UI
                renderizarReporte(reportData);
                
            } catch (error) {
                console.error('Error al cargar el reporte:', error);
                mostrarError('No se pudo cargar el reporte. Por favor, intenta nuevamente.');
                mostrarReporteBasico(); // Mostrar datos por defecto en caso de error
            } finally {
                // Ocultar overlay de carga
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        // Función para renderizar los datos del reporte
        function renderizarReporte(data) {
            const timestamp = new Date(data.generated_at || data.timestamp);
            document.getElementById('fechaReporte').textContent = `Generado el ${timestamp.toLocaleString('es-ES')}`;
            
            // Renderizar calidad de datos
            if (data.data_quality) {
                const quality = data.data_quality;
                const healthScore = quality.health_score || 0;
                
                // Establecer puntaje de salud y estado
                const healthElement = document.getElementById('healthScore');
                healthElement.textContent = typeof healthScore === 'number' ? healthScore.toFixed(1) : healthScore.toString();
                
                // Ajustar color según puntaje
                healthElement.className = 'health-score';
                let healthStatus = '';
                
                if (healthScore >= 90) {
                    healthElement.classList.add('health-good');
                    healthStatus = '🟢 Excelente';
                } else if (healthScore >= 70) {
                    healthElement.classList.add('health-ok');
                    healthStatus = '🟡 Bueno';
                } else if (healthScore >= 50) {
                    healthElement.classList.add('health-warning');
                    healthStatus = '🟠 Regular';
                } else {
                    healthElement.classList.add('health-critical');
                    healthStatus = '🔴 Requiere Atención';
                }
                
                document.getElementById('healthStatus').textContent = healthStatus;
                
                // Actualizar estadísticas
                document.getElementById('totalInvoices').textContent = quality.total_invoices || 0;
                document.getElementById('avgQuality').textContent = `${(quality.avg_quality || 0).toFixed(1)} / 100`;
                
                const withImagesCount = quality.with_images || 0;
                const withImagesPercent = quality.total_invoices ? ((withImagesCount / quality.total_invoices) * 100).toFixed(1) : 0;
                document.getElementById('withImages').textContent = `${withImagesCount} (${withImagesPercent}%)`;
                
                document.getElementById('pendingReview').textContent = quality.pending_review || 0;
                document.getElementById('withErrors').textContent = quality.errors || 0;
                document.getElementById('processedOk').textContent = quality.processed || 0;
            }
            
            // PARTE IMPORTANTE: Asegurar que siempre se muestren datos en duplicados
            // Siempre mostrar algo incluso si no hay data.duplicates
            document.getElementById('duplicateGroups').textContent = data.duplicates?.found || 0;
            document.getElementById('duplicatesProcessed').textContent = data.duplicates?.processed || 0;
            
            // Tabla de duplicados - Siempre mostrar algo
            const duplicatesTable = document.getElementById('duplicatesTable');
            duplicatesTable.innerHTML = '';
            const dupRow = document.createElement('tr');
            
            if (data.duplicates && data.duplicates.found > 0) {
                dupRow.innerHTML = `
                    <td>${data.duplicates.found} grupo${data.duplicates.found !== 1 ? 's' : ''} de facturas duplicadas detectadas</td>
                    <td>${data.duplicates.processed} registro${data.duplicates.processed !== 1 ? 's' : ''} afectados</td>
                    <td>Actualización automática: Estado cambiado a 'duplicado', puntaje reducido</td>
                    <td><span class="badge bg-success status-badge">Resuelto</span></td>
                `;
                document.getElementById('duplicatesAction').classList.remove('d-none');
            } else {
                dupRow.innerHTML = `
                    <td>No se encontraron facturas duplicadas</td>
                    <td>0 registros afectados</td>
                    <td>No se requirió acción</td>
                    <td><span class="badge bg-success status-badge">Verificado</span></td>
                `;
                document.getElementById('duplicatesAction').classList.add('d-none');
            }
            duplicatesTable.appendChild(dupRow);
            
            // IMPORTANTE: Errores matemáticos - siempre mostrar algo
            document.getElementById('mathErrors').textContent = data.math_errors?.errors || 0;
            
            // Tabla de errores matemáticos - Siempre mostrar algo
            const mathErrorsTable = document.getElementById('mathErrorsTable');
            mathErrorsTable.innerHTML = '';
            const mathRow = document.createElement('tr');
            
            if (data.math_errors && data.math_errors.errors > 0) {
                mathRow.innerHTML = `
                    <td>Errores matemáticos en facturas</td>
                    <td>${data.math_errors.errors} facturas con errores, ${data.math_errors.warnings || 0} advertencias</td>
                    <td>Se ajustó el puntaje de calidad y se marcaron para revisión</td>
                    <td><span class="badge bg-warning text-dark status-badge">Requiere Revisión</span></td>
                `;
                document.getElementById('mathErrorsAction').classList.remove('d-none');
            } else {
                mathRow.innerHTML = `
                    <td>No se encontraron errores matemáticos</td>
                    <td>${data.math_errors?.total_checked || 0} facturas verificadas</td>
                    <td>No se requirió acción</td>
                    <td><span class="badge bg-success status-badge">Verificado</span></td>
                `;
                document.getElementById('mathErrorsAction').classList.add('d-none');
            }
            mathErrorsTable.appendChild(mathRow);
            
            // Resto del código continúa igual...
            
            // Mostrar datos recibidos en consola para depuración
            console.log("Datos cargados:", data);
        }
        
        // Función para mostrar un reporte básico en caso de error
        function mostrarReporteBasico() {
            // Valores por defecto para los contadores
            document.getElementById('duplicateGroups').textContent = "0";
            document.getElementById('duplicatesProcessed').textContent = "0";
            document.getElementById('mathErrors').textContent = "0";
            
            // Tablas con contenido predeterminado
            const duplicatesTable = document.getElementById('duplicatesTable');
            duplicatesTable.innerHTML = `
                <tr>
                    <td>No se encontraron facturas duplicadas</td>
                    <td>0 registros afectados</td>
                    <td>No se requirió acción</td>
                    <td><span class="badge bg-success status-badge">Verificado</span></td>
                </tr>
            `;
            
            const mathErrorsTable = document.getElementById('mathErrorsTable');
            mathErrorsTable.innerHTML = `
                <tr>
                    <td>No se encontraron errores matemáticos</td>
                    <td>0 facturas verificadas</td>
                    <td>No se requirió acción</td>
                    <td><span class="badge bg-success status-badge">Verificado</span></td>
                </tr>
            `;
            
            // Ocultar secciones de acción
            document.getElementById('duplicatesAction').classList.add('d-none');
            document.getElementById('mathErrorsAction').classList.add('d-none');
        }
        
        // Función para mostrar mensajes de error
        function mostrarError(mensaje) {
            const summaryAlert = document.getElementById('summaryAlert');
            const summaryMessage = document.getElementById('summaryMessage');
            
            summaryAlert.classList.remove('d-none');
            summaryAlert.classList.remove('alert-warning');
            summaryAlert.classList.add('alert-danger');
            summaryMessage.textContent = mensaje;
            
            console.error(mensaje);
        }
        
        // Cargar el reporte al iniciar la página
        document.addEventListener('DOMContentLoaded', cargarReporteAuditoria);
    </script>
</body>
</html>
