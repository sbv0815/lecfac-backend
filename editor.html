<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Factura - LecFac</title>
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        height: 100vh;
        overflow: hidden;
    }
    
    .editor-container {
        display: grid;
        grid-template-columns: 55% 45%;
        height: 100vh;
        position: relative;
    }
    
    /* Divisor redimensionable */
    .resize-handle {
        position: absolute;
        left: 55%;
        top: 0;
        bottom: 0;
        width: 8px;
        background: #ddd;
        cursor: col-resize;
        z-index: 1000;
        transition: background 0.2s;
    }
    
    .resize-handle:hover {
        background: #1a73e8;
    }
    
    /* Panel izquierdo: Imagen CON SCROLL */
    .image-panel {
        background: #1a1a1a;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .image-controls {
        background: #2d2d2d;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        border-bottom: 1px solid #444;
        flex-shrink: 0;
    }
    
    .image-controls button {
        background: #4a4a4a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .image-controls button:hover { background: #5a5a5a; }
    
    .zoom-info {
        color: #aaa;
        margin-left: auto;
        font-size: 14px;
    }
    
    /* CAMBIO CLAVE: Hacer el contenedor scrolleable */
    .image-container {
        flex: 1;
        overflow: auto;  /* ← Permite scroll vertical y horizontal */
        background: #1a1a1a;
        padding: 20px;
    }
    
    .image-container img {
        display: block;
        max-width: none;
        width: auto;
        height: auto;
        cursor: grab;
        transition: transform 0.1s;
    }
    
    .image-container:active img {
        cursor: grabbing;
    }
    
    /* Panel derecho: Formulario CON MEJOR SCROLL */
    .form-panel {
        background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .form-header {
        background: #1a73e8;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .validation-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .badge-validada { background: #34a853; }
    .badge-revision_requerida { background: #fbbc04; color: #000; }
    .badge-pendiente { background: #ea4335; }
    
    /* CAMBIO: Mejorar el scroll del formulario */
    .form-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        /* Scroll suave */
        scroll-behavior: smooth;
    }
    
    /* Personalizar scrollbar */
    .form-content::-webkit-scrollbar,
    .image-container::-webkit-scrollbar {
        width: 12px;
    }
    
    .form-content::-webkit-scrollbar-track,
    .image-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .form-content::-webkit-scrollbar-thumb,
    .image-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }
    
    .form-content::-webkit-scrollbar-thumb:hover,
    .image-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .form-section {
        margin-bottom: 25px;
    }
    
    .form-section h3 {
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
        position: sticky;
        top: 0;
        background: white;
        padding: 10px 0;
        z-index: 10;
    }
    
    .field-group {
        margin-bottom: 15px;
    }
    
    .field-group label {
        display: block;
        font-size: 13px;
        color: #333;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .field-group input {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .field-group input:focus {
        outline: none;
        border-color: #1a73e8;
    }
    
    /* Tabla de productos */
    .productos-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 10px;
    }
    
    .productos-table thead {
        position: sticky;
        top: 40px;  /* Después del h3 sticky */
        background: white;
        z-index: 9;
    }
    
    .productos-table th {
        background: #f5f5f5;
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        color: #666;
        border-bottom: 2px solid #ddd;
    }
    
    .productos-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .productos-table input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .productos-table input:focus {
        outline: none;
        border-color: #1a73e8;
    }
    
    .btn-delete {
        background: #ea4335;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-delete:hover { background: #d33; }
    
    .btn-add {
        background: #34a853;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
    }
    
    .btn-add:hover { background: #2d9148; }
    
    .form-actions {
        padding: 20px;
        background: #f9f9f9;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
        flex-shrink: 0;
    }
    
    .btn-primary {
        flex: 1;
        background: #1a73e8;
        color: white;
        border: none;
        padding: 14px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .btn-primary:hover { background: #1557b0; }
    
    .btn-secondary {
        background: #5f6368;
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: 6px;
        cursor: pointer;
    }
    
    .btn-secondary:hover { background: #3c4043; }
    
    .loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1a73e8;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #34a853;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
        from { transform: translateX(400px); }
        to { transform: translateX(0); }
    }

    /* Mensaje de error para imagen */
    .image-error {
        color: white;
        text-align: center;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    /* Estilos para la sección de debug */
    .debug-section {
        margin-top: 20px;
        border-top: 1px dashed #ccc;
        padding-top: 20px;
    }
    
    .debug-toggle {
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        width: 100%;
        text-align: left;
    }
    
    .debug-content {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        overflow: auto;
        max-height: 200px;
    }
</style>
</head>
<body>
    <div class="editor-container">
    <div class="resize-handle" id="resizeHandle"></div>
    
    <!-- Panel de imagen -->
    <div class="image-panel">
        <div class="image-controls">
            <button onclick="zoomIn()">+</button>
            <button onclick="zoomOut()">-</button>
            <button onclick="resetZoom()">Reset</button>
            <button onclick="rotateImage()">Rotar</button>
            <span class="zoom-info" id="zoomInfo">100%</span>
        </div>
        <div class="image-container" id="imageContainer">
            <img id="facturaImage" src="" alt="Factura">
        </div>
    </div>
        
        <!-- Panel de formulario -->
        <div class="form-panel">
            <div class="form-header">
                <div>
                    <h2>Factura #<span id="facturaId">-</span></h2>
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                        Puntaje: <span id="puntaje">-</span>/100
                    </div>
                </div>
                <span class="validation-badge" id="estadoBadge">Pendiente</span>
            </div>
            
            <div class="form-content">
                <!-- Datos generales -->
                <div class="form-section">
                    <h3>Datos Generales</h3>
                    <div class="field-group">
                        <label>Establecimiento</label>
                        <input type="text" id="establecimiento" placeholder="Ej: Jumbo Bulevar">
                    </div>
                    <div class="field-group">
                        <label>Total ($)</label>
                        <input type="number" id="total" step="0.01">
                    </div>
                    <div class="field-group">
                        <label>Fecha</label>
                        <input type="date" id="fecha">
                    </div>
                </div>
                
                <!-- Productos -->
                <div class="form-section">
                    <h3>Productos (<span id="productosCount">0</span>)</h3>
                    <table class="productos-table">
                        <thead>
                            <tr>
                                <th style="width: 25%">Código</th>
                                <th style="width: 40%">Nombre</th>
                                <th style="width: 20%">Precio</th>
                                <th style="width: 15%"></th>
                            </tr>
                        </thead>
                        <tbody id="productosBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="agregarProducto()">+ Agregar Producto</button>
                </div>

                <!-- Sección de debug -->
                <div class="debug-section">
                    <button class="debug-toggle" onclick="toggleDebugInfo()">Mostrar/Ocultar Datos Crudos (Debug)</button>
                    <pre class="debug-content" id="debugInfo"></pre>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn-secondary" onclick="window.close()">Cerrar</button>
                <button class="btn-primary" onclick="guardarCambios()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://lecfac-api.onrender.com';
        const facturaId = new URLSearchParams(window.location.search).get('id');
        
        let zoomLevel = 1;
        let rotation = 0;
        let productos = [];
        let productosOriginales = [];
        let facturaOriginal = null; // Para debug

        // Redimensionar paneles
        let isResizing = false;
        const resizeHandle = document.getElementById('resizeHandle');
        const editorContainer = document.querySelector('.editor-container');

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const containerWidth = editorContainer.offsetWidth;
            const leftWidth = (e.clientX / containerWidth) * 100;
            
            if (leftWidth > 30 && leftWidth < 70) {
                editorContainer.style.gridTemplateColumns = `${leftWidth}% ${100 - leftWidth}%`;
                resizeHandle.style.left = `${leftWidth}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
            }
        });

        // Funciones para la tabla de productos
        function renderProductos() {
            const tbody = document.getElementById('productosBody');
            tbody.innerHTML = '';
            
            productos.forEach((prod, index) => {
                const row = tbody.insertRow();
                
                // Asegurarse de que los valores no sean undefined o null
                const codigo = prod.codigo || '';
                const nombre = prod.nombre || '';
                const precio = prod.precio || 0;
                
                row.innerHTML = `
                    <td><input type="text" value="${codigo}" onchange="actualizarProducto(${index}, 'codigo', this.value)"></td>
                    <td><input type="text" value="${nombre}" onchange="actualizarProducto(${index}, 'nombre', this.value)"></td>
                    <td><input type="number" step="0.01" value="${precio}" onchange="actualizarProducto(${index}, 'precio', parseFloat(this.value) || 0)"></td>
                    <td><button class="btn-delete" onclick="eliminarProducto(${index})">×</button></td>
                `;
            });
            
            document.getElementById('productosCount').textContent = productos.length;
        }
        
        function actualizarProducto(index, campo, valor) {
            if (index >= 0 && index < productos.length) {
                productos[index][campo] = valor;
                console.log(`Producto ${index}, campo ${campo} actualizado a:`, valor);
            }
        }
        
        function agregarProducto() {
            productos.push({ 
                codigo: '', 
                nombre: '', 
                precio: 0, 
                nuevo: true 
            });
            
            renderProductos();
            
            // Enfocar en el nuevo producto
            const tbody = document.getElementById('productosBody');
            const lastRow = tbody.lastElementChild;
            if (lastRow) {
                lastRow.querySelector('input').focus();
            }
        }
        
        async function eliminarProducto(index) {
            if (!confirm('¿Eliminar este producto?')) return;
            
            const prod = productos[index];
            
            if (!prod.nuevo && prod.id) {
                try {
                    await fetch(`${API_URL}/admin/productos/${prod.id}`, { method: 'DELETE' });
                } catch (e) {
                    console.error('Error eliminando:', e);
                }
            }
            
            productos.splice(index, 1);
            renderProductos();
        }
        
        // Funciones para la UI
        function showLoading() {
            const overlay = document.createElement('div');
            overlay.className = 'loading';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = '<div class="spinner"></div>';
            document.body.appendChild(overlay);
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Toggle debug info
        function toggleDebugInfo() {
            const debugContent = document.getElementById('debugInfo');
            debugContent.style.display = debugContent.style.display === 'block' ? 'none' : 'block';
        }
        
        // Controles de zoom
        function zoomIn() {
            zoomLevel *= 1.2;
            updateZoom();
        }
        
        function zoomOut() {
            zoomLevel /= 1.2;
            updateZoom();
        }
        
        function resetZoom() {
            zoomLevel = 1;
            rotation = 0;
            updateZoom();
        }
        
        function rotateImage() {
            rotation = (rotation + 90) % 360;
            updateZoom();
        }
        
        function updateZoom() {
            const img = document.getElementById('facturaImage');
            img.style.transform = `scale(${zoomLevel}) rotate(${rotation}deg)`;
            document.getElementById('zoomInfo').textContent = Math.round(zoomLevel * 100) + '%';
        }
        
        // Pan de imagen
        let isPanning = false;
        let startX, startY, scrollLeft, scrollTop;
        
        const imageContainer = document.getElementById('imageContainer');
        imageContainer.addEventListener('mousedown', (e) => {
            isPanning = true;
            startX = e.pageX - imageContainer.offsetLeft;
            startY = e.pageY - imageContainer.offsetTop;
            scrollLeft = imageContainer.scrollLeft;
            scrollTop = imageContainer.scrollTop;
        });
        
        imageContainer.addEventListener('mouseleave', () => isPanning = false);
        imageContainer.addEventListener('mouseup', () => isPanning = false);
        
        imageContainer.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault();
            const x = e.pageX - imageContainer.offsetLeft;
            const y = e.pageY - imageContainer.offsetTop;
            imageContainer.scrollLeft = scrollLeft - (x - startX);
            imageContainer.scrollTop = scrollTop - (y - startY);
        });
        
        // Implementación de cargarFactura
        async function cargarFactura() {
            console.log('Iniciando carga de factura ID:', facturaId);
            
            if (!facturaId) {
                alert('Error: No se especificó ID de factura');
                return;
            }

            showLoading();
            
            try {
                // 1. Cargar datos de la factura
                console.log(`Cargando factura ${facturaId}...`);
                
                const response = await fetch(`${API_URL}/admin/facturas/${facturaId}`);
                console.log('Status de respuesta:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Error de servidor: ${response.status} ${response.statusText}`);
                }
                
                const factura = await response.json();
                console.log('Datos de factura recibidos:', factura);
                
                // Guardar para debug
                facturaOriginal = factura;
                document.getElementById('debugInfo').textContent = JSON.stringify(factura, null, 2);
                
                // 2. Mostrar datos generales
                document.getElementById('facturaId').textContent = factura.id || '-';
                document.getElementById('establecimiento').value = factura.establecimiento || '';
                document.getElementById('total').value = factura.total || factura.total_factura || 0;
                
                // Fecha (si está disponible)
                if (factura.fecha) {
                    // Asegurarse de que la fecha esté en formato YYYY-MM-DD para el input date
                    let fechaStr = factura.fecha;
                    if (typeof fechaStr === 'string' && !fechaStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        // Intentar convertir otros formatos al formato requerido
                        const fecha = new Date(fechaStr);
                        if (!isNaN(fecha.getTime())) {
                            fechaStr = fecha.toISOString().split('T')[0];
                        }
                    }
                    document.getElementById('fecha').value = fechaStr;
                }
                
                // Estado de validación
                const estadoBadge = document.getElementById('estadoBadge');
                estadoBadge.textContent = factura.estado || 'Pendiente';
                estadoBadge.className = 'validation-badge badge-' + (factura.estado || 'pendiente').toLowerCase().replace(' ', '_');
                
                // Puntaje si existe
                if (factura.puntaje !== undefined) {
                    document.getElementById('puntaje').textContent = factura.puntaje;
                }
                
                // 3. Cargar productos
                if (factura.productos && Array.isArray(factura.productos)) {
                    console.log('Productos encontrados:', factura.productos.length);
                    
                    productos = factura.productos.map(p => ({
                        id: p.id,
                        codigo: p.codigo || p.codigo_ean || p.codigo_local || '',
                        nombre: p.nombre || p.descripcion || '',
                        precio: parseFloat(p.precio) || parseFloat(p.valor) || 0,
                        nuevo: false
                    }));
                    
                    productosOriginales = JSON.parse(JSON.stringify(productos));
                    renderProductos();
                } else {
                    console.warn('No se encontraron productos o el formato es inválido');
                    productos = [];
                    renderProductos();
                }
                
                // 4. Cargar imagen
                console.log('Intentando cargar imagen...');
                await cargarImagen();
                
            } catch (error) {
                console.error('Error cargando factura:', error);
                alert(`Error al cargar la factura: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Función para cargar imagen
        async function cargarImagen() {
            const img = document.getElementById('facturaImage');
            const container = document.getElementById('imageContainer');
            
            try {
                // Intentar cargar directamente la imagen
                console.log('Cargando imagen de factura...');
                img.style.display = 'none'; // Ocultar mientras carga
                
                // Añadir timestamp para evitar caché
                const timestamp = Date.now();
                img.src = `${API_URL}/admin/facturas/${facturaId}/imagen?t=${timestamp}`;
                
                img.onload = () => {
                    console.log('Imagen cargada correctamente');
                    img.style.display = 'block';
                    resetZoom(); // Asegurar que se vea correctamente
                };
                
                img.onerror = () => {
                    console.error('Error cargando imagen');
                    mostrarErrorImagen('No se pudo cargar la imagen de la factura');
                };
            } catch (error) {
                console.error('Error en cargarImagen:', error);
                mostrarErrorImagen(`Error: ${error.message}`);
            }
        }

        // Función para mostrar error de imagen y opción para subir
        function mostrarErrorImagen(mensaje) {
            const container = document.getElementById('imageContainer');
            
            // Limpiar contenido actual
            container.innerHTML = '';
            
            // Crear mensaje de error
            const errorDiv = document.createElement('div');
            errorDiv.style.color = '#fff';
            errorDiv.style.textAlign = 'center';
            errorDiv.style.padding = '30px';
            errorDiv.style.display = 'flex';
            errorDiv.style.flexDirection = 'column';
            errorDiv.style.alignItems = 'center';
            errorDiv.style.justifyContent = 'center';
            errorDiv.style.height = '100%';
            
            errorDiv.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 20px;">${mensaje}</div>
                <button id="btnSubirImagen" style="background: #4a4a4a; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    Subir imagen
                </button>
            `;
            
            container.appendChild(errorDiv);
            
            // Agregar funcionalidad al botón
            document.getElementById('btnSubirImagen').addEventListener('click', subirImagen);
        }

        // Función para subir una nueva imagen
        function subirImagen() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                if (!e.target.files || !e.target.files[0]) return;
                
                const file = e.target.files[0];
                showLoading();
                
                try {
                    const formData = new FormData();
                    formData.append('imagen', file);
                    
                    console.log('Subiendo imagen...');
                    const response = await fetch(`${API_URL}/admin/facturas/${facturaId}/subir-imagen`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    
                    showToast('Imagen subida correctamente');
                    setTimeout(() => cargarImagen(), 1000);
                } catch (error) {
                    console.error('Error subiendo imagen:', error);
                    alert(`Error al subir imagen: ${error.message}`);
                } finally {
                    hideLoading();
                }
            };
            
            input.click();
        }

        // Función para guardar cambios
        async function guardarCambios() {
            showLoading();
            
            try {
                console.log('Guardando cambios...');
                
                // 1. Guardar datos generales
                const fechaValue = document.getElementById('fecha').value;
                
                await fetch(`${API_URL}/admin/facturas/${facturaId}/datos-generales`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        establecimiento: document.getElementById('establecimiento').value,
                        total: parseFloat(document.getElementById('total').value) || 0,
                        fecha: fechaValue || undefined
                    })
                });
                
                // 2. Actualizar productos existentes
                for (const prod of productos) {
                    if (!prod.nuevo && prod.id) {
                        console.log('Actualizando producto:', prod);
                        await fetch(`${API_URL}/admin/productos/${prod.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(prod)
                        });
                    }
                }
                
                // 3. Agregar productos nuevos
                for (const prod of productos) {
                    if (prod.nuevo && prod.codigo && prod.nombre) {
                        console.log('Creando nuevo producto:', prod);
                        await fetch(`${API_URL}/admin/facturas/${facturaId}/productos`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(prod)
                        });
                    }
                }
                
                showToast('Cambios guardados exitosamente');
                setTimeout(() => cargarFactura(), 1500);
            } catch (error) {
                console.error('Error guardando cambios:', error);
                alert(`Error al guardar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // Atajos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                guardarCambios();
            }
        });

        // Iniciar carga al cargar la página
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Página cargada, iniciando cargarFactura()');
            cargarFactura();
        });
    </script>
</body>
</html>
