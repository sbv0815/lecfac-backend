<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Version: 2025-10-28-v2 - Fix precios en pesos -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Factura - LecFac</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 55% 45%;
            height: 100vh;
            position: relative;
        }

        .resize-handle {
            position: absolute;
            left: 55%;
            top: 0;
            bottom: 0;
            width: 8px;
            background: #ddd;
            cursor: col-resize;
            z-index: 1000;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: #1a73e8;
        }

        .image-panel {
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .image-controls {
            background: #2d2d2d;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }

        .image-controls button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .image-controls button:hover {
            background: #5a5a5a;
        }

        .zoom-info {
            color: #aaa;
            margin-left: auto;
            font-size: 14px;
        }

        .image-container {
            flex: 1;
            overflow: auto;
            background: #1a1a1a;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-container img {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: grab;
            transition: transform 0.1s;
        }

        .image-container:active img {
            cursor: grabbing;
        }

        .no-image-message {
            color: white;
            text-align: center;
            padding: 40px;
        }

        .no-image-message .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .no-image-message h3 {
            margin-bottom: 10px;
            font-size: 24px;
        }

        .no-image-message p {
            color: #999;
            font-size: 14px;
        }

        .form-panel {
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .form-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .form-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .validation-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .form-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
            color: #202124;
        }

        .field-group {
            margin-bottom: 16px;
        }

        .field-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: #5f6368;
        }

        .field-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
        }

        .field-group input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .productos-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .productos-table thead {
            background: #e8eaed;
        }

        .productos-table th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #5f6368;
        }

        .productos-table td {
            padding: 8px;
            border-bottom: 1px solid #e8eaed;
        }

        .productos-table td input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 13px;
        }

        .btn-add-producto {
            background: #34a853;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            width: 100%;
        }

        .btn-add-producto:hover {
            background: #2d9348;
        }

        .btn-delete {
            background: #ea4335;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .btn-delete:hover {
            background: #d33828;
        }

        .form-actions {
            padding: 20px 24px;
            background: white;
            border-top: 1px solid #e8eaed;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        .btn-secondary {
            background: #5f6368;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #3c4043;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #34a853;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }

            to {
                transform: translateX(0);
            }
        }

        .debug-section {
            margin-top: 20px;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
        }

        .debug-toggle {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            width: 100%;
            text-align: left;
        }

        .debug-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow: auto;
            max-height: 200px;
        }
    </style>
</head>

<body>
    <div class="editor-container">
        <div class="resize-handle" id="resizeHandle"></div>

        <div class="image-panel">
            <div class="image-controls">
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomOut()">-</button>
                <button onclick="resetZoom()">Reset</button>
                <button onclick="rotateImage()">Rotar</button>
                <span class="zoom-info" id="zoomInfo">100%</span>
            </div>
            <div class="image-container" id="imageContainer">
                <img id="facturaImage" src="" alt="Factura" style="display:none;">
            </div>
        </div>

        <div class="form-panel">
            <div class="form-header">
                <div>
                    <h2>Factura #<span id="facturaIdDisplay">-</span></h2>
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                        Puntaje: <span id="puntaje">-</span>/100
                    </div>
                </div>
                <span class="validation-badge" id="estadoBadge">Pendiente</span>
            </div>

            <div class="form-content">
                <div class="form-section">
                    <h3>Datos Generales</h3>
                    <div class="field-group">
                        <label>Establecimiento</label>
                        <input type="text" id="establecimiento" placeholder="Ej: Jumbo Bulevar">
                    </div>
                    <div class="field-group">
                        <label>Total ($)</label>
                        <input type="number" id="total" step="0.01" placeholder="0.00">
                    </div>
                    <div class="field-group">
                        <label>Fecha</label>
                        <input type="date" id="fecha">
                    </div>
                </div>

                <div class="form-section">
                    <h3>Productos (<span id="productosCount">0</span>)</h3>
                    <table class="productos-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Código</th>
                                <th style="width: 45%;">Nombre</th>
                                <th style="width: 25%;">Precio</th>
                                <th style="width: 10%;"></th>
                            </tr>
                        </thead>
                        <tbody id="productosBody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px; color: #999;">
                                    Cargando...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn-add-producto" onclick="agregarProducto()">+ Agregar Producto</button>
                </div>

                <div class="form-section debug-section">
                    <button class="debug-toggle" onclick="toggleDebugInfo()">
                        🔍 Mostrar/Ocultar Datos Crudos (Debug)
                    </button>
                    <pre class="debug-content" id="debugInfo">Cargando...</pre>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="window.close()">Cerrar</button>
                <button class="btn-primary" onclick="guardarCambios()">💾 Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin; // API URL dinámica
        const facturaId = new URLSearchParams(window.location.search).get('id');

        if (!facturaId) {
            alert('⚠️ No se especificó ID de factura.\n\nUso: /editor.html?id=123');
            window.location.href = '/';
        }
        let zoomLevel = 1;
        let rotation = 0;
        let productos = [];
        let facturaOriginal = null;

        let isResizing = false;
        const resizeHandle = document.getElementById('resizeHandle');
        const editorContainer = document.querySelector('.editor-container');

        // ========================================
        // RESIZE PANEL
        // ========================================
        resizeHandle.addEventListener('mousedown', () => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const containerWidth = editorContainer.offsetWidth;
            const leftWidth = (e.clientX / containerWidth) * 100;

            if (leftWidth > 30 && leftWidth < 70) {
                editorContainer.style.gridTemplateColumns = `${leftWidth}% ${100 - leftWidth}%`;
                resizeHandle.style.left = `${leftWidth}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
            }
        });

        // ========================================
        // UI HELPERS
        // ========================================
        function showLoading() {
            const overlay = document.createElement('div');
            overlay.className = 'loading';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = '<div class="spinner"></div>';
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? '#ea4335' : '#34a853';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleDebugInfo() {
            const debugContent = document.getElementById('debugInfo');
            debugContent.style.display = debugContent.style.display === 'block' ? 'none' : 'block';
        }

        // ========================================
        // IMAGE CONTROLS
        // ========================================
        function zoomIn() {
            zoomLevel *= 1.2;
            updateZoom();
        }

        function zoomOut() {
            zoomLevel /= 1.2;
            updateZoom();
        }

        function resetZoom() {
            zoomLevel = 1;
            rotation = 0;
            updateZoom();
        }

        function rotateImage() {
            rotation = (rotation + 90) % 360;
            updateZoom();
        }

        function updateZoom() {
            const img = document.getElementById('facturaImage');
            img.style.transform = `scale(${zoomLevel}) rotate(${rotation}deg)`;
            document.getElementById('zoomInfo').textContent = Math.round(zoomLevel * 100) + '%';
        }

        // ========================================
        // IMAGE PANNING
        // ========================================
        let isPanning = false;
        let startX, startY, scrollLeft, scrollTop;

        const imageContainer = document.getElementById('imageContainer');
        imageContainer.addEventListener('mousedown', (e) => {
            if (e.target.tagName !== 'IMG') return;
            isPanning = true;
            startX = e.pageX - imageContainer.offsetLeft;
            startY = e.pageY - imageContainer.offsetTop;
            scrollLeft = imageContainer.scrollLeft;
            scrollTop = imageContainer.scrollTop;
        });

        imageContainer.addEventListener('mouseleave', () => isPanning = false);
        imageContainer.addEventListener('mouseup', () => isPanning = false);

        imageContainer.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault();
            const x = e.pageX - imageContainer.offsetLeft;
            const y = e.pageY - imageContainer.offsetTop;
            imageContainer.scrollLeft = scrollLeft - (x - startX);
            imageContainer.scrollTop = scrollTop - (y - startY);
        });

        // ========================================
        // PRODUCTOS MANAGEMENT
        // ========================================
        function renderProductos() {
            const tbody = document.getElementById('productosBody');

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">No hay productos. Haz clic en "Agregar Producto"</td></tr>';
                document.getElementById('productosCount').textContent = '0';
                return;
            }

            tbody.innerHTML = '';

            productos.forEach((prod, index) => {
                const row = tbody.insertRow();

                const codigo = prod.codigo || prod.codigo_ean || '';
                const nombre = prod.nombre || '';
                const precio = prod.precio || 0;

                row.innerHTML = `
            <td><input type="text" value="${codigo}" onchange="actualizarProducto(${index}, 'codigo', this.value)"></td>
            <td><input type="text" value="${nombre}" onchange="actualizarProducto(${index}, 'nombre', this.value)"></td>
            <td><input type="number" step="0.01" value="${precio}" onchange="actualizarProducto(${index}, 'precio', parseFloat(this.value) || 0)"></td>
            <td><button class="btn-delete" onclick="eliminarProducto(${index})">×</button></td>
        `;
            });

            document.getElementById('productosCount').textContent = productos.length;
        }

        function actualizarProducto(index, campo, valor) {
            if (index >= 0 && index < productos.length) {
                productos[index][campo] = valor;
                console.log(`✓ Producto ${index} actualizado:`, campo, '=', valor);
            }
        }

        function agregarProducto() {
            productos.push({
                codigo: '',
                nombre: 'Nuevo Producto',
                precio: 0,
                nuevo: true
            });

            renderProductos();

            const tbody = document.getElementById('productosBody');
            const lastRow = tbody.lastElementChild;
            if (lastRow) {
                const firstInput = lastRow.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }

            showToast('Producto agregado');
        }

        async function eliminarProducto(index) {
            if (!confirm('¿Eliminar este producto?')) return;

            const prod = productos[index];
            console.log('🗑️ Intentando eliminar producto:', prod);

            // Si el producto existe en el servidor, eliminarlo primero
            if (!prod.nuevo && prod.id) {
                try {
                    showLoading();
                    console.log(`📡 DELETE ${API_URL}/admin/items/${prod.id}`);

                    const response = await fetch(`${API_URL}/admin/items/${prod.id}`, {
                        method: 'DELETE'
                    });

                    console.log('📥 Response status:', response.status);

                    if (!response.ok) {
                        throw new Error('Error eliminando del servidor');
                    }

                    const data = await response.json();
                    console.log('✅ Eliminado del servidor:', data);

                } catch (error) {
                    console.error('❌ Error:', error);
                    alert('Error eliminando del servidor: ' + error.message);
                    hideLoading();
                    return;
                } finally {
                    hideLoading();
                }
            }

            // Eliminar del array local
            productos.splice(index, 1);
            renderProductos();
            showToast('Producto eliminado');
            console.log('✅ Producto eliminado localmente');
        }

        // ========================================
        // CARGAR FACTURA
        // ========================================
        async function cargarFactura() {
            showLoading();

            try {
                console.log('🔄 Cargando factura ID:', facturaId);

                const url = `${API_URL}/admin/facturas/${facturaId}`;
                console.log('📡 GET', url);

                const response = await fetch(url);
                console.log('📥 Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const factura = await response.json();
                console.log('✅ Factura recibida:', factura);

                facturaOriginal = JSON.parse(JSON.stringify(factura));

                // Debug info
                document.getElementById('debugInfo').textContent = JSON.stringify(factura, null, 2);

                // Datos generales
                document.getElementById('facturaIdDisplay').textContent = factura.id || facturaId;
                document.getElementById('establecimiento').value = factura.establecimiento || '';
                // Backend envía CENTAVOS, dividir por 100 para mostrar PESOS
                const totalCentavos = factura.total || factura.total_factura || 0;
                const totalPesos = totalCentavos / 100;
                document.getElementById('total').value = totalPesos;
                console.log(`💵 Total: ${totalPesos} pesos (${totalCentavos} centavos)`);
                document.getElementById('puntaje').textContent = factura.puntaje || 0;
                document.getElementById('estadoBadge').textContent = factura.estado || factura.estado_validacion || 'Pendiente';

                // Fecha
                if (factura.fecha || factura.fecha_factura || factura.fecha_compra) {
                    const fechaStr = factura.fecha || factura.fecha_factura || factura.fecha_compra;
                    const fecha = new Date(fechaStr);
                    if (!isNaN(fecha.getTime())) {
                        document.getElementById('fecha').value = fecha.toISOString().split('T')[0];
                    }
                }

                // Productos
                if (Array.isArray(factura.productos) && factura.productos.length > 0) {
                    console.log('📦 Productos encontrados:', factura.productos.length);

                    productos = factura.productos.map(p => {
                        // Backend envía CENTAVOS, dividir por 100 para mostrar PESOS
                        let precioCentavos = parseFloat(p.precio) || 0;
                        let precioPesos = precioCentavos / 100;

                        console.log(`  💰 ${p.nombre}: ${precioPesos} pesos (${precioCentavos} centavos)`);

                        return {
                            id: p.id,
                            codigo: p.codigo || p.codigo_ean || p.codigo_leido || '',
                            nombre: p.nombre || p.nombre_producto || p.nombre_leido || 'Sin nombre',
                            precio: precioPesos,  // En pesos para mostrar
                            nuevo: false
                        };
                    });

                    console.log('✅ Productos mapeados con precios en PESOS:', productos);
                } else {
                    console.log('⚠️ No hay productos en la factura');
                    productos = [];
                }

                renderProductos();
                await cargarImagen();

                console.log('✅ Factura cargada completamente');

            } catch (error) {
                console.error('❌ ERROR:', error);
                alert(`Error al cargar:\n${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // CARGAR IMAGEN - VERSIÓN CORREGIDA
        // ========================================
        async function cargarImagen() {
            const img = document.getElementById('facturaImage');
            const container = document.getElementById('imageContainer');

            try {
                console.log('📷 Intentando cargar imagen de factura', facturaId);

                // 🔧 INTENTAR MÚLTIPLES ENDPOINTS POSIBLES
                const imageUrls = [
                    `${API_URL}/admin/facturas/${facturaId}/imagen`,      // ✅ Endpoint correcto
                    `${API_URL}/images/${facturaId}`,                     // Alternativo
                    `${API_URL}/api/facturas/${facturaId}/imagen`,        // Variante con /api
                ];

                let imagenCargada = false;

                // ✅ CORRECCIÓN: Cargar directamente sin HEAD request
                for (const imageUrl of imageUrls) {
                    if (imagenCargada) break;

                    console.log(`🔍 Intentando cargar desde: ${imageUrl}`);

                    const timestamp = Date.now();
                    const urlWithCache = `${imageUrl}?t=${timestamp}`;

                    // Crear promesa para manejar la carga
                    const loadPromise = new Promise((resolve, reject) => {
                        const tempImg = new Image();

                        tempImg.onload = () => {
                            console.log(`✅ Imagen cargada desde: ${imageUrl}`);
                            img.src = tempImg.src;
                            img.style.display = 'block';
                            resetZoom();
                            imagenCargada = true;
                            resolve();
                        };

                        tempImg.onerror = () => {
                            console.log(`⚠️ No disponible: ${imageUrl}`);
                            reject();
                        };

                        tempImg.src = urlWithCache;
                    });

                    try {
                        await loadPromise;
                        return; // Salir si se cargó exitosamente
                    } catch (e) {
                        continue; // Probar siguiente endpoint
                    }
                }

                // Si no se pudo cargar de ningún endpoint
                if (!imagenCargada) {
                    console.error('❌ No se encontró imagen en ningún endpoint');
                    mostrarMensajeSinImagen();
                }

            } catch (error) {
                console.error('❌ Error en cargarImagen:', error);
                mostrarMensajeSinImagen();
            }
        }

        function mostrarMensajeSinImagen() {
            const container = document.getElementById('imageContainer');
            const img = document.getElementById('facturaImage');

            img.style.display = 'none';
            container.innerHTML = `
                <div class="no-image-message">
                    <div class="icon">📸</div>
                    <h3>Esta factura no tiene imagen</h3>
                    <p>La imagen no se guardó durante el procesamiento o no está disponible en el servidor</p>
                    <p style="margin-top: 20px; font-size: 12px; color: #666;">
                        Factura ID: ${facturaId}
                    </p>
                </div>
            `;
        }

        // ========================================
        // GUARDAR CAMBIOS
        // ========================================
        async function guardarCambios() {
            console.log('💾 ============================================');
            console.log('💾 INICIANDO GUARDADO DE CAMBIOS');
            console.log('💾 ============================================');
            showLoading();

            try {
                // 1. GUARDAR DATOS GENERALES
                const fechaValue = document.getElementById('fecha').value || null;

                const datosGenerales = {
                    establecimiento: document.getElementById('establecimiento').value.trim(),
                    // 🔧 CORRECCIÓN: Convertir total a centavos antes de guardar
                    total: Math.round((parseFloat(document.getElementById('total').value) || 0) * 100)
                };

                if (fechaValue) {
                    datosGenerales.fecha = fechaValue;
                }

                console.log('📝 Datos generales a guardar:', datosGenerales);
                console.log(`📡 PUT ${API_URL}/admin/facturas/${facturaId}`);

                const respGeneral = await fetch(`${API_URL}/admin/facturas/${facturaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosGenerales)
                });

                console.log('📥 Response status (datos generales):', respGeneral.status);

                if (!respGeneral.ok) {
                    const errorText = await respGeneral.text();
                    console.error('❌ Error en datos generales:', errorText);
                    throw new Error(`Error datos generales: ${errorText}`);
                }

                console.log('✅ Datos generales guardados');

                // 2. ACTUALIZAR PRODUCTOS EXISTENTES
                console.log('\n🔄 Actualizando productos existentes...');
                let productosActualizados = 0;

                for (const prod of productos) {
                    if (!prod.nuevo && prod.id) {
                        console.log(`\n  📦 Producto #${prod.id}:`, prod);

                        // 🔧 CORRECCIÓN: Convertir pesos a centavos antes de guardar
                        const precioPesos = parseFloat(prod.precio) || 0;
                        const precioCentavos = Math.round(precioPesos * 100);

                        console.log(`     💰 Convirtiendo: ${precioPesos} pesos → ${precioCentavos} centavos`);

                        const itemData = {
                            nombre: prod.nombre.trim(),
                            precio: precioCentavos  // ✅ Guardamos en centavos
                        };

                        if (prod.codigo && prod.codigo.trim() !== '') {
                            itemData.codigo_ean = prod.codigo.trim();
                        }

                        console.log(`     📡 PUT ${API_URL}/admin/items/${prod.id}`);

                        const respProd = await fetch(`${API_URL}/admin/items/${prod.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(itemData)
                        });

                        if (!respProd.ok) {
                            const respText = await respProd.text();
                            console.error(`     ❌ Error actualizando item ${prod.id}:`, respText);
                            throw new Error(`Error actualizando producto ${prod.nombre}: ${respText}`);
                        }

                        productosActualizados++;
                        console.log('     ✅ Item actualizado');
                    }
                }

                console.log(`\n✅ ${productosActualizados} productos actualizados`);

                // 3. CREAR PRODUCTOS NUEVOS
                console.log('\n➕ Creando productos nuevos...');
                let productosCreados = 0;

                for (const prod of productos) {
                    if (prod.nuevo && prod.nombre && prod.nombre.trim() !== '') {
                        console.log(`\n  🆕 Nuevo producto:`, prod);

                        // 🔧 CORRECCIÓN: Convertir pesos a centavos antes de guardar
                        const precioPesos = parseFloat(prod.precio) || 0;
                        const precioCentavos = Math.round(precioPesos * 100);

                        console.log(`     💰 Convirtiendo: ${precioPesos} pesos → ${precioCentavos} centavos`);

                        const nuevoItemData = {
                            nombre: prod.nombre.trim(),
                            precio: precioCentavos  // ✅ Guardamos en centavos
                        };

                        if (prod.codigo && prod.codigo.trim() !== '') {
                            nuevoItemData.codigo_ean = prod.codigo.trim();
                        }

                        console.log(`     📡 POST ${API_URL}/admin/facturas/${facturaId}/items`);

                        const respNuevo = await fetch(`${API_URL}/admin/facturas/${facturaId}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(nuevoItemData)
                        });

                        if (!respNuevo.ok) {
                            const respText = await respNuevo.text();
                            console.error('     ❌ Error creando item:', respText);
                            throw new Error(`Error creando producto ${prod.nombre}: ${respText}`);
                        }

                        productosCreados++;
                        console.log('     ✅ Item creado');
                    }
                }

                console.log(`\n✅ ${productosCreados} productos nuevos creados`);

                // 4. FINALIZAR
                console.log('\n💾 ============================================');
                console.log('💾 GUARDADO COMPLETADO EXITOSAMENTE');
                console.log(`💾 - Datos generales: ✅`);
                console.log(`💾 - Productos actualizados: ${productosActualizados}`);
                console.log(`💾 - Productos nuevos: ${productosCreados}`);
                console.log('💾 ============================================\n');

                showToast('✅ Cambios guardados exitosamente');

                // Recargar factura después de 1.5 segundos
                setTimeout(() => {
                    console.log('🔄 Recargando factura...');
                    cargarFactura();
                }, 1500);

            } catch (error) {
                console.error('\n❌ ============================================');
                console.error('❌ ERROR AL GUARDAR');
                console.error('❌ ============================================');
                console.error('❌ Error:', error);
                console.error('❌ Stack:', error.stack);
                console.error('❌ ============================================\n');

                showToast('❌ Error al guardar: ' + error.message, 'error');
                alert(`Error al guardar:\n\n${error.message}\n\nRevisa la consola para más detalles.`);
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================
        document.addEventListener('keydown', (e) => {
            // Ctrl+S para guardar
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                guardarCambios();
            }

            // Ctrl+N para agregar producto
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                agregarProducto();
            }
        });

        // ========================================
        // INICIALIZAR
        // ========================================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 ============================================');
            console.log('🚀 LECFAC EDITOR INICIADO');
            console.log('🚀 ============================================');
            console.log('🚀 Factura ID:', facturaId);
            console.log('🚀 API URL:', API_URL);
            console.log('🚀 ============================================\n');
            cargarFactura();
        });
    </script>
</body>

</html>
