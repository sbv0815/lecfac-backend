<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Factura - LecFac</title>
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        height: 100vh;
    overflow: hidden;
}

.editor-container {
    display: grid;
    grid-template-columns: 55% 45%;
    height: 100vh;
    position: relative;
}

.resize-handle {
    position: absolute;
    left: 55%;
    top: 0;
    bottom: 0;
    width: 8px;
    background: #ddd;
    cursor: col-resize;
    z-index: 1000;
    transition: background 0.2s;
}

.resize-handle:hover {
    background: #1a73e8;
}

.image-panel {
    background: #1a1a1a;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.image-controls {
    background: #2d2d2d;
    padding: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    border-bottom: 1px solid #444;
    flex-shrink: 0;
}

.image-controls button {
    background: #4a4a4a;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.image-controls button:hover { background: #5a5a5a; }

.zoom-info {
    color: #aaa;
    margin-left: auto;
    font-size: 14px;
}

.image-container {
    flex: 1;
    overflow: auto;
    background: #1a1a1a;
    padding: 20px;
}

.image-container img {
    display: block;
    max-width: none;
    width: auto;
    height: auto;
    cursor: grab;
    transition: transform 0.1s;
}

.image-container:active img {
    cursor: grabbing;
}

.form-panel {
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.form-header {
    background: #1a73e8;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.validation-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.badge-validada { background: #34a853; }
.badge-revisada { background: #34a853; }
.badge-revision_requerida { background: #fbbc04; color: #000; }
.badge-pendiente { background: #ea4335; }
.badge-procesado { background: #4285f4; }

.form-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px;
    scroll-behavior: smooth;
}

.form-content::-webkit-scrollbar,
.image-container::-webkit-scrollbar {
    width: 12px;
}

.form-content::-webkit-scrollbar-track,
.image-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.form-content::-webkit-scrollbar-thumb,
.image-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 6px;
}

.form-content::-webkit-scrollbar-thumb:hover,
.image-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.form-section {
    margin-bottom: 25px;
}

.form-section h3 {
    font-size: 13px;
    color: #666;
    margin-bottom: 10px;
    text-transform: uppercase;
    position: sticky;
    top: 0;
    background: white;
    padding: 10px 0;
    z-index: 10;
}

.field-group {
    margin-bottom: 15px;
}

.field-group label {
    display: block;
    font-size: 13px;
    color: #333;
    margin-bottom: 5px;
    font-weight: 500;
}

.field-group input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
}

.field-group input:focus {
    outline: none;
    border-color: #1a73e8;
}

.productos-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 10px;
}

.productos-table thead {
    position: sticky;
    top: 40px;
    background: white;
    z-index: 9;
}

.productos-table th {
    background: #f5f5f5;
    padding: 10px 8px;
    text-align: left;
    font-weight: 600;
    color: #666;
    border-bottom: 2px solid #ddd;
}

.productos-table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
}

.productos-table input {
    width: 100%;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

.productos-table input:focus {
    outline: none;
    border-color: #1a73e8;
}

.btn-delete {
    background: #ea4335;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.btn-delete:hover { background: #d33; }

.btn-add {
    background: #34a853;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
}

.btn-add:hover { background: #2d9148; }

.form-actions {
    padding: 20px;
    background: #f9f9f9;
    border-top: 1px solid #ddd;
    display: flex;
    gap: 10px;
    flex-shrink: 0;
}

.btn-primary {
    flex: 1;
    background: #1a73e8;
    color: white;
    border: none;
    padding: 14px;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

.btn-primary:hover { background: #1557b0; }

.btn-secondary {
    background: #5f6368;
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: 6px;
    cursor: pointer;
}

.btn-secondary:hover { background: #3c4043; }

.loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #1a73e8;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #34a853;
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from { transform: translateX(400px); }
    to { transform: translateX(0); }
}

.debug-section {
    margin-top: 20px;
    border-top: 1px dashed #ccc;
    padding-top: 20px;
}

.debug-toggle {
    background: #f5f5f5;
    border: 1px solid #ddd;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    color: #666;
    width: 100%;
    text-align: left;
}

.debug-content {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    overflow: auto;
    max-height: 200px;
}
</style>
</head>
<body>
    <div class="editor-container">
    <div class="resize-handle" id="resizeHandle"></div>
    
    <!-- Panel de imagen -->
    <div class="image-panel">
        <div class="image-controls">
            <button onclick="zoomIn()">+</button>
            <button onclick="zoomOut()">-</button>
            <button onclick="resetZoom()">Reset</button>
            <button onclick="rotateImage()">Rotar</button>
            <span class="zoom-info" id="zoomInfo">100%</span>
        </div>
        <div class="image-container" id="imageContainer">
            <img id="facturaImage" src="" alt="Factura" style="display:none;">
        </div>
    </div>
    
    <!-- Panel de formulario -->
    <div class="form-panel">
        <div class="form-header">
            <div>
                <h2>Factura #<span id="facturaId">-</span></h2>
                <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                    Puntaje: <span id="puntaje">-</span>/100
                </div>
            </div>
            <span class="validation-badge" id="estadoBadge">Pendiente</span>
        </div>
        
        <div class="form-content">
            <!-- Datos generales -->
            <div class="form-section">
                <h3>Datos Generales</h3>
                <div class="field-group">
                    <label>Establecimiento</label>
                    <input type="text" id="establecimiento" placeholder="Ej: Jumbo Bulevar">
                </div>
                <div class="field-group">
                    <label>Total ($)</label>
                    <input type="number" id="total" step="0.01" placeholder="0.00">
                </div>
                <div class="field-group">
                    <label>Fecha</label>
                    <input type="date" id="fecha">
                </div>
            </div>
            
            <!-- Productos -->
            <div class="form-section">
                <h3>Productos (<span id="productosCount">0</span>)</h3>
                <table class="productos-table">
                    <thead>
                        <tr>
                            <th style="width: 25%">C√≥digo</th>
                            <th style="width: 40%">Nombre</th>
                            <th style="width: 20%">Precio</th>
                            <th style="width: 15%"></th>
                        </tr>
                    </thead>
                    <tbody id="productosBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999; padding: 20px;">
                                Cargando productos...
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn-add" onclick="agregarProducto()">+ Agregar Producto</button>
            </div>

            <!-- Secci√≥n de debug -->
            <div class="debug-section">
                <button class="debug-toggle" onclick="toggleDebugInfo()">
                    üîç Mostrar/Ocultar Datos Crudos (Debug)
                </button>
                <pre class="debug-content" id="debugInfo">Cargando...</pre>
            </div>
        </div>
        
        <div class="form-actions">
            <button class="btn-secondary" onclick="window.close()">Cerrar</button>
            <button class="btn-primary" onclick="guardarCambios()">üíæ Guardar Cambios</button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://lecfac-api.onrender.com';
    const facturaId = new URLSearchParams(window.location.search).get('id');
    
    let zoomLevel = 1;
    let rotation = 0;
    let productos = [];
    let facturaOriginal = null;

    // Redimensionar paneles
    let isResizing = false;
    const resizeHandle = document.getElementById('resizeHandle');
    const editorContainer = document.querySelector('.editor-container');

    resizeHandle.addEventListener('mousedown', () => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerWidth = editorContainer.offsetWidth;
        const leftWidth = (e.clientX / containerWidth) * 100;
        
        if (leftWidth > 30 && leftWidth < 70) {
            editorContainer.style.gridTemplateColumns = `${leftWidth}% ${100 - leftWidth}%`;
            resizeHandle.style.left = `${leftWidth}%`;
        }
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = 'default';
        }
    });

    // Funciones de UI
    function showLoading() {
        const overlay = document.createElement('div');
        overlay.className = 'loading';
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = '<div class="spinner"></div>';
        document.body.appendChild(overlay);
    }
    
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.remove();
    }
    
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function toggleDebugInfo() {
        const debugContent = document.getElementById('debugInfo');
        debugContent.style.display = debugContent.style.display === 'block' ? 'none' : 'block';
    }
    
    // Controles de zoom
    function zoomIn() {
        zoomLevel *= 1.2;
        updateZoom();
    }
    
    function zoomOut() {
        zoomLevel /= 1.2;
        updateZoom();
    }
    
    function resetZoom() {
        zoomLevel = 1;
        rotation = 0;
        updateZoom();
    }
    
    function rotateImage() {
        rotation = (rotation + 90) % 360;
        updateZoom();
    }
    
    function updateZoom() {
        const img = document.getElementById('facturaImage');
        img.style.transform = `scale(${zoomLevel}) rotate(${rotation}deg)`;
        document.getElementById('zoomInfo').textContent = Math.round(zoomLevel * 100) + '%';
    }
    
    // Pan de imagen
    let isPanning = false;
    let startX, startY, scrollLeft, scrollTop;
    
    const imageContainer = document.getElementById('imageContainer');
    imageContainer.addEventListener('mousedown', (e) => {
        if (e.target.tagName !== 'IMG') return;
        isPanning = true;
        startX = e.pageX - imageContainer.offsetLeft;
        startY = e.pageY - imageContainer.offsetTop;
        scrollLeft = imageContainer.scrollLeft;
        scrollTop = imageContainer.scrollTop;
    });
    
    imageContainer.addEventListener('mouseleave', () => isPanning = false);
    imageContainer.addEventListener('mouseup', () => isPanning = false);
    
    imageContainer.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        e.preventDefault();
        const x = e.pageX - imageContainer.offsetLeft;
        const y = e.pageY - imageContainer.offsetTop;
        imageContainer.scrollLeft = scrollLeft - (x - startX);
        imageContainer.scrollTop = scrollTop - (y - startY);
    });
    
    // Funciones para productos
    function renderProductos() {
        const tbody = document.getElementById('productosBody');
        
        if (productos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">No hay productos. Haz clic en "Agregar Producto"</td></tr>';
            document.getElementById('productosCount').textContent = '0';
            return;
        }
        
        tbody.innerHTML = '';
        
        productos.forEach((prod, index) => {
            const row = tbody.insertRow();
            
            const codigo = prod.codigo || '';
            const nombre = prod.nombre || '';
            const precio = prod.precio || 0;
            
            row.innerHTML = `
                <td><input type="text" value="${codigo}" onchange="actualizarProducto(${index}, 'codigo', this.value)"></td>
                <td><input type="text" value="${nombre}" onchange="actualizarProducto(${index}, 'nombre', this.value)"></td>
                <td><input type="number" step="0.01" value="${precio}" onchange="actualizarProducto(${index}, 'precio', parseFloat(this.value) || 0)"></td>
                <td><button class="btn-delete" onclick="eliminarProducto(${index})">√ó</button></td>
            `;
        });
        
        document.getElementById('productosCount').textContent = productos.length;
    }
    
    function actualizarProducto(index, campo, valor) {
        if (index >= 0 && index < productos.length) {
            productos[index][campo] = valor;
            console.log(`‚úì Producto ${index} actualizado:`, campo, '=', valor);
        }
    }
    
    function agregarProducto() {
        productos.push({ 
            codigo: '', 
            nombre: 'Nuevo Producto', 
            precio: 0, 
            nuevo: true 
        });
        
        renderProductos();
        
        // Enfocar en el nuevo producto
        const tbody = document.getElementById('productosBody');
        const lastRow = tbody.lastElementChild;
        if (lastRow) {
            const firstInput = lastRow.querySelector('input');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }
        }
        
        showToast('Producto agregado');
    }
    
    async function eliminarProducto(index) {
        if (!confirm('¬øEliminar este producto?')) return;
        
        const prod = productos[index];
        
        // Si tiene ID, eliminarlo del servidor
        if (!prod.nuevo && prod.id) {
            try {
                showLoading();
                const response = await fetch(`${API_URL}/admin/productos/${prod.id}`, { 
                    method: 'DELETE' 
                });
                
                if (!response.ok) {
                    throw new Error('Error al eliminar del servidor');
                }
                
                showToast('Producto eliminado del servidor');
            } catch (e) {
                console.error('Error eliminando:', e);
                alert('Error: ' + e.message);
                return;
            } finally {
                hideLoading();
            }
        }
        
        // Eliminar del array local
        productos.splice(index, 1);
        renderProductos();
    }
    
    // CARGAR FACTURA
    // CARGAR FACTURA - VERSI√ìN CON DEBUG DETALLADO
async function cargarFactura() {
    console.log('üîÑ Cargando factura ID:', facturaId);
    
    if (!facturaId) {
        alert('‚ùå Error: No se especific√≥ ID de factura en la URL');
        return;
    }

    showLoading();
    
    try {
        console.log(`üì° Fetching: ${API_URL}/admin/facturas/${facturaId}`);
        
        const response = await fetch(`${API_URL}/admin/facturas/${facturaId}`);
        
        console.log('üì• Response status:', response.status);
        console.log('üì• Response headers:', [...response.headers.entries()]);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error ${response.status}: ${errorText}`);
        }
        
        const factura = await response.json();
        console.log('‚úÖ Factura recibida completa:', factura);
        
        // ====== DEBUG CR√çTICO DE PRODUCTOS ======
        console.log('=== üîç DEBUG PRODUCTOS ===');
        console.log('1. factura.productos existe?', factura.productos !== undefined);
        console.log('2. Es array?', Array.isArray(factura.productos));
        console.log('3. Cantidad de productos:', factura.productos?.length || 0);
        console.log('4. Productos crudos:', factura.productos);
        if (factura.productos && factura.productos.length > 0) {
            console.log('5. Primer producto:', factura.productos[0]);
            console.log('6. Campos del primer producto:', Object.keys(factura.productos[0]));
        }
        console.log('========================');
        
        facturaOriginal = factura;
        document.getElementById('debugInfo').textContent = JSON.stringify(factura, null, 2);
        
        // DATOS GENERALES
        document.getElementById('facturaId').textContent = factura.id || '-';
        document.getElementById('establecimiento').value = factura.establecimiento || '';
        document.getElementById('total').value = factura.total || factura.total_factura || 0;
        
        // FECHA
        if (factura.fecha) {
            try {
                let fechaStr = factura.fecha;
                if (typeof fechaStr === 'string') {
                    if (fechaStr.includes('T')) {
                        fechaStr = fechaStr.split('T')[0];
                    }
                    else if (!fechaStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const fecha = new Date(fechaStr);
                        if (!isNaN(fecha.getTime())) {
                            fechaStr = fecha.toISOString().split('T')[0];
                        }
                    }
                }
                document.getElementById('fecha').value = fechaStr;
            } catch (e) {
                console.warn('‚ö†Ô∏è Error parseando fecha:', e);
            }
        }
        
        // ESTADO
        const estado = factura.estado || factura.estado_validacion || 'pendiente';
        const estadoBadge = document.getElementById('estadoBadge');
        estadoBadge.textContent = estado;
        estadoBadge.className = 'validation-badge badge-' + estado.toLowerCase().replace(' ', '_');
        
        // PUNTAJE
        if (factura.puntaje !== undefined && factura.puntaje !== null) {
            document.getElementById('puntaje').textContent = factura.puntaje;
        }
        
        // ====== PRODUCTOS - MAPEO DETALLADO ======
        console.log('üîÑ Iniciando mapeo de productos...');
        
        if (!factura.productos) {
            console.error('‚ùå factura.productos es undefined o null');
            productos = [];
        } else if (!Array.isArray(factura.productos)) {
            console.error('‚ùå factura.productos NO es un array:', typeof factura.productos);
            productos = [];
        } else if (factura.productos.length === 0) {
            console.warn('‚ö†Ô∏è factura.productos est√° vac√≠o (length = 0)');
            productos = [];
        } else {
            console.log(`üì¶ Procesando ${factura.productos.length} productos...`);
            
            productos = factura.productos.map((p, index) => {
                console.log(`  - Producto ${index + 1}:`, p);
                
                // Mapeo con fallbacks
                const codigo = p.codigo || p.codigo_ean || p.codigo_local || '';
                const nombre = p.nombre || p.nombre_producto || p.descripcion || 'Sin nombre';
                const precio = parseFloat(p.precio) || parseFloat(p.valor) || parseFloat(p.precio_unitario) || 0;
                
                const productoMapeado = {
                    id: p.id,
                    codigo: codigo,
                    nombre: nombre,
                    precio: precio,
                    nuevo: false
                };
                
                console.log(`    ‚úì Mapeado:`, productoMapeado);
                return productoMapeado;
            });
            
            console.log('‚úÖ Productos mapeados exitosamente:', productos);
        }
        
        // RENDERIZAR PRODUCTOS
        console.log('üé® Llamando a renderProductos()...');
        renderProductos();
        console.log('‚úÖ renderProductos() completado');
        
        // CARGAR IMAGEN
        await cargarImagen();
        
        console.log('‚úÖ‚úÖ‚úÖ Factura cargada COMPLETAMENTE ‚úÖ‚úÖ‚úÖ');
        
    } catch (error) {
        console.error('‚ùå‚ùå‚ùå ERROR CR√çTICO:', error);
        console.error('Stack trace:', error.stack);
        alert(`Error al cargar la factura:\n${error.message}`);
    } finally {
        hideLoading();
    }
}

    // CARGAR IMAGEN
    async function cargarImagen() {
        const img = document.getElementById('facturaImage');
        const container = document.getElementById('imageContainer');
        
        try {
            console.log('üì∑ Cargando imagen...');
            
            const timestamp = Date.now();
            const imageUrl = `${API_URL}/admin/facturas/${facturaId}/imagen?t=${timestamp}`;
            
            img.onload = () => {
                console.log('‚úÖ Imagen cargada');
                img.style.display = 'block';
                resetZoom();
            };
            
            img.onerror = () => {
                console.error('‚ùå Error cargando imagen');
                img.style.display = 'none';
                container.innerHTML = `
                    <div style="color: white; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üì∏</div>
                        <h3>No se pudo cargar la imagen</h3>
                        <p style="color: #999; margin-top: 10px;">La factura no tiene imagen asociada</p>
                    </div>
                `;
            };
            
            img.src = imageUrl;
            
        } catch (error) {
            console.error('‚ùå Error en cargarImagen:', error);
        }
    }
// CARGAR IMAGEN - Con opci√≥n de subir si no existe
async function cargarImagen() {
    const img = document.getElementById('facturaImage');
    const container = document.getElementById('imageContainer');
    
    try {
        console.log('üì∑ Cargando imagen...');
        
        const timestamp = Date.now();
        const imageUrl = `${API_URL}/admin/facturas/${facturaId}/imagen?t=${timestamp}`;
        
        img.onload = () => {
            console.log('‚úÖ Imagen cargada');
            img.style.display = 'block';
            resetZoom();
        };
        
        img.onerror = () => {
            console.error('‚ùå No hay imagen');
            img.style.display = 'none';
            container.innerHTML = `
                <div style="color: white; text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üì∏</div>
                    <h3>Esta factura no tiene imagen</h3>
                    <p style="color: #999; margin: 15px 0;">La imagen no se guard√≥ durante el procesamiento OCR</p>
                    <button onclick="subirImagenManual()" style="
                        margin-top: 20px; 
                        padding: 12px 24px; 
                        background: #1a73e8; 
                        color: white; 
                        border: none; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        font-size: 14px;
                        font-weight: 500;
                    ">
                        üì§ Subir Imagen Manualmente
                    </button>
                </div>
            `;
        };
        
        img.src = imageUrl;
        
    } catch (error) {
        console.error('‚ùå Error en cargarImagen:', error);
    }
}

// FUNCI√ìN PARA SUBIR IMAGEN MANUALMENTE
function subirImagenManual() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tama√±o
        if (file.size > 10 * 1024 * 1024) {
            alert('El archivo es muy grande. M√°ximo 10MB.');
            return;
        }
        
        showLoading();
        
        try {
            const formData = new FormData();
            formData.append('imagen', file);
            
            console.log('üì§ Subiendo imagen...');
            
            const response = await fetch(`${API_URL}/admin/facturas/${facturaId}/subir-imagen`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al subir imagen');
            }
            
            const result = await response.json();
            console.log('‚úÖ Resultado:', result);
            
            showToast('‚úÖ Imagen subida correctamente');
            
            // Recargar imagen despu√©s de 1 segundo
            setTimeout(() => {
                cargarImagen();
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå Error subiendo:', error);
            alert(`Error al subir imagen:\n${error.message}`);
        } finally {
            hideLoading();
        }
    };
    
    input.click();
}
    // GUARDAR CAMBIOS
    async function guardarCambios() {
        console.log('üíæ Guardando cambios...');
        showLoading();
        
        try {
            // 1. DATOS GENERALES
            const fechaValue = document.getElementById('fecha').value || null;
            
            const datosGenerales = {
                establecimiento: document.getElementById('establecimiento').value.trim(),
                total: parseFloat(document.getElementById('total').value) || 0
            };
            
            if (fechaValue) {
                datosGenerales.fecha = fechaValue;
            }
            
            console.log('üìù Guardando datos generales:', datosGenerales);
            
            const respGeneral = await fetch(`${API_URL}/admin/facturas/${facturaId}/datos-generales`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datosGenerales)
            });
            
            if (!respGeneral.ok) {
                throw new Error('Error guardando datos generales');
            }
            
            // 2. ACTUALIZAR PRODUCTOS EXISTENTES
            for (const prod of productos) {
                if (!prod.nuevo && prod.id) {
                    console.log(`üîÑ Actualizando producto #${prod.id}`);
                    
                    const respProd = await fetch(`${API_URL}/admin/productos/${prod.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            codigo: prod.codigo,
                            nombre: prod.nombre,
                            precio: prod.precio
                        })
                    });
                    
                    if (!respProd.ok) {
                        console.error(`‚ùå Error actualizando producto ${prod.id}`);
                    }
                }
            }
            
            // 3. AGREGAR PRODUCTOS NUEVOS
            for (const prod of productos) {
                if (prod.nuevo && prod.codigo && prod.nombre) {
                    console.log('‚ûï Creando nuevo producto:', prod);
                    
                    const respNuevo = await fetch(`${API_URL}/admin/facturas/${facturaId}/productos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            codigo: prod.codigo,
                            nombre: prod.nombre,
                            precio: prod.precio
                        })
                    });
                    
                    if (!respNuevo.ok) {
                        console.error('‚ùå Error creando producto');
                    }
                }
            }
            
            console.log('‚úÖ Cambios guardados exitosamente');
            showToast('‚úÖ Cambios guardados exitosamente');
            
            // Recargar despu√©s de 1 segundo
            setTimeout(() => cargarFactura(), 1500);
            
        } catch (error) {
            console.error('‚ùå Error guardando:', error);
            alert(`Error al guardar:\n${error.message}`);
        } finally {
            hideLoading();
        }
    }
    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
        // Ctrl+S = Guardar
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            guardarCambios();
        }
        
        // Ctrl+N = Nuevo producto
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            agregarProducto();
        }
    });

    // INICIAR AL CARGAR
    window.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ DOM cargado, iniciando editor...');
        cargarFactura();
    });

    </script>
</body>
</html>
