<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Factura - LecFac V1</title>
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        height: 100vh;
        overflow: hidden;
    }
    
    .editor-container {
        display: grid;
        grid-template-columns: 55% 45%;
        height: 100vh;
        position: relative;
    }
    
    /* Divisor redimensionable */
    .resize-handle {
        position: absolute;
        left: 55%;
        top: 0;
        bottom: 0;
        width: 8px;
        background: #ddd;
        cursor: col-resize;
        z-index: 1000;
        transition: background 0.2s;
    }
    
    .resize-handle:hover {
        background: #1a73e8;
    }
    
    /* Panel izquierdo: Imagen CON SCROLL */
    .image-panel {
        background: #1a1a1a;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .image-controls {
        background: #2d2d2d;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        border-bottom: 1px solid #444;
        flex-shrink: 0;
    }
    
    .image-controls button {
        background: #4a4a4a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .image-controls button:hover { background: #5a5a5a; }
    
    .zoom-info {
        color: #aaa;
        margin-left: auto;
        font-size: 14px;
    }
    
    /* CAMBIO CLAVE: Hacer el contenedor scrolleable */
    .image-container {
        flex: 1;
        overflow: auto;  /* ← Permite scroll vertical y horizontal */
        background: #1a1a1a;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-container img {
        display: block;
        max-width: none;
        width: auto;
        height: auto;
        cursor: grab;
        transition: transform 0.1s;
    }
    
    .image-container:active img {
        cursor: grabbing;
    }

    /* Estilos para mensaje de no imagen */
    .no-image-message {
        text-align: center;
        color: white;
        padding: 40px 20px;
        max-width: 400px;
        margin: 0 auto;
    }

    .no-image-icon {
        font-size: 64px;
        margin-bottom: 20px;
        color: #999;
    }

    .no-image-title {
        font-size: 18px;
        margin-bottom: 10px;
        color: #eee;
    }

    .no-image-text {
        color: #999;
        margin-bottom: 20px;
    }

    .btn-upload {
        background: #34a853;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-upload:hover {
        background: #2d9148;
    }
    
    /* Panel derecho: Formulario CON MEJOR SCROLL */
    .form-panel {
        background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .form-header {
        background: #1a73e8;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .validation-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .badge-validada { background: #34a853; }
    .badge-revision_requerida { background: #fbbc04; color: #000; }
    .badge-pendiente { background: #ea4335; }
    
    /* CAMBIO: Mejorar el scroll del formulario */
    .form-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        /* Scroll suave */
        scroll-behavior: smooth;
    }
    
    /* Personalizar scrollbar */
    .form-content::-webkit-scrollbar,
    .image-container::-webkit-scrollbar {
        width: 12px;
    }
    
    .form-content::-webkit-scrollbar-track,
    .image-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .form-content::-webkit-scrollbar-thumb,
    .image-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }
    
    .form-content::-webkit-scrollbar-thumb:hover,
    .image-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .form-section {
        margin-bottom: 25px;
    }
    
    .form-section h3 {
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
        position: sticky;
        top: 0;
        background: white;
        padding: 10px 0;
        z-index: 10;
    }
    
    .field-group {
        margin-bottom: 15px;
    }
    
    .field-group label {
        display: block;
        font-size: 13px;
        color: #333;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .field-group input {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .field-group input:focus {
        outline: none;
        border-color: #1a73e8;
    }
    
    /* Tabla de productos */
    .productos-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 10px;
    }
    
    .productos-table thead {
        position: sticky;
        top: 40px;  /* Después del h3 sticky */
        background: white;
        z-index: 9;
    }
    
    .productos-table th {
        background: #f5f5f5;
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        color: #666;
        border-bottom: 2px solid #ddd;
    }
    
    .productos-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .productos-table input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .productos-table input:focus {
        outline: none;
        border-color: #1a73e8;
    }
    
    .btn-delete {
        background: #ea4335;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-delete:hover { background: #d33; }
    
    .btn-add {
        background: #34a853;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
    }
    
    .btn-add:hover { background: #2d9148; }
    
    .form-actions {
        padding: 20px;
        background: #f9f9f9;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
        flex-shrink: 0;
    }
    
    .btn-primary {
        flex: 1;
        background: #1a73e8;
        color: white;
        border: none;
        padding: 14px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .btn-primary:hover { background: #1557b0; }
    
    .btn-secondary {
        background: #5f6368;
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: 6px;
        cursor: pointer;
    }
    
    .btn-secondary:hover { background: #3c4043; }
    
    .loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1a73e8;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #34a853;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
        from { transform: translateX(400px); }
        to { transform: translateX(0); }
    }
</style>
</head>
<body>
    <div class="editor-container" id="editorContainer">
        <!-- Divisor redimensionable -->
        <div class="resize-handle" id="resizeHandle"></div>
        
        <!-- Panel de imagen -->
        <div class="image-panel">
            <div class="image-controls">
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomOut()">-</button>
                <button onclick="resetZoom()">Reset</button>
                <button onclick="rotateImage()">Rotar</button>
                <span class="zoom-info" id="zoomInfo">100%</span>
            </div>
            <div class="image-container" id="imageContainer">
                <img id="facturaImage" src="" alt="Factura" style="display: none;">
            </div>
        </div>
        
        <!-- Panel de formulario -->
        <div class="form-panel">
            <div class="form-header">
                <div>
                    <h2>Factura #<span id="facturaId">-</span></h2>
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                        Puntaje: <span id="puntaje">-</span>/100
                    </div>
                </div>
                <span class="validation-badge" id="estadoBadge">Pendiente</span>
            </div>
            
            <div class="form-content">
                <!-- Datos generales -->
                <div class="form-section">
                    <h3>Datos Generales</h3>
                    <div class="field-group">
                        <label>Establecimiento</label>
                        <input type="text" id="establecimiento" placeholder="Ej: Jumbo Bulevar">
                    </div>
                    <div class="field-group">
                        <label>Total ($)</label>
                        <input type="number" id="total" step="0.01">
                    </div>
                </div>
                
                <!-- Productos -->
                <div class="form-section">
                    <h3>Productos (<span id="productosCount">0</span>)</h3>
                    <table class="productos-table">
                        <thead>
                            <tr>
                                <th style="width: 25%">Código</th>
                                <th style="width: 40%">Nombre</th>
                                <th style="width: 20%">Precio</th>
                                <th style="width: 15%"></th>
                            </tr>
                        </thead>
                        <tbody id="productosBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="agregarProducto()">+ Agregar Producto</button>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn-secondary" onclick="window.close()">Cerrar</button>
                <button class="btn-primary" onclick="guardarCambios()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://lecfac-api.onrender.com';
        const facturaId = new URLSearchParams(window.location.search).get('id');
        
        let zoomLevel = 1;
        let rotation = 0;
        let productos = [];
        let productosOriginales = [];
        let imagenCargada = false;

        // Redimensionar paneles
        let isResizing = false;
        const resizeHandle = document.getElementById('resizeHandle');
        const editorContainer = document.getElementById('editorContainer');

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const containerWidth = editorContainer.offsetWidth;
            const leftWidth = (e.clientX / containerWidth) * 100;
            
            if (leftWidth > 30 && leftWidth < 70) {
                editorContainer.style.gridTemplateColumns = `${leftWidth}% ${100 - leftWidth}%`;
                resizeHandle.style.left = `${leftWidth}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
            }
        });
        
        async function cargarFactura() {
            console.log('Cargando factura ID:', facturaId);
            showLoading();
            
            try {
                const response = await fetch(`${API_URL}/admin/facturas/${facturaId}/detalle`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);
                
                // Llenar formulario
                document.getElementById('facturaId').textContent = data.factura.id || '-';
                document.getElementById('establecimiento').value = data.factura.establecimiento || '';
                document.getElementById('total').value = data.factura.total_factura || data.factura.total || '';
                document.getElementById('puntaje').textContent = data.factura.puntaje_calidad || data.factura.puntaje || 0;
                
                const badge = document.getElementById('estadoBadge');
                const estado = data.factura.estado_validacion || data.factura.estado || 'pendiente';
                badge.textContent = estado;
                badge.className = 'validation-badge badge-' + estado;
                
                // Cargar productos
                productos = (data.productos || []).map(p => ({
                    id: p.id,
                    codigo: p.codigo_ean || p.codigo_local || p.codigo || '',
                    nombre: p.nombre_producto || p.nombre || '',
                    precio: p.precio || 0
                }));
                productosOriginales = JSON.parse(JSON.stringify(productos));
                
                console.log('Productos cargados:', productos);
                renderProductos();
                
                // Cargar imagen con manejo de errores
                await cargarImagen();
                
                hideLoading();
            } catch (error) {
                console.error('Error completo:', error);
                alert('Error cargando factura: ' + error.message);
                hideLoading();
            }
        }
        
        // Función mejorada para cargar imagen con verificación previa
        async function cargarImagen() {
            try {
                console.log('Verificando si la factura tiene imagen...');
                // Primero verificamos si existe la imagen
                const checkResponse = await fetch(`${API_URL}/admin/facturas/${facturaId}/check-image`);
                
                if (!checkResponse.ok) {
                    console.error('Error HTTP al verificar imagen:', checkResponse.status);
                    throw new Error(`Error verificando imagen: HTTP ${checkResponse.status}`);
                }
                
                const imageStatus = await checkResponse.json();
                console.log('Estado de la imagen:', imageStatus);
                
                if (imageStatus && imageStatus.tiene_imagen === true) {
                    // La imagen existe, la cargamos
                    console.log('Factura tiene imagen, cargando...');
                    const imgUrl = `${API_URL}/admin/facturas/${facturaId}/imagen`;
                    const imgElement = document.getElementById('facturaImage');
                    
                    // Mostrar spinner mientras se carga
                    const container = document.getElementById('imageContainer');
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'spinner';
                    loadingDiv.id = 'imageLoadingSpinner';
                    container.appendChild(loadingDiv);
                    
                    // Configurar eventos para la imagen
                    imgElement.onload = function() {
                        console.log('Imagen cargada exitosamente');
                        imagenCargada = true;
                        imgElement.style.display = 'block';
                        const spinner = document.getElementById('imageLoadingSpinner');
                        if (spinner) spinner.remove();
                    };
                    
                    imgElement.onerror = function() {
                        console.error('Error cargando la imagen');
                        const spinner = document.getElementById('imageLoadingSpinner');
                        if (spinner) spinner.remove();
                        mostrarMensajeNoImagen('La imagen no pudo ser cargada correctamente.', true);
                    };
                    
                    // Comenzar la carga
                    imgElement.src = imgUrl;
                } else {
                    // No hay imagen
                    console.log('La factura no tiene imagen');
                    mostrarMensajeNoImagen('Esta factura no tiene una imagen asociada.', false);
                }
            } catch (error) {
                console.error('Error verificando o cargando imagen:', error);
                mostrarMensajeNoImagen(`Error: ${error.message}`, true);
            }
        }
        
        function mostrarMensajeNoImagen(mensaje, esError) {
            const container = document.getElementById('imageContainer');
            const imgElement = document.getElementById('facturaImage');
            
            // Ocultar la imagen
            imgElement.style.display = 'none';
            
            // Eliminar spinner de carga si existe
            const spinner = document.getElementById('imageLoadingSpinner');
            if (spinner) spinner.remove();
            
            // Eliminar mensajes previos si existen
            const prevMessage = document.getElementById('noImageMessage');
            if (prevMessage) prevMessage.remove();
            
            // Crear mensaje
            const messageDiv = document.createElement('div');
            messageDiv.id = 'noImageMessage';
            messageDiv.className = 'no-image-message';
            
            messageDiv.innerHTML = `
                <div class="no-image-icon">📷</div>
                <h3 class="no-image-title">${esError ? 'Error en la imagen' : 'No hay imagen disponible'}</h3>
                <p class="no-image-text">${mensaje}</p>
                <button class="btn-upload" onclick="subirNuevaImagen()">Subir Imagen</button>
            `;
            
            container.appendChild(messageDiv);
        }
        
        function subirNuevaImagen() {
            // Crear input file oculto
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            // Manejar selección de archivo
            fileInput.onchange = async (e) => {
                if (e.target.files.length === 0) return;
                
                const file = e.target.files[0];
                const formData = new FormData();
                formData.append('file', file);
                
                showLoading();
                
                try {
                    const response = await fetch(`${API_URL}/admin/facturas/${facturaId}/subir-imagen`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast('✓ Imagen subida correctamente');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        throw new Error(result.message || 'Error al subir la imagen');
                    }
                    
                } catch (error) {
                    console.error('Error subiendo imagen:', error);
                    alert('Error al subir la imagen: ' + error.message);
                } finally {
                    hideLoading();
                    document.body.removeChild(fileInput);
                }
            };
            
            // Abrir diálogo de selección de archivo
            fileInput.click();
        }
        
        function renderProductos() {
            const tbody = document.getElementById('productosBody');
            tbody.innerHTML = '';
            
            productos.forEach((prod, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${prod.codigo || ''}" onchange="productos[${index}].codigo = this.value.trim()"></td>
                    <td><input type="text" value="${prod.nombre || ''}" onchange="productos[${index}].nombre = this.value.trim()"></td>
                    <td><input type="number" step="0.01" value="${prod.precio || 0}" onchange="productos[${index}].precio = parseFloat(this.value)"></td>
                    <td><button class="btn-delete" onclick="eliminarProducto(${index})">×</button></td>
                `;
            });
            
            document.getElementById('productosCount').textContent = productos.length;
        }
        
        function agregarProducto() {
            productos.push({ codigo: '', nombre: '', precio: 0, nuevo: true });
            renderProductos();
            
            const formContent = document.querySelector('.form-content');
            setTimeout(() => {
                formContent.scrollTop = formContent.scrollHeight;
                const tbody = document.getElementById('productosBody');
                tbody.lastElementChild.querySelector('input').focus();
            }, 100);
        }
        
        async function eliminarProducto(index) {
            if (!confirm('¿Eliminar este producto?')) return;
            
            const prod = productos[index];
            
            if (!prod.nuevo && prod.id) {
                try {
                    await fetch(`${API_URL}/admin/productos/${prod.id}`, { method: 'DELETE' });
                    showToast('Producto eliminado');
                } catch (e) {
                    console.error('Error eliminando:', e);
                }
            }
            
            productos.splice(index, 1);
            renderProductos();
        }
        
        async function guardarCambios() {
            showLoading();
            
            try {
                // Guardar datos generales
                await fetch(`${API_URL}/admin/facturas/${facturaId}/datos-generales`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        establecimiento: document.getElementById('establecimiento').value,
                        total: parseFloat(document.getElementById('total').value) || 0
                    })
                });
                
                // Actualizar productos existentes
                for (const prod of productos) {
                    if (!prod.nuevo && prod.id) {
                        await fetch(`${API_URL}/admin/productos/${prod.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(prod)
                        });
                    }
                }
                
                // Agregar productos nuevos
                for (const prod of productos) {
                    if (prod.nuevo && prod.codigo && prod.nombre) {
                        await fetch(`${API_URL}/admin/facturas/${facturaId}/productos`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(prod)
                        });
                    }
                }
                
                showToast('✓ Cambios guardados exitosamente');
                setTimeout(() => cargarFactura(), 1500);
                
            } catch (error) {
                alert('Error guardando: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Controles de zoom
        function zoomIn() {
            if (!imagenCargada) return;
            zoomLevel *= 1.2;
            updateZoom();
        }
        
        function zoomOut() {
            if (!imagenCargada) return;
            zoomLevel /= 1.2;
            updateZoom();
        }
        
        function resetZoom() {
            if (!imagenCargada) return;
            zoomLevel = 1;
            rotation = 0;
            updateZoom();
        }
        
        function rotateImage() {
            if (!imagenCargada) return;
            rotation = (rotation + 90) % 360;
            updateZoom();
        }
        
        function updateZoom() {
            const img = document.getElementById('facturaImage');
            img.style.transform = `scale(${zoomLevel}) rotate(${rotation}deg)`;
            document.getElementById('zoomInfo').textContent = Math.round(zoomLevel * 100) + '%';
        }
        
        // Pan
        let isPanning = false;
        let startX, startY, scrollLeft, scrollTop;
        
        const imageContainer = document.getElementById('imageContainer');
        imageContainer.addEventListener('mousedown', (e) => {
            if (!imagenCargada) return;
            
            isPanning = true;
            startX = e.pageX - imageContainer.offsetLeft;
            startY = e.pageY - imageContainer.offsetTop;
            scrollLeft = imageContainer.scrollLeft;
            scrollTop = imageContainer.scrollTop;
        });
        
        imageContainer.addEventListener('mouseleave', () => isPanning = false);
        imageContainer.addEventListener('mouseup', () => isPanning = false);
        
        imageContainer.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault();
            const x = e.pageX - imageContainer.offsetLeft;
            const y = e.pageY - imageContainer.offsetTop;
            imageContainer.scrollLeft = scrollLeft - (x - startX);
            imageContainer.scrollTop = scrollTop - (y - startY);
        });
        
        function showLoading() {
            const overlay = document.createElement('div');
            overlay.className = 'loading';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = '<div class="spinner"></div>';
            document.body.appendChild(overlay);
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Atajos
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                guardarCambios();
            }
        });
        
        // Iniciar carga
        cargarFactura();
    </script>
</body>
</html>
