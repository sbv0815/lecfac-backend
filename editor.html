<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Factura - LecFac</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 55% 45%;
            height: 100vh;
            position: relative;
        }

        .resize-handle {
            position: absolute;
            left: 55%;
            top: 0;
            bottom: 0;
            width: 8px;
            background: #ddd;
            cursor: col-resize;
            z-index: 1000;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: #1a73e8;
        }

        .image-panel {
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .image-controls {
            background: #2d2d2d;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }

        .image-controls button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .image-controls button:hover {
            background: #5a5a5a;
        }

        .zoom-info {
            color: #aaa;
            margin-left: auto;
            font-size: 14px;
        }

        .image-container {
            flex: 1;
            overflow: auto;
            background: #1a1a1a;
            padding: 20px;
        }

        .image-container img {
            display: block;
            max-width: none;
            width: auto;
            height: auto;
            cursor: grab;
            transition: transform 0.1s;
        }

        .image-container:active img {
            cursor: grabbing;
        }

        .form-panel {
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .form-header {
            background: #1a73e8;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .validation-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-validada {
            background: #34a853;
        }

        .badge-revisada {
            background: #34a853;
        }

        .badge-revision_requerida {
            background: #fbbc04;
            color: #000;
        }

        .badge-pendiente {
            background: #ea4335;
        }

        .badge-procesado {
            background: #4285f4;
        }

        .form-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .form-content::-webkit-scrollbar,
        .image-container::-webkit-scrollbar {
            width: 12px;
        }

        .form-content::-webkit-scrollbar-track,
        .image-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .form-content::-webkit-scrollbar-thumb,
        .image-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }

        .form-content::-webkit-scrollbar-thumb:hover,
        .image-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 10;
        }

        .field-group {
            margin-bottom: 15px;
        }

        .field-group label {
            display: block;
            font-size: 13px;
            color: #333;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .field-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .field-group input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .productos-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 10px;
        }

        .productos-table thead {
            position: sticky;
            top: 40px;
            background: white;
            z-index: 9;
        }

        .productos-table th {
            background: #f5f5f5;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #ddd;
        }

        .productos-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .productos-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .productos-table input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .btn-delete {
            background: #ea4335;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete:hover {
            background: #d33;
        }

        .btn-add {
            background: #34a853;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #2d9148;
        }

        .form-actions {
            padding: 20px;
            background: #f9f9f9;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .btn-primary {
            flex: 1;
            background: #1a73e8;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        .btn-secondary {
            background: #5f6368;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #3c4043;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #34a853;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }

            to {
                transform: translateX(0);
            }
        }

        .debug-section {
            margin-top: 20px;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
        }

        .debug-toggle {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            width: 100%;
            text-align: left;
        }

        .debug-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow: auto;
            max-height: 200px;
        }
    </style>
</head>

<body>
    <div class="editor-container">
        <div class="resize-handle" id="resizeHandle"></div>

        <div class="image-panel">
            <div class="image-controls">
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomOut()">-</button>
                <button onclick="resetZoom()">Reset</button>
                <button onclick="rotateImage()">Rotar</button>
                <span class="zoom-info" id="zoomInfo">100%</span>
            </div>
            <div class="image-container" id="imageContainer">
                <img id="facturaImage" src="" alt="Factura" style="display:none;">
            </div>
        </div>

        <div class="form-panel">
            <div class="form-header">
                <div>
                    <h2>Factura #<span id="facturaId">-</span></h2>
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                        Puntaje: <span id="puntaje">-</span>/100
                    </div>
                </div>
                <span class="validation-badge" id="estadoBadge">Pendiente</span>
            </div>

            <div class="form-content">
                <div class="form-section">
                    <h3>Datos Generales</h3>
                    <div class="field-group">
                        <label>Establecimiento</label>
                        <input type="text" id="establecimiento" placeholder="Ej: Jumbo Bulevar">
                    </div>
                    <div class="field-group">
                        <label>Total ($)</label>
                        <input type="number" id="total" step="0.01" placeholder="0.00">
                    </div>
                    <div class="field-group">
                        <label>Fecha</label>
                        <input type="date" id="fecha">
                    </div>
                </div>

                <div class="form-section">
                    <h3>Productos (<span id="productosCount">0</span>)</h3>
                    <table class="productos-table">
                        <thead>
                            <tr>
                                <th style="width: 25%">C√≥digo</th>
                                <th style="width: 40%">Nombre</th>
                                <th style="width: 20%">Precio</th>
                                <th style="width: 15%"></th>
                            </tr>
                        </thead>
                        <tbody id="productosBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999; padding: 20px;">
                                    Cargando productos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn-add" onclick="agregarProducto()">+ Agregar Producto</button>
                </div>

                <div class="debug-section">
                    <button class="debug-toggle" onclick="toggleDebugInfo()">
                        üîç Mostrar/Ocultar Datos Crudos (Debug)
                    </button>
                    <pre class="debug-content" id="debugInfo">Cargando...</pre>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="window.close()">Cerrar</button>
                <button class="btn-primary" onclick="guardarCambios()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://lecfac-api-production.up.railway.app';  // ‚úÖ CORRECTO
        const facturaId = new URLSearchParams(window.location.search).get('id');

        let zoomLevel = 1;
        let rotation = 0;
        let productos = [];
        let facturaOriginal = null;

        let isResizing = false;
        const resizeHandle = document.getElementById('resizeHandle');
        const editorContainer = document.querySelector('.editor-container');

        // ========================================
        // RESIZE PANEL
        // ========================================
        resizeHandle.addEventListener('mousedown', () => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const containerWidth = editorContainer.offsetWidth;
            const leftWidth = (e.clientX / containerWidth) * 100;

            if (leftWidth > 30 && leftWidth < 70) {
                editorContainer.style.gridTemplateColumns = `${leftWidth}% ${100 - leftWidth}%`;
                resizeHandle.style.left = `${leftWidth}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
            }
        });

        // ========================================
        // UI HELPERS
        // ========================================
        function showLoading() {
            const overlay = document.createElement('div');
            overlay.className = 'loading';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = '<div class="spinner"></div>';
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? '#ea4335' : '#34a853';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleDebugInfo() {
            const debugContent = document.getElementById('debugInfo');
            debugContent.style.display = debugContent.style.display === 'block' ? 'none' : 'block';
        }

        // ========================================
        // IMAGE CONTROLS
        // ========================================
        function zoomIn() {
            zoomLevel *= 1.2;
            updateZoom();
        }

        function zoomOut() {
            zoomLevel /= 1.2;
            updateZoom();
        }

        function resetZoom() {
            zoomLevel = 1;
            rotation = 0;
            updateZoom();
        }

        function rotateImage() {
            rotation = (rotation + 90) % 360;
            updateZoom();
        }

        function updateZoom() {
            const img = document.getElementById('facturaImage');
            img.style.transform = `scale(${zoomLevel}) rotate(${rotation}deg)`;
            document.getElementById('zoomInfo').textContent = Math.round(zoomLevel * 100) + '%';
        }

        // ========================================
        // IMAGE PANNING
        // ========================================
        let isPanning = false;
        let startX, startY, scrollLeft, scrollTop;

        const imageContainer = document.getElementById('imageContainer');
        imageContainer.addEventListener('mousedown', (e) => {
            if (e.target.tagName !== 'IMG') return;
            isPanning = true;
            startX = e.pageX - imageContainer.offsetLeft;
            startY = e.pageY - imageContainer.offsetTop;
            scrollLeft = imageContainer.scrollLeft;
            scrollTop = imageContainer.scrollTop;
        });

        imageContainer.addEventListener('mouseleave', () => isPanning = false);
        imageContainer.addEventListener('mouseup', () => isPanning = false);

        imageContainer.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault();
            const x = e.pageX - imageContainer.offsetLeft;
            const y = e.pageY - imageContainer.offsetTop;
            imageContainer.scrollLeft = scrollLeft - (x - startX);
            imageContainer.scrollTop = scrollTop - (y - startY);
        });

        // ========================================
        // PRODUCTOS MANAGEMENT
        // ========================================
        function renderProductos() {
            const tbody = document.getElementById('productosBody');

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">No hay productos. Haz clic en "Agregar Producto"</td></tr>';
                document.getElementById('productosCount').textContent = '0';
                return;
            }

            tbody.innerHTML = '';

            productos.forEach((prod, index) => {
                const row = tbody.insertRow();

                const codigo = prod.codigo || prod.codigo_ean || '';
                const nombre = prod.nombre || '';
                const precio = prod.precio || 0;

                row.innerHTML = `
            <td><input type="text" value="${codigo}" onchange="actualizarProducto(${index}, 'codigo', this.value)"></td>
            <td><input type="text" value="${nombre}" onchange="actualizarProducto(${index}, 'nombre', this.value)"></td>
            <td><input type="number" step="0.01" value="${precio}" onchange="actualizarProducto(${index}, 'precio', parseFloat(this.value) || 0)"></td>
            <td><button class="btn-delete" onclick="eliminarProducto(${index})">√ó</button></td>
        `;
            });

            document.getElementById('productosCount').textContent = productos.length;
        }

        function actualizarProducto(index, campo, valor) {
            if (index >= 0 && index < productos.length) {
                productos[index][campo] = valor;
                console.log(`‚úì Producto ${index} actualizado:`, campo, '=', valor);
            }
        }

        function agregarProducto() {
            productos.push({
                codigo: '',
                nombre: 'Nuevo Producto',
                precio: 0,
                nuevo: true
            });

            renderProductos();

            const tbody = document.getElementById('productosBody');
            const lastRow = tbody.lastElementChild;
            if (lastRow) {
                const firstInput = lastRow.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }

            showToast('Producto agregado');
        }

        async function eliminarProducto(index) {
            if (!confirm('¬øEliminar este producto?')) return;

            const prod = productos[index];
            console.log('üóëÔ∏è Intentando eliminar producto:', prod);

            // Si el producto existe en el servidor, eliminarlo primero
            if (!prod.nuevo && prod.id) {
                try {
                    showLoading();
                    console.log(`üì° DELETE ${API_URL}/admin/items/${prod.id}`);

                    const response = await fetch(`${API_URL}/admin/items/${prod.id}`, {
                        method: 'DELETE'
                    });

                    console.log('üì• Response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }

                    console.log('‚úÖ Producto eliminado del servidor');
                    showToast('‚úÖ Producto eliminado');
                } catch (e) {
                    console.error('‚ùå Error eliminando:', e);
                    showToast('Error al eliminar: ' + e.message, 'error');
                    hideLoading();
                    return;
                } finally {
                    hideLoading();
                }
            }

            // Eliminar del array local
            productos.splice(index, 1);
            renderProductos();
        }

        // ========================================
        // CARGAR FACTURA
        // ========================================
        async function cargarFactura() {
            console.log('üîÑ Cargando factura ID:', facturaId);

            if (!facturaId) {
                alert('‚ùå Error: No se especific√≥ ID de factura');
                return;
            }

            showLoading();

            try {
                console.log(`üì° GET ${API_URL}/admin/facturas/${facturaId}`);

                const response = await fetch(`${API_URL}/admin/facturas/${facturaId}`);

                console.log('üì• Status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const factura = await response.json();
                console.log('‚úÖ Factura recibida:', factura);

                // Guardar factura original
                facturaOriginal = factura;
                document.getElementById('debugInfo').textContent = JSON.stringify(factura, null, 2);

                // Cargar datos generales
                document.getElementById('facturaId').textContent = factura.id || '-';
                document.getElementById('establecimiento').value = factura.establecimiento || '';
                document.getElementById('total').value = factura.total || factura.total_factura || 0;

                // Cargar fecha
                if (factura.fecha) {
                    try {
                        let fechaStr = factura.fecha;
                        if (typeof fechaStr === 'string') {
                            if (fechaStr.includes('T')) {
                                fechaStr = fechaStr.split('T')[0];
                            }
                        }
                        document.getElementById('fecha').value = fechaStr;
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error parseando fecha:', e);
                    }
                }

                // Cargar estado
                const estado = factura.estado || factura.estado_validacion || 'pendiente';
                const estadoBadge = document.getElementById('estadoBadge');
                estadoBadge.textContent = estado;
                estadoBadge.className = 'validation-badge badge-' + estado.toLowerCase().replace(' ', '_');

                // Cargar puntaje
                if (factura.puntaje !== undefined && factura.puntaje !== null) {
                    document.getElementById('puntaje').textContent = factura.puntaje;
                }

                // Cargar productos
                console.log('üîç Procesando productos...');
                console.log('factura.productos:', factura.productos);
                console.log('Es array?', Array.isArray(factura.productos));
                console.log('Cantidad:', factura.productos?.length || 0);

                if (!factura.productos || !Array.isArray(factura.productos)) {
                    console.warn('‚ö†Ô∏è No hay productos o no es array');
                    productos = [];
                } else {
                    productos = factura.productos.map((p, index) => {
                        console.log(`  Producto ${index}:`, p);

                        return {
                            id: p.id,
                            codigo: p.codigo || p.codigo_ean || p.codigo_local || '',
                            nombre: p.nombre || p.nombre_producto || p.descripcion || 'Sin nombre',
                            precio: parseFloat(p.precio) || parseFloat(p.valor) || parseFloat(p.precio_unitario) || 0,
                            nuevo: false
                        };
                    });

                    console.log('‚úÖ Productos mapeados:', productos);
                }

                renderProductos();
                await cargarImagen();

                console.log('‚úÖ Factura cargada completamente');

            } catch (error) {
                console.error('‚ùå ERROR:', error);
                alert(`Error al cargar:\n${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // CARGAR IMAGEN
        // ========================================
        async function cargarImagen() {
            const img = document.getElementById('facturaImage');
            const container = document.getElementById('imageContainer');

            try {
                console.log('üì∑ Cargando imagen...');

                const timestamp = Date.now();
                const imageUrl = `${API_URL}/admin/facturas/${facturaId}/imagen?t=${timestamp}`;

                img.onload = () => {
                    console.log('‚úÖ Imagen cargada');
                    img.style.display = 'block';
                    resetZoom();
                };

                img.onerror = () => {
                    console.error('‚ùå No hay imagen');
                    img.style.display = 'none';
                    container.innerHTML = `
                <div style="color: white; text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üì∏</div>
                    <h3>Esta factura no tiene imagen</h3>
                    <p style="color: #999; margin-top: 10px;">La imagen no se guard√≥ durante el procesamiento</p>
                </div>
            `;
                };

                img.src = imageUrl;

            } catch (error) {
                console.error('‚ùå Error en cargarImagen:', error);
            }
        }

        // ========================================
        // üîß GUARDAR CAMBIOS - VERSI√ìN CORREGIDA
        // ========================================
        async function guardarCambios() {
            console.log('üíæ ============================================');
            console.log('üíæ INICIANDO GUARDADO DE CAMBIOS');
            console.log('üíæ ============================================');
            showLoading();

            try {
                // ====================================
                // 1. GUARDAR DATOS GENERALES
                // ====================================
                const fechaValue = document.getElementById('fecha').value || null;

                const datosGenerales = {
                    establecimiento: document.getElementById('establecimiento').value.trim(),
                    total: parseFloat(document.getElementById('total').value) || 0
                };

                if (fechaValue) {
                    datosGenerales.fecha = fechaValue;
                }

                console.log('üìù Datos generales a guardar:');
                console.log('   - Establecimiento:', datosGenerales.establecimiento);
                console.log('   - Total:', datosGenerales.total);
                console.log('   - Fecha:', datosGenerales.fecha || 'sin cambios');
                console.log(`üì° PUT ${API_URL}/admin/facturas/${facturaId}`);

                const respGeneral = await fetch(`${API_URL}/admin/facturas/${facturaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosGenerales)
                });

                console.log('üì• Response status (datos generales):', respGeneral.status);

                if (!respGeneral.ok) {
                    const errorText = await respGeneral.text();
                    console.error('‚ùå Error en datos generales:', errorText);
                    throw new Error(`Error datos generales: ${errorText}`);
                }

                console.log('‚úÖ Datos generales guardados');

                // ====================================
                // 2. ACTUALIZAR PRODUCTOS EXISTENTES
                // ====================================
                console.log('\nüîÑ Actualizando productos existentes...');
                let productosActualizados = 0;

                for (const prod of productos) {
                    if (!prod.nuevo && prod.id) {
                        console.log(`\n  üì¶ Producto #${prod.id}:`);
                        console.log(`     - Nombre: ${prod.nombre}`);
                        console.log(`     - Precio: ${prod.precio}`);
                        console.log(`     - C√≥digo: ${prod.codigo || '(vac√≠o)'}`);

                        // üîß FIX CR√çTICO: Solo enviar c√≥digo si NO est√° vac√≠o
                        const itemData = {
                            nombre: prod.nombre.trim(),
                            precio: parseFloat(prod.precio) || 0
                        };

                        // Solo incluir c√≥digo si tiene valor
                        if (prod.codigo && prod.codigo.trim() !== '') {
                            itemData.codigo_ean = prod.codigo.trim();
                            console.log(`     ‚úì Enviando c√≥digo: ${itemData.codigo_ean}`);
                        } else {
                            console.log(`     ‚ö†Ô∏è C√≥digo vac√≠o - NO se enviar√° (se preserva el existente)`);
                        }

                        console.log(`     üì° PUT ${API_URL}/admin/items/${prod.id}`);
                        console.log('     üì§ Payload:', JSON.stringify(itemData));

                        const respProd = await fetch(`${API_URL}/admin/items/${prod.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(itemData)
                        });

                        console.log('     üì• Response status:', respProd.status);

                        if (!respProd.ok) {
                            const respText = await respProd.text();
                            console.error(`     ‚ùå Error actualizando item ${prod.id}`);
                            console.error('     ‚ùå Response:', respText);
                            throw new Error(`Error actualizando producto ${prod.nombre}: ${respText}`);
                        } else {
                            const respData = await respProd.json();
                            console.log('     ‚úÖ Item actualizado:', respData);
                            productosActualizados++;
                        }
                    }
                }

                console.log(`\n‚úÖ ${productosActualizados} productos actualizados`);

                // ====================================
                // 3. CREAR PRODUCTOS NUEVOS
                // ====================================
                console.log('\n‚ûï Creando productos nuevos...');
                let productosCreados = 0;

                for (const prod of productos) {
                    if (prod.nuevo && prod.nombre && prod.nombre.trim() !== '') {
                        console.log(`\n  üÜï Nuevo producto:`);
                        console.log(`     - Nombre: ${prod.nombre}`);
                        console.log(`     - Precio: ${prod.precio}`);
                        console.log(`     - C√≥digo: ${prod.codigo || '(sin c√≥digo)'}`);

                        const nuevoItemData = {
                            nombre: prod.nombre.trim(),
                            precio: parseFloat(prod.precio) || 0
                        };

                        // Solo incluir c√≥digo si tiene valor
                        if (prod.codigo && prod.codigo.trim() !== '') {
                            nuevoItemData.codigo_ean = prod.codigo.trim();
                            console.log(`     ‚úì Con c√≥digo: ${nuevoItemData.codigo_ean}`);
                        }

                        console.log(`     üì° POST ${API_URL}/admin/facturas/${facturaId}/items`);
                        console.log('     üì§ Payload:', JSON.stringify(nuevoItemData));

                        const respNuevo = await fetch(`${API_URL}/admin/facturas/${facturaId}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(nuevoItemData)
                        });

                        console.log('     üì• Response status:', respNuevo.status);

                        if (!respNuevo.ok) {
                            const respText = await respNuevo.text();
                            console.error('     ‚ùå Error creando item');
                            console.error('     ‚ùå Response:', respText);
                            throw new Error(`Error creando producto ${prod.nombre}: ${respText}`);
                        } else {
                            const respData = await respNuevo.json();
                            console.log('     ‚úÖ Item creado:', respData);
                            productosCreados++;
                        }
                    }
                }

                console.log(`\n‚úÖ ${productosCreados} productos nuevos creados`);

                // ====================================
                // 4. FINALIZAR
                // ====================================
                console.log('\nüíæ ============================================');
                console.log('üíæ GUARDADO COMPLETADO EXITOSAMENTE');
                console.log(`üíæ - Datos generales: ‚úÖ`);
                console.log(`üíæ - Productos actualizados: ${productosActualizados}`);
                console.log(`üíæ - Productos nuevos: ${productosCreados}`);
                console.log('üíæ ============================================\n');

                showToast('‚úÖ Cambios guardados exitosamente');

                // Recargar factura despu√©s de 1.5 segundos
                setTimeout(() => {
                    console.log('üîÑ Recargando factura...');
                    cargarFactura();
                }, 1500);

            } catch (error) {
                console.error('\n‚ùå ============================================');
                console.error('‚ùå ERROR AL GUARDAR');
                console.error('‚ùå ============================================');
                console.error('‚ùå Error:', error);
                console.error('‚ùå Stack:', error.stack);
                console.error('‚ùå ============================================\n');

                showToast('‚ùå Error al guardar: ' + error.message, 'error');
                alert(`Error al guardar:\n\n${error.message}\n\nRevisa la consola para m√°s detalles.`);
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================
        document.addEventListener('keydown', (e) => {
            // Ctrl+S para guardar
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                guardarCambios();
            }

            // Ctrl+N para agregar producto
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                agregarProducto();
            }
        });

        // ========================================
        // INICIALIZAR
        // ========================================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ ============================================');
            console.log('üöÄ LECFAC EDITOR INICIADO');
            console.log('üöÄ ============================================');
            console.log('üöÄ Factura ID:', facturaId);
            console.log('üöÄ API URL:', API_URL);
            console.log('üöÄ ============================================\n');
            cargarFactura();
        });
    </script>
</body>

</html>
