<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LecFac - Uso de API</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 span {
            font-size: 32px;
        }

        .btn-refresh {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Cards de resumen */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-value.small {
            font-size: 24px;
        }

        .card-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .card-sublabel {
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            margin-top: 5px;
        }

        .card.highlight {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .card.green {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.2) 0%, rgba(0, 206, 201, 0.2) 100%);
            border-color: rgba(0, 184, 148, 0.4);
        }

        .card.orange {
            background: linear-gradient(135deg, rgba(253, 203, 110, 0.2) 0%, rgba(225, 112, 85, 0.2) 100%);
            border-color: rgba(253, 203, 110, 0.4);
        }

        /* Secciones */
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Gr√°fica */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Grid 2 columnas */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        /* Tablas */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.green {
            background: linear-gradient(90deg, #00b894, #00cec9);
        }

        .progress-fill.yellow {
            background: linear-gradient(90deg, #fdcb6e, #e17055);
        }

        .progress-fill.red {
            background: linear-gradient(90deg, #e17055, #d63031);
        }

        .progress-fill.blue {
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        /* Badge */
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge.ocr {
            background: rgba(102, 126, 234, 0.3);
            color: #a29bfe;
        }

        .badge.menu {
            background: rgba(0, 184, 148, 0.3);
            color: #00b894;
        }

        .badge.test {
            background: rgba(253, 203, 110, 0.3);
            color: #fdcb6e;
        }

        .badge.other {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #00b894;
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #d63031;
        }

        /* Valor monetario */
        .money {
            color: #00b894;
            font-weight: 600;
        }

        /* Operaci√≥n item */
        .operacion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .operacion-info {
            flex: 1;
        }

        .operacion-nombre {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .operacion-stats {
            display: flex;
            gap: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
        }

        .operacion-costo {
            text-align: right;
        }

        .operacion-costo .valor {
            font-size: 20px;
            font-weight: bold;
            color: #00b894;
        }

        .operacion-costo .label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Info box */
        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 15px 20px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .info-box-icon {
            font-size: 24px;
        }

        .info-box-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .operacion-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .operacion-stats {
                justify-content: center;
            }
        }

        /* Mes indicator */
        .mes-indicator {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .mes-indicator .dot {
            width: 8px;
            height: 8px;
            background: #00b894;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><span>üìä</span> Uso de API - LecFac</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="mes-indicator">
                    <span class="dot"></span>
                    <span id="mesActual">Cargando...</span>
                </div>
                <button class="btn-refresh" onclick="cargarDatos()">
                    üîÑ Actualizar
                </button>
            </div>
        </div>

        <!-- Cards de resumen -->
        <div class="cards-grid" id="cardsResumen">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Grid 2 columnas -->
        <div class="grid-2">
            <!-- Desglose por operaci√≥n -->
            <div class="section">
                <div class="section-header">
                    <h2>üîß Consumo por Operaci√≥n</h2>
                </div>
                <div id="listaOperaciones">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fica de distribuci√≥n -->
            <div class="section">
                <div class="section-header">
                    <h2>üìà Distribuci√≥n de Costos</h2>
                </div>
                <div class="chart-container">
                    <canvas id="chartDistribucion"></canvas>
                </div>
            </div>
        </div>

        <!-- M√©tricas calculadas -->
        <div class="section">
            <div class="section-header">
                <h2>üìê M√©tricas Calculadas</h2>
            </div>
            <div class="cards-grid" id="metricsCards" style="margin-bottom: 0;">
                <!-- Se llena din√°micamente -->
            </div>

            <div class="info-box">
                <span class="info-box-icon">üí°</span>
                <span class="info-box-text" id="infoProyeccion">Calculando proyecci√≥n...</span>
            </div>
        </div>

        <!-- Tabla detallada -->
        <div class="section">
            <div class="section-header">
                <h2>üìã Detalle por Operaci√≥n</h2>
            </div>
            <div class="table-container">
                <table id="tablaDetalle">
                    <thead>
                        <tr>
                            <th>Operaci√≥n</th>
                            <th>Llamadas</th>
                            <th>Tokens</th>
                            <th>% del Total</th>
                            <th>Costo USD</th>
                            <th>Costo COP</th>
                        </tr>
                    </thead>
                    <tbody id="tablaDetalleBody">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuraci√≥n
        const API_BASE = window.location.origin;
        const TASA_COP = 4200; // Tasa de cambio aproximada
        let chartDistribucion = null;

        // Mostrar toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '') + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Formatear n√∫meros
        function formatNumber(num) {
            return new Intl.NumberFormat('es-CO').format(num);
        }

        function formatUSD(num) {
            return '$' + num.toFixed(4);
        }

        function formatCOP(usd) {
            return '$' + formatNumber(Math.round(usd * TASA_COP));
        }

        // Obtener badge class seg√∫n operaci√≥n
        function getBadgeClass(operacion) {
            if (operacion.includes('ocr') || operacion.includes('factura')) return 'ocr';
            if (operacion.includes('menu')) return 'menu';
            if (operacion.includes('test')) return 'test';
            return 'other';
        }

        // Obtener nombre legible de operaci√≥n
        function getNombreOperacion(key) {
            const nombres = {
                'ocr_factura': 'üßæ OCR de Facturas',
                'generar_menu': 'üçΩÔ∏è Generaci√≥n de Men√∫s',
                'test': 'üß™ Pruebas',
                'analisis': 'üìä An√°lisis',
                'matching': 'üîó Matching de Productos'
            };
            return nombres[key] || 'üìå ' + key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Cargar datos
        async function cargarDatos() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/uso-api/resumen?dias=30`);
                const data = await response.json();

                console.log('Datos recibidos:', data);

                if (data.success) {
                    // Actualizar indicador de mes
                    const ahora = new Date();
                    document.getElementById('mesActual').textContent =
                        ahora.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' });

                    renderCards(data.mes_actual);
                    renderOperaciones(data.por_operacion, data.mes_actual);
                    renderChart(data.por_operacion);
                    renderMetricas(data.mes_actual, data.por_operacion);
                    renderTabla(data.por_operacion, data.mes_actual);

                    showToast('‚úÖ Datos actualizados');
                } else {
                    showToast('Error al cargar datos', true);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexi√≥n: ' + error.message, true);

                // Mostrar error en cards
                document.getElementById('cardsResumen').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                        ‚ùå Error al cargar datos. Verifica la conexi√≥n.
                    </div>
                `;
            }
        }

        // Renderizar cards principales
        function renderCards(mesActual) {
            const container = document.getElementById('cardsResumen');

            const costoPromedio = mesActual.operaciones > 0
                ? mesActual.costo_usd / mesActual.operaciones
                : 0;

            container.innerHTML = `
                <div class="card highlight">
                    <div class="card-icon">üí∞</div>
                    <div class="card-value">${formatUSD(mesActual.costo_usd)}</div>
                    <div class="card-label">Costo Total USD</div>
                    <div class="card-sublabel">${formatCOP(mesActual.costo_usd)} COP</div>
                </div>
                <div class="card">
                    <div class="card-icon">üî¢</div>
                    <div class="card-value">${formatNumber(mesActual.tokens)}</div>
                    <div class="card-label">Tokens Consumidos</div>
                    <div class="card-sublabel">Este mes</div>
                </div>
                <div class="card">
                    <div class="card-icon">üìû</div>
                    <div class="card-value">${mesActual.operaciones}</div>
                    <div class="card-label">Operaciones API</div>
                    <div class="card-sublabel">Llamadas totales</div>
                </div>
                <div class="card">
                    <div class="card-icon">üë•</div>
                    <div class="card-value">${mesActual.usuarios_activos}</div>
                    <div class="card-label">Usuarios Activos</div>
                    <div class="card-sublabel">Este mes</div>
                </div>
                <div class="card green">
                    <div class="card-icon">üìä</div>
                    <div class="card-value small">${formatUSD(costoPromedio)}</div>
                    <div class="card-label">Costo Promedio</div>
                    <div class="card-sublabel">Por operaci√≥n</div>
                </div>
            `;
        }

        // Renderizar lista de operaciones
        function renderOperaciones(porOperacion, mesActual) {
            const container = document.getElementById('listaOperaciones');

            if (!porOperacion || Object.keys(porOperacion).length === 0) {
                container.innerHTML = '<p style="text-align:center; color:rgba(255,255,255,0.5);">No hay operaciones registradas</p>';
                return;
            }

            let html = '';

            // Ordenar por costo descendente
            const operacionesOrdenadas = Object.entries(porOperacion)
                .sort((a, b) => b[1].costo_usd - a[1].costo_usd);

            operacionesOrdenadas.forEach(([key, op]) => {
                const porcentaje = mesActual.costo_usd > 0
                    ? (op.costo_usd / mesActual.costo_usd * 100)
                    : 0;

                html += `
                    <div class="operacion-item">
                        <div class="operacion-info">
                            <div class="operacion-nombre">
                                ${getNombreOperacion(key)}
                                <span class="badge ${getBadgeClass(key)}">${key}</span>
                            </div>
                            <div class="operacion-stats">
                                <span>üìû ${op.operaciones} llamadas</span>
                                <span>üî¢ ${formatNumber(op.tokens)} tokens</span>
                            </div>
                            <div class="progress-bar" style="max-width: 300px;">
                                <div class="progress-fill blue" style="width: ${porcentaje}%"></div>
                            </div>
                        </div>
                        <div class="operacion-costo">
                            <div class="valor">${formatUSD(op.costo_usd)}</div>
                            <div class="label">${porcentaje.toFixed(1)}% del total</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Renderizar gr√°fica
        function renderChart(porOperacion) {
            const ctx = document.getElementById('chartDistribucion').getContext('2d');

            if (chartDistribucion) {
                chartDistribucion.destroy();
            }

            const labels = Object.keys(porOperacion).map(k => getNombreOperacion(k).replace(/^.+\s/, ''));
            const data = Object.values(porOperacion).map(op => op.costo_usd);
            const colors = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(0, 184, 148, 0.8)',
                'rgba(253, 203, 110, 0.8)',
                'rgba(225, 112, 85, 0.8)',
                'rgba(162, 155, 254, 0.8)'
            ];

            chartDistribucion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'rgba(26, 26, 46, 0.8)',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255,255,255,0.8)',
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${formatUSD(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Renderizar m√©tricas calculadas
        function renderMetricas(mesActual, porOperacion) {
            const container = document.getElementById('metricsCards');

            // Calcular m√©tricas
            const tokensPromedio = mesActual.operaciones > 0
                ? Math.round(mesActual.tokens / mesActual.operaciones)
                : 0;

            const costoOCR = porOperacion.ocr_factura?.costo_usd || 0;
            const operacionesOCR = porOperacion.ocr_factura?.operaciones || 0;
            const costoPromedioFactura = operacionesOCR > 0 ? costoOCR / operacionesOCR : 0;

            // Proyecci√≥n mensual (asumiendo d√≠a actual del mes)
            const hoy = new Date();
            const diaDelMes = hoy.getDate();
            const diasEnMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).getDate();
            const proyeccionMensual = (mesActual.costo_usd / diaDelMes) * diasEnMes;

            container.innerHTML = `
                <div class="card">
                    <div class="card-icon">‚ö°</div>
                    <div class="card-value">${formatNumber(tokensPromedio)}</div>
                    <div class="card-label">Tokens / Operaci√≥n</div>
                    <div class="card-sublabel">Promedio</div>
                </div>
                <div class="card">
                    <div class="card-icon">üßæ</div>
                    <div class="card-value small">${formatUSD(costoPromedioFactura)}</div>
                    <div class="card-label">Costo / Factura OCR</div>
                    <div class="card-sublabel">${formatCOP(costoPromedioFactura)} COP</div>
                </div>
                <div class="card orange">
                    <div class="card-icon">üìÖ</div>
                    <div class="card-value small">${formatUSD(proyeccionMensual)}</div>
                    <div class="card-label">Proyecci√≥n Mes</div>
                    <div class="card-sublabel">${formatCOP(proyeccionMensual)} COP</div>
                </div>
            `;

            // Info de proyecci√≥n
            document.getElementById('infoProyeccion').innerHTML = `
                <strong>Proyecci√≥n:</strong> Al ritmo actual (d√≠a ${diaDelMes} de ${diasEnMes}),
                el gasto mensual ser√≠a de <strong class="money">${formatUSD(proyeccionMensual)}</strong>
                (${formatCOP(proyeccionMensual)} COP).
                Costo promedio por factura: <strong class="money">${formatCOP(costoPromedioFactura)} COP</strong>
            `;
        }

        // Renderizar tabla detallada
        function renderTabla(porOperacion, mesActual) {
            const tbody = document.getElementById('tablaDetalleBody');

            if (!porOperacion || Object.keys(porOperacion).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay datos</td></tr>';
                return;
            }

            let html = '';
            let totalOps = 0, totalTokens = 0, totalCosto = 0;

            Object.entries(porOperacion).forEach(([key, op]) => {
                const porcentaje = mesActual.tokens > 0
                    ? (op.tokens / mesActual.tokens * 100)
                    : 0;

                totalOps += op.operaciones;
                totalTokens += op.tokens;
                totalCosto += op.costo_usd;

                html += `
                    <tr>
                        <td>
                            <span class="badge ${getBadgeClass(key)}">${key}</span>
                        </td>
                        <td>${formatNumber(op.operaciones)}</td>
                        <td>${formatNumber(op.tokens)}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="progress-bar" style="width: 100px;">
                                    <div class="progress-fill blue" style="width: ${porcentaje}%"></div>
                                </div>
                                <span>${porcentaje.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td class="money">${formatUSD(op.costo_usd)}</td>
                        <td>${formatCOP(op.costo_usd)}</td>
                    </tr>
                `;
            });

            // Fila de totales
            html += `
                <tr style="background: rgba(255,255,255,0.05); font-weight: bold;">
                    <td>TOTAL</td>
                    <td>${formatNumber(totalOps)}</td>
                    <td>${formatNumber(totalTokens)}</td>
                    <td>100%</td>
                    <td class="money">${formatUSD(totalCosto)}</td>
                    <td>${formatCOP(totalCosto)}</td>
                </tr>
            `;

            tbody.innerHTML = html;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();

            // Auto-refresh cada 5 minutos
            setInterval(cargarDatos, 5 * 60 * 1000);
        });
    </script>
</body>

</html>
