<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LecFac - Uso de API</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 span {
            font-size: 32px;
        }

        /* Filtros */
        .filtros {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filtros select,
        .filtros input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .filtros select option {
            background: #1a1a2e;
        }

        .btn-refresh {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Cards de resumen */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .card-sublabel {
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            margin-top: 5px;
        }

        .card.highlight {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-color: rgba(102, 126, 234, 0.5);
        }

        /* Secciones */
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Gr치fica */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Tablas */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.green {
            background: linear-gradient(90deg, #00b894, #00cec9);
        }

        .progress-fill.yellow {
            background: linear-gradient(90deg, #fdcb6e, #e17055);
        }

        .progress-fill.red {
            background: linear-gradient(90deg, #e17055, #d63031);
        }

        /* Badge */
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.free {
            background: rgba(0, 184, 148, 0.2);
            color: #00b894;
        }

        .badge.premium {
            background: rgba(253, 203, 110, 0.2);
            color: #fdcb6e;
        }

        .badge.enterprise {
            background: rgba(108, 92, 231, 0.2);
            color: #a29bfe;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Grid 2 columnas */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .filtros {
                width: 100%;
                justify-content: center;
            }

            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #00b894;
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #d63031;
        }

        /* Valor monetario */
        .money {
            color: #00b894;
            font-weight: 600;
        }

        .money.negative {
            color: #e17055;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><span>游늵</span> Uso de API - LecFac</h1>
            <div class="filtros">
                <select id="selectDias">
                    <option value="7">칔ltimos 7 d칤as</option>
                    <option value="30" selected>칔ltimos 30 d칤as</option>
                    <option value="60">칔ltimos 60 d칤as</option>
                    <option value="90">칔ltimos 90 d칤as</option>
                </select>
                <button class="btn-refresh" onclick="cargarDatos()">
                    游댃 Actualizar
                </button>
            </div>
        </div>

        <!-- Cards de resumen -->
        <div class="cards-grid" id="cardsResumen">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Gr치fica de uso diario -->
        <div class="section">
            <div class="section-header">
                <h2>游늳 Consumo Diario</h2>
            </div>
            <div class="chart-container">
                <canvas id="chartUsoDiario"></canvas>
            </div>
        </div>

        <!-- Grid 2 columnas -->
        <div class="grid-2">
            <!-- Uso por Usuario -->
            <div class="section">
                <div class="section-header">
                    <h2>游논 Uso por Usuario</h2>
                </div>
                <div class="table-container" id="tablaUsuarios">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Uso por Endpoint -->
            <div class="section">
                <div class="section-header">
                    <h2>游댕 Uso por Endpoint</h2>
                </div>
                <div class="table-container" id="tablaEndpoints">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalle de llamadas recientes -->
        <div class="section">
            <div class="section-header">
                <h2>游늶 Llamadas Recientes</h2>
                <select id="selectUserFilter" onchange="cargarDetalle()">
                    <option value="">Todos los usuarios</option>
                </select>
            </div>
            <div class="table-container" id="tablaDetalle">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuraci칩n
        const API_BASE = window.location.origin;
        let chartUsoDiario = null;

        // Mostrar toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '') + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Formatear n칰meros
        function formatNumber(num) {
            return new Intl.NumberFormat('es-CO').format(num);
        }

        function formatMoney(usd) {
            const cop = usd * 4200;
            return `$${usd.toFixed(4)} USD (~$${formatNumber(Math.round(cop))} COP)`;
        }

        // Obtener color del progress bar
        function getProgressColor(percentage) {
            if (percentage < 60) return 'green';
            if (percentage < 85) return 'yellow';
            return 'red';
        }

        // Cargar datos principales
        async function cargarDatos() {
            const dias = document.getElementById('selectDias').value;

            try {
                const response = await fetch(`${API_BASE}/api/admin/uso-api/resumen?dias=${dias}`);
                const data = await response.json();

                if (data.success) {
                    renderCards(data.resumen);
                    renderChartDiario(data.uso_por_dia);
                    renderTablaUsuarios(data.uso_por_usuario);
                    renderTablaEndpoints(data.uso_por_endpoint);
                    actualizarSelectUsuarios(data.uso_por_usuario);
                    cargarDetalle();
                    showToast('Datos actualizados correctamente');
                } else {
                    showToast('Error al cargar datos', true);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexi칩n', true);
            }
        }

        // Renderizar cards de resumen
        function renderCards(resumen) {
            const container = document.getElementById('cardsResumen');
            container.innerHTML = `
                <div class="card">
                    <div class="card-icon">游늯</div>
                    <div class="card-value">${formatNumber(resumen.facturas_procesadas)}</div>
                    <div class="card-label">Facturas Procesadas</div>
                </div>
                <div class="card">
                    <div class="card-icon">游댝</div>
                    <div class="card-value">${formatNumber(resumen.total_tokens)}</div>
                    <div class="card-label">Tokens Totales</div>
                    <div class="card-sublabel">In: ${formatNumber(resumen.total_tokens_input)} | Out: ${formatNumber(resumen.total_tokens_output)}</div>
                </div>
                <div class="card">
                    <div class="card-icon">游</div>
                    <div class="card-value">${formatNumber(resumen.total_llamadas)}</div>
                    <div class="card-label">Llamadas API</div>
                </div>
                <div class="card">
                    <div class="card-icon">游논</div>
                    <div class="card-value">${resumen.usuarios_activos}</div>
                    <div class="card-label">Usuarios Activos</div>
                </div>
                <div class="card highlight">
                    <div class="card-icon">游눯</div>
                    <div class="card-value">$${resumen.costo_total_usd.toFixed(2)}</div>
                    <div class="card-label">Costo Total USD</div>
                    <div class="card-sublabel">~$${formatNumber(Math.round(resumen.costo_total_cop))} COP</div>
                </div>
                <div class="card">
                    <div class="card-icon">游늵</div>
                    <div class="card-value">$${resumen.facturas_procesadas > 0 ? (resumen.costo_total_usd / resumen.facturas_procesadas).toFixed(4) : '0'}</div>
                    <div class="card-label">Costo / Factura</div>
                    <div class="card-sublabel">~$${resumen.facturas_procesadas > 0 ? formatNumber(Math.round((resumen.costo_total_usd / resumen.facturas_procesadas) * 4200)) : '0'} COP</div>
                </div>
            `;
        }

        // Renderizar gr치fica de uso diario
        function renderChartDiario(usoPorDia) {
            const ctx = document.getElementById('chartUsoDiario').getContext('2d');

            // Ordenar por fecha ascendente
            const datosOrdenados = [...usoPorDia].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            const labels = datosOrdenados.map(d => {
                const fecha = new Date(d.fecha);
                return fecha.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
            });

            const tokensData = datosOrdenados.map(d => d.tokens);
            const facturasData = datosOrdenados.map(d => d.facturas);
            const costoData = datosOrdenados.map(d => d.costo_usd);

            if (chartUsoDiario) {
                chartUsoDiario.destroy();
            }

            chartUsoDiario = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Tokens',
                            data: tokensData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Facturas',
                            data: facturasData,
                            borderColor: '#00b894',
                            backgroundColor: 'rgba(0, 184, 148, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255,255,255,0.8)' }
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function (context) {
                                    const index = context[0].dataIndex;
                                    return `Costo: $${costoData[index].toFixed(4)} USD`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.6)' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Tokens',
                                color: 'rgba(255,255,255,0.6)'
                            },
                            ticks: { color: 'rgba(255,255,255,0.6)' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Facturas',
                                color: 'rgba(255,255,255,0.6)'
                            },
                            ticks: { color: 'rgba(255,255,255,0.6)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Renderizar tabla de usuarios
        function renderTablaUsuarios(usuarios) {
            const container = document.getElementById('tablaUsuarios');

            if (usuarios.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:rgba(255,255,255,0.5);">No hay datos de usuarios</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Plan</th>
                            <th>Tokens</th>
                            <th>Facturas</th>
                            <th>Costo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            usuarios.forEach(u => {
                const badgeClass = u.plan || 'free';
                html += `
                    <tr>
                        <td><strong>#${u.user_id}</strong></td>
                        <td><span class="badge ${badgeClass}">${u.plan || 'free'}</span></td>
                        <td>
                            <div>${formatNumber(u.tokens_usados)} / ${formatNumber(u.limite_tokens)}</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${getProgressColor(u.porcentaje_tokens)}" style="width: ${Math.min(u.porcentaje_tokens, 100)}%"></div>
                            </div>
                            <small style="color:rgba(255,255,255,0.5)">${u.porcentaje_tokens}%</small>
                        </td>
                        <td>
                            <div>${u.facturas_procesadas} / ${u.limite_facturas}</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${getProgressColor(u.porcentaje_facturas)}" style="width: ${Math.min(u.porcentaje_facturas, 100)}%"></div>
                            </div>
                            <small style="color:rgba(255,255,255,0.5)">${u.porcentaje_facturas}%</small>
                        </td>
                        <td class="money">$${u.costo_periodo_usd.toFixed(4)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Renderizar tabla de endpoints
        function renderTablaEndpoints(endpoints) {
            const container = document.getElementById('tablaEndpoints');

            if (endpoints.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:rgba(255,255,255,0.5);">No hay datos de endpoints</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Llamadas</th>
                            <th>Tokens</th>
                            <th>Costo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            endpoints.forEach(e => {
                html += `
                    <tr>
                        <td><code style="background:rgba(255,255,255,0.1); padding:3px 8px; border-radius:4px;">${e.endpoint}</code></td>
                        <td>${formatNumber(e.llamadas)}</td>
                        <td>${formatNumber(e.tokens)}</td>
                        <td class="money">$${e.costo_usd.toFixed(4)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Actualizar select de usuarios
        function actualizarSelectUsuarios(usuarios) {
            const select = document.getElementById('selectUserFilter');
            const currentValue = select.value;

            select.innerHTML = '<option value="">Todos los usuarios</option>';
            usuarios.forEach(u => {
                select.innerHTML += `<option value="${u.user_id}">Usuario #${u.user_id}</option>`;
            });

            select.value = currentValue;
        }

        // Cargar detalle de llamadas
        async function cargarDetalle() {
            const userId = document.getElementById('selectUserFilter').value;
            const container = document.getElementById('tablaDetalle');

            let url = `${API_BASE}/api/admin/uso-api/detalle?limit=50`;
            if (userId) url += `&user_id=${userId}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderTablaDetalle(data.registros);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Renderizar tabla de detalle
        function renderTablaDetalle(registros) {
            const container = document.getElementById('tablaDetalle');

            if (registros.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:rgba(255,255,255,0.5);">No hay registros</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Usuario</th>
                            <th>Factura</th>
                            <th>Endpoint</th>
                            <th>Modelo</th>
                            <th>Tokens</th>
                            <th>Costo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            registros.forEach(r => {
                const fecha = new Date(r.fecha);
                const fechaStr = fecha.toLocaleDateString('es-CO', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                html += `
                    <tr>
                        <td>${fechaStr}</td>
                        <td>#${r.user_id}</td>
                        <td>${r.factura_id ? '#' + r.factura_id : '-'}</td>
                        <td><code style="font-size:11px;">${r.endpoint || '-'}</code></td>
                        <td><small>${r.modelo || '-'}</small></td>
                        <td>
                            <span title="In: ${r.tokens_input} | Out: ${r.tokens_output}">
                                ${formatNumber(r.tokens_total)}
                            </span>
                        </td>
                        <td class="money">$${r.costo_usd.toFixed(4)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
        });

        // Actualizar cuando cambie el per칤odo
        document.getElementById('selectDias').addEventListener('change', cargarDatos);
    </script>
</body>

</html>
