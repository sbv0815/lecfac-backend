<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidaci√≥n de Productos - LecFac</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1em;
            margin-top: 5px;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-back:hover {
            background: white;
            color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .search-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .search-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .search-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: white;
        }

        .btn-editar-producto {
            background: #ff9800;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-editar-producto:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .stats-bar {
            background: #e7f3ff;
            border-left: 4px solid #1a73e8;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1a73e8;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .duplicados-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .grupo-duplicado {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .grupo-duplicado:hover {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        }

        .grupo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .grupo-titulo {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .grupo-similitud {
            background: #fff3cd;
            color: #856404;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        /* üÜï ESTILOS PARA CHECKBOXES */
        .producto-item {
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s;
            background: white;
        }

        .producto-checkbox {
            position: relative;
        }

        .producto-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .producto-checkbox label {
            display: block;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
        }

        .producto-checkbox input[type="checkbox"]:checked+label {
            background: linear-gradient(to right, #e3f2fd 0%, #e8eaf6 100%);
            border-left: 4px solid #2196F3;
        }

        .producto-checkbox label:hover {
            background: #f5f5f5;
        }

        .producto-item:has(input:checked) {
            border-color: #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .producto-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .producto-nombre {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .producto-detalles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            white-space: nowrap;
        }

        .badge-id {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-ean {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .badge-no-ean {
            background: #ffecb3;
            color: #f57c00;
        }

        .badge-lugar {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-precio {
            background: #fff3e0;
            color: #e65100;
            font-weight: 600;
        }

        .badge-success {
            background: #4caf50;
            color: white;
        }

        .badge-reportes {
            background: #e0e0e0;
            color: #616161;
        }

        .grupo-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .productos-seleccionados {
            color: #666;
            font-size: 14px;
            background: #f5f5f5;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }

        .btn-consolidar {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-consolidar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-consolidar:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        /* MODAL DE CONFIRMACI√ìN */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-section {
            margin: 20px 0;
        }

        .modal-section h3 {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .producto-preview {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .producto-preview strong {
            color: #333;
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
        }

        .producto-preview div {
            color: #666;
            font-size: 0.9em;
        }

        .producto-preview.maestro {
            background: linear-gradient(to right, #e8f5e9, #c8e6c9);
            border-left: 4px solid #4CAF50;
        }

        .producto-preview.duplicado {
            background: linear-gradient(to right, #fff3e0, #ffe0b2);
            border-left: 4px solid #FF9800;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancelar {
            background: #f44336;
            color: white;
        }

        .btn-cancelar:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-confirmar {
            background: #4CAF50;
            color: white;
        }

        .btn-confirmar:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* RESTO DE ESTILOS ORIGINALES (alertas, modales, etc.) */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        #modal-confirmacion {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        #modal-confirmacion.active {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* Modal de edici√≥n de productos */
        #modalEdicionProducto {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        #modalEdicionProducto.active {
            display: flex;
        }

        .modal-edicion-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .producto-actual-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .establecimiento-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e3f2fd;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 4px;
            font-size: 0.9em;
        }

        .establecimiento-precio {
            background: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            color: #1976d2;
        }

        .sugerencia-api {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4caf50;
        }

        .sugerencia-api h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .sugerencia-imagen {
            max-width: 150px;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üîó Consolidaci√≥n de Productos</h1>
                <p>Unifica productos duplicados en el cat√°logo global</p>
            </div>
            <a href="/admin" class="btn-back">‚Üê Volver al Admin</a>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Alertas -->
            <div id="alert-container"></div>

            <!-- B√∫squeda -->
            <div class="search-section">
                <h2>üîç Buscar Duplicados</h2>
                <div class="search-controls">
                    <input type="text" id="search-ean" class="search-input" placeholder="Buscar por c√≥digo EAN...">
                    <input type="text" id="search-nombre" class="search-input" placeholder="Buscar por nombre...">
                    <button class="btn btn-primary" onclick="buscarDuplicados()">üîç Buscar</button>
                    <button class="btn btn-warning" onclick="cargarTodos()">üìã Cargar Todos</button>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="total-grupos">0</div>
                    <div class="stat-label">Grupos detectados</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-productos">0</div>
                    <div class="stat-label">Productos afectados</div>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Buscando duplicados...</p>
            </div>

            <!-- Contenedor de resultados -->
            <div id="duplicados-container" class="duplicados-container"></div>

            <!-- Empty state -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üîç</div>
                <h3>No se encontraron duplicados</h3>
                <p>Intenta con otros criterios de b√∫squeda</p>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>¬øConfirmar consolidaci√≥n?</h2>
            <div id="modal-body"></div>
            <div class="modal-actions">
                <button class="btn-cancelar" onclick="cerrarModal()">‚ùå Cancelar</button>
                <button class="btn-confirmar" onclick="confirmarConsolidacion()">‚úÖ Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de edici√≥n de producto -->
    <div id="modalEdicionProducto" class="modal-overlay">
        <div class="modal-edicion-content">
            <h2>‚úèÔ∏è Editar Producto</h2>

            <div class="producto-actual-info">
                <h3>Informaci√≥n actual</h3>
                <p><strong>Nombre:</strong> <span id="edit_nombre_actual"></span></p>
                <p><strong>EAN:</strong> <span id="edit_ean_actual"></span></p>
                <p><strong>Marca:</strong> <span id="edit_marca_actual"></span></p>
                <p><strong>Precio:</strong> <span id="edit_precio_actual"></span></p>
                <p><strong>Reportes:</strong> <span id="edit_reportes"></span></p>
                <div id="edit_establecimientos_lista"></div>
            </div>

            <div class="form-group">
                <label>Nombre completo</label>
                <input type="text" id="edit_nombre_completo" placeholder="Nombre completo del producto">
            </div>

            <div class="form-group">
                <label>C√≥digo EAN</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="edit_codigo_ean" placeholder="C√≥digo EAN">
                    <button class="btn btn-primary" onclick="consultarAPI()">üåê Consultar API</button>
                </div>
            </div>

            <div id="seccion_sugerencia_api" class="sugerencia-api" style="display: none;">
                <h4>üí° Sugerencia de OpenFoodFacts</h4>
                <p><strong>Nombre:</strong> <span id="sugerencia_nombre"></span></p>
                <p><strong>Marca:</strong> <span id="sugerencia_marca"></span></p>
                <p><strong>Categor√≠as:</strong> <span id="sugerencia_categorias"></span></p>
                <img id="sugerencia_imagen" class="sugerencia-imagen" style="display: none;">
                <button class="btn btn-success" onclick="usarSugerenciaAPI()" style="margin-top: 10px;">‚úÖ Usar esta
                    informaci√≥n</button>
            </div>

            <div class="form-group">
                <label>Marca</label>
                <input type="text" id="edit_marca" placeholder="Marca del producto">
            </div>

            <div class="form-group">
                <label>Categor√≠a</label>
                <select id="edit_categoria">
                    <option value="">Seleccionar categor√≠a</option>
                    <option value="lacteos">L√°cteos</option>
                    <option value="carnes">Carnes</option>
                    <option value="frutas">Frutas y Verduras</option>
                    <option value="panaderia">Panader√≠a</option>
                    <option value="bebidas">Bebidas</option>
                    <option value="aseo">Aseo</option>
                    <option value="otro">Otro</option>
                </select>
            </div>

            <div class="form-group">
                <label>Raz√≥n de la correcci√≥n</label>
                <textarea id="edit_razon" rows="3" placeholder="Explica por qu√© corriges este producto..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-cancelar" onclick="cerrarModalEdicion()">‚ùå Cancelar</button>
                <button class="btn-confirmar" onclick="guardarCorreccion()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let todosLosDuplicados = [];
        let consolidacionPendiente = null;
        let productoActualEdicion = null;
        let sugerenciaAPIActual = null;

        // ==========================================
        // üÜï CARGAR DUPLICADOS AL INICIAR
        // ==========================================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ Consolidaci√≥n de Productos cargado');
            cargarTodos();
        });

        // ==========================================
        // üÜï FUNCIONES DE B√öSQUEDA
        // ==========================================
        async function cargarTodos() {
            await buscarDuplicados();
        }

        async function buscarDuplicados() {
            const ean = document.getElementById('search-ean').value.trim();
            const nombre = document.getElementById('search-nombre').value.trim();

            console.log('üîç Buscando duplicados...', { ean, nombre });

            document.getElementById('loading').style.display = 'block';
            document.getElementById('duplicados-container').style.display = 'none';
            document.getElementById('empty-state').style.display = 'none';

            try {
                let url = `${API_URL}/admin/productos/duplicados-sospechosos?`;
                if (ean) url += `ean=${encodeURIComponent(ean)}&`;
                if (nombre) url += `nombre=${encodeURIComponent(nombre)}&`;

                const response = await fetch(url);
                const data = await response.json();

                console.log('‚úÖ Duplicados obtenidos:', data);

                if (data.success && data.grupos && data.grupos.length > 0) {
                    todosLosDuplicados = data.grupos;
                    renderizarDuplicados(data.grupos);

                    // Actualizar stats
                    document.getElementById('total-grupos').textContent = data.grupos.length;
                    const totalProductos = data.grupos.reduce((sum, g) => sum + g.productos.length, 0);
                    document.getElementById('total-productos').textContent = totalProductos;
                } else {
                    document.getElementById('empty-state').style.display = 'block';
                    document.getElementById('total-grupos').textContent = '0';
                    document.getElementById('total-productos').textContent = '0';
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarAlerta('Error al cargar duplicados: ' + error.message, 'danger');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ==========================================
        // üÜï RENDERIZAR GRUPOS CON CHECKBOXES
        // ==========================================
        function renderizarDuplicados(grupos) {
            const container = document.getElementById('duplicados-container');
            container.innerHTML = '';
            container.style.display = 'flex';

            grupos.forEach((grupo, grupoIndex) => {
                const grupoDiv = document.createElement('div');
                grupoDiv.className = 'grupo-duplicado';
                grupoDiv.id = `grupo-${grupoIndex}`;

                // Header
                const header = document.createElement('div');
                header.className = 'grupo-header';
                header.innerHTML = `
                    <div class="grupo-titulo">${grupo.nombre_grupo}</div>
                    <div class="grupo-similitud">${grupo.similitud}% similitud</div>
                `;
                grupoDiv.appendChild(header);

                // Productos con checkboxes
                grupo.productos.forEach((producto, index) => {
                    const productoDiv = document.createElement('div');
                    productoDiv.className = 'producto-item';
                    productoDiv.innerHTML = `
                        <div class="producto-checkbox">
                            <input
                                type="checkbox"
                                id="prod-${grupoIndex}-${producto.id}"
                                data-grupo="${grupoIndex}"
                                data-producto-id="${producto.id}"
                                ${index === 0 ? 'checked' : ''}
                                onchange="validarSeleccion(${grupoIndex})"
                            >
                            <label for="prod-${grupoIndex}-${producto.id}">
                                <div class="producto-info">
                                    <div class="producto-nombre">${producto.nombre}</div>
                                    <div class="producto-detalles">
                                        <span class="badge badge-id">ID: #${producto.id}</span>
                                        ${producto.codigo_ean ?
                            `<span class="badge badge-ean">C√≥digo: ${producto.codigo_ean}</span>` :
                            '<span class="badge badge-no-ean">Sin EAN</span>'
                        }
                                        <span class="badge badge-lugar">Lugar: ${producto.establecimiento || 'Varios'}</span>
                                        <span class="badge badge-precio">Precio: $${formatearNumero(producto.precio_promedio || 0)}</span>
                                        ${producto.codigo_ean && producto.codigo_ean.length >= 8 ?
                            '<span class="badge badge-success">‚úÖ EAN</span>' :
                            ''
                        }
                                        <span class="badge badge-reportes">${producto.veces_reportado}x reportado</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <button class="btn-editar-producto" onclick="abrirModalEdicion(${producto.id})">
                            ‚úèÔ∏è Editar
                        </button>
                    `;
                    grupoDiv.appendChild(productoDiv);
                });

                // Acciones
                const actions = document.createElement('div');
                actions.className = 'grupo-actions';
                actions.innerHTML = `
                    <button class="btn-consolidar" onclick="prepararConsolidacion(${grupoIndex})">
                        üîó Consolidar seleccionados
                    </button>
                    <span class="productos-seleccionados" id="count-${grupoIndex}">
                        1 de ${grupo.productos.length} seleccionado(s)
                    </span>
                `;
                grupoDiv.appendChild(actions);

                container.appendChild(grupoDiv);
            });

            console.log('‚úÖ Todos los duplicados:', todosLosDuplicados);
        }

        // ==========================================
        // üÜï VALIDAR SELECCI√ìN (al menos 1 checked)
        // ==========================================
        function validarSeleccion(grupoIndex) {
            const checkboxes = document.querySelectorAll(`input[data-grupo="${grupoIndex}"]`);
            const seleccionados = Array.from(checkboxes).filter(cb => cb.checked);

            // Prevenir deseleccionar todos
            if (seleccionados.length === 0) {
                event.target.checked = true;
                alert('‚ö†Ô∏è Debes mantener al menos un producto seleccionado');
                return;
            }

            // Actualizar contador
            const countSpan = document.getElementById(`count-${grupoIndex}`);
            if (countSpan) {
                countSpan.textContent = `${seleccionados.length} de ${checkboxes.length} seleccionado(s)`;
            }
        }

        // ==========================================
        // üÜï PREPARAR CONSOLIDACI√ìN (solo seleccionados)
        // ==========================================
        function prepararConsolidacion(grupoIndex) {
            console.log('üîÑ Preparando consolidaci√≥n del grupo:', grupoIndex);

            const grupo = todosLosDuplicados[grupoIndex];
            if (!grupo) {
                alert('‚ùå Grupo no encontrado');
                return;
            }

            // Obtener productos seleccionados
            const checkboxes = document.querySelectorAll(`input[data-grupo="${grupoIndex}"]`);
            const productosSeleccionados = grupo.productos.filter(producto => {
                const checkbox = document.querySelector(`input[data-producto-id="${producto.id}"]`);
                return checkbox && checkbox.checked;
            });

            console.log(`   üì¶ ${productosSeleccionados.length} de ${grupo.productos.length} seleccionados`);

            if (productosSeleccionados.length < 2) {
                alert('‚ö†Ô∏è Necesitas seleccionar al menos 2 productos para consolidar');
                return;
            }

            // Identificar maestro (preferir EAN)
            const productoMaestro = productosSeleccionados.find(p => p.codigo_ean && p.codigo_ean.length >= 8)
                || productosSeleccionados[0];

            const productosDuplicados = productosSeleccionados.filter(p => p.id !== productoMaestro.id);

            // Guardar para confirmar
            consolidacionPendiente = {
                maestro: productoMaestro,
                duplicados: productosDuplicados
            };

            console.log('‚úÖ Consolidaci√≥n pendiente preparada:', consolidacionPendiente);

            // Mostrar modal
            mostrarModalConfirmacion(productoMaestro, productosDuplicados);
        }

        // ==========================================
        // üÜï MODAL DE CONFIRMACI√ìN
        // ==========================================
        function mostrarModalConfirmacion(maestro, duplicados) {
            const modalBody = document.getElementById('modal-body');

            modalBody.innerHTML = `
                <div class="modal-section">
                    <h3>‚úÖ Producto maestro:</h3>
                    <div class="producto-preview maestro">
                        <strong>${maestro.nombre}</strong>
                        <div>ID: #${maestro.id} | ${maestro.codigo_ean || 'Sin EAN'}</div>
                        <div>Establecimiento: ${maestro.establecimiento || 'Varios'}</div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>üîó Se consolidar√°n estos duplicados:</h3>
                    ${duplicados.map(d => `
                        <div class="producto-preview duplicado">
                            <strong>${d.nombre}</strong>
                            <div>ID: #${d.id} | ${d.codigo_ean || 'Sin EAN'}</div>
                            <div>Establecimiento: ${d.establecimiento || 'Varios'}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        // ==========================================
        // üÜï CONFIRMAR Y ENVIAR AL BACKEND
        // ==========================================
        async function confirmarConsolidacion() {
            if (!consolidacionPendiente) {
                alert('‚ùå No hay consolidaci√≥n pendiente');
                return;
            }

            const { maestro, duplicados } = consolidacionPendiente;

            console.log('üîÑ Iniciating consolidaci√≥n:', {
                maestro: maestro.id,
                duplicados: duplicados.map(d => d.id)
            });

            const payload = {
                producto_maestro_id: maestro.id,
                productos_duplicados_ids: duplicados.map(d => d.id)
            };

            console.log('üì§ Enviando payload:', payload);

            try {
                const response = await fetch(`${API_URL}/admin/productos/consolidar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('üì• Response status:', response.status);

                const data = await response.json();

                if (response.ok) {
                    console.log('‚úÖ Consolidaci√≥n exitosa:', data);
                    mostrarAlerta(
                        `‚úÖ ${data.message}\n\n` +
                        `Producto can√≥nico ID: ${data.producto_canonico_id}\n` +
                        `Variantes creadas: ${data.variantes_creadas}`,
                        'success'
                    );

                    cerrarModal();

                    // Recargar duplicados
                    setTimeout(() => {
                        buscarDuplicados();
                    }, 1500);
                } else {
                    console.error('‚ùå Error response:', data);
                    alert('‚ùå Error en consolidaci√≥n:\n\n' + data.detail);
                }
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        // ==========================================
        // EDICI√ìN DE PRODUCTOS
        // ==========================================
        async function abrirModalEdicion(productoId) {
            productoActualEdicion = { id: productoId };

            try {
                const response = await fetch(`${API_URL}/admin/productos/${productoId}/detalle`);
                const data = await response.json();

                if (!data.success) {
                    alert('Error al obtener detalles del producto');
                    return;
                }

                // Mostrar modal
                document.getElementById('modalEdicionProducto').classList.add('active');

                // Llenar informaci√≥n actual
                document.getElementById('edit_nombre_actual').textContent = data.producto.nombre || 'N/A';
                document.getElementById('edit_ean_actual').textContent = data.producto.codigo_ean || 'Sin EAN';
                document.getElementById('edit_marca_actual').textContent = data.producto.marca || 'N/A';
                document.getElementById('edit_precio_actual').textContent = `$${formatearNumero(data.producto.precio_promedio)}`;
                document.getElementById('edit_reportes').textContent = `${data.producto.total_reportes}x`;

                // Mostrar establecimientos
                const establecimientosDiv = document.getElementById('edit_establecimientos_lista');
                establecimientosDiv.innerHTML = '';

                for (const [est, precios] of Object.entries(data.producto.precios_por_establecimiento)) {
                    const tag = document.createElement('div');
                    tag.className = 'establecimiento-tag';
                    tag.innerHTML = `
                        <span>üè™ ${est}</span>
                        <span class="establecimiento-precio">$${formatearNumero(precios[0].precio)}</span>
                    `;
                    establecimientosDiv.appendChild(tag);
                }

                // Prellenar formulario
                document.getElementById('edit_nombre_completo').value = data.producto.nombre || '';
                document.getElementById('edit_codigo_ean').value = data.producto.codigo_ean || '';
                document.getElementById('edit_marca').value = data.producto.marca || '';
                document.getElementById('edit_categoria').value = data.producto.categoria || '';
                document.getElementById('edit_razon').value = '';

                // Ocultar sugerencia API
                document.getElementById('seccion_sugerencia_api').style.display = 'none';

                // Si tiene EAN, consultar API
                if (data.producto.codigo_ean) {
                    // Comentado para no auto-consultar
                    // consultarAPI();
                }

            } catch (error) {
                console.error('Error abriendo modal:', error);
                alert('Error al abrir editor');
                cerrarModalEdicion();
            }
        }

        function cerrarModalEdicion() {
            document.getElementById('modalEdicionProducto').classList.remove('active');
            productoActualEdicion = null;
            sugerenciaAPIActual = null;
        }

        async function consultarAPI() {
            const ean = document.getElementById('edit_codigo_ean').value.trim();

            if (!ean) {
                alert('Ingresa un c√≥digo EAN primero');
                return;
            }

            try {
                console.log(`üåê Consultando API para EAN: ${ean}`);

                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '‚è≥ Consultando...';

                const response = await fetch(`${API_URL}/admin/productos/consultar-api?codigo_ean=${ean}`, {
                    method: 'POST'
                });

                const data = await response.json();

                btn.disabled = false;
                btn.textContent = 'üåê Consultar API';

                if (data.success && data.sugerencia) {
                    sugerenciaAPIActual = data.sugerencia;

                    document.getElementById('seccion_sugerencia_api').style.display = 'block';
                    document.getElementById('sugerencia_nombre').textContent = data.sugerencia.nombre_completo;
                    document.getElementById('sugerencia_marca').textContent = data.sugerencia.marca;
                    document.getElementById('sugerencia_categorias').textContent = data.sugerencia.categorias.join(', ') || 'N/A';

                    if (data.sugerencia.imagen_url) {
                        document.getElementById('sugerencia_imagen').src = data.sugerencia.imagen_url;
                        document.getElementById('sugerencia_imagen').style.display = 'block';
                    }

                    console.log('‚úÖ Sugerencia obtenida:', data.sugerencia);
                } else {
                    alert('‚ùå Producto no encontrado en OpenFoodFacts');
                    document.getElementById('seccion_sugerencia_api').style.display = 'none';
                }

            } catch (error) {
                console.error('Error consultando API:', error);
                alert('Error al consultar API');

                const btn = event.target;
                btn.disabled = false;
                btn.textContent = 'üåê Consultar API';
            }
        }

        function usarSugerenciaAPI() {
            if (!sugerenciaAPIActual) return;

            document.getElementById('edit_nombre_completo').value = sugerenciaAPIActual.nombre_completo;
            document.getElementById('edit_marca').value = sugerenciaAPIActual.marca;

            alert('‚úÖ Informaci√≥n de la API aplicada. Revisa y guarda.');
        }

        async function guardarCorreccion() {
            if (!productoActualEdicion) return;

            const nombre = document.getElementById('edit_nombre_completo').value.trim();
            const ean = document.getElementById('edit_codigo_ean').value.trim();
            const marca = document.getElementById('edit_marca').value.trim();
            const categoria = document.getElementById('edit_categoria').value;
            const razon = document.getElementById('edit_razon').value.trim();

            if (!nombre) {
                alert('El nombre es obligatorio');
                return;
            }

            try {
                console.log(`üíæ Guardando correcci√≥n para producto #${productoActualEdicion.id}`);

                const response = await fetch(`${API_URL}/admin/productos/${productoActualEdicion.id}/corregir`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre_completo: nombre,
                        codigo_ean: ean || null,
                        marca: marca || null,
                        categoria: categoria || null,
                        razon_correccion: razon
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Producto actualizado correctamente');
                    cerrarModalEdicion();
                    buscarDuplicados();
                } else {
                    alert(`‚ùå Error: ${data.message}`);
                }

            } catch (error) {
                console.error('Error guardando correcci√≥n:', error);
                alert('Error al guardar correcci√≥n');
            }
        }

        // ==========================================
        // FUNCIONES AUXILIARES
        // ==========================================
        function mostrarAlerta(mensaje, tipo) {
            const container = document.getElementById('alert-container');

            const iconos = {
                success: '‚úÖ',
                danger: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            container.innerHTML = `
                <div class="alert alert-${tipo}">
                    <span>${iconos[tipo]}</span>
                    <div>${mensaje}</div>
                </div>
            `;

            if (tipo !== 'danger') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        function formatearNumero(num) {
            if (!num || num === 0) return '0';
            const numero = Number(num);
            return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // ==========================================
        // EVENTOS
        // ==========================================
        document.getElementById('search-ean').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarDuplicados();
        });

        document.getElementById('search-nombre').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarDuplicados();
        });

        // Cerrar modales con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cerrarModal();
                cerrarModalEdicion();
            }
        });

        console.log('‚úÖ Sistema de consolidaci√≥n cargado con checkboxes');
    </script>
</body>

</html>
